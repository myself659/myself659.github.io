<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>TCP连接下载文件失败，也许该看看这篇文章 | 沉风网事</title><meta name=keywords content="Network"><meta name=description content="体验一下标题党，现在自媒体横行，容我也放肆一回（多了我也不行，替自己码字能力捉急）！ 另起一行，到此为止，进入正题 缘起 最近通过uc浏览器下载a"><meta name=author content="沉风"><link rel=canonical href=https://myself659.github.io/post/2017-02-16-tcp-slow-down/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.bf5f9f73cf17311d52cedbcda82c922e91b2f566d88a85ad9f5b5a08b586bd5f.css integrity="sha256-v1+fc88XMR1SztvNqCySLpGy9WbYioWtn1taCLWGvV8=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://myself659.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://myself659.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://myself659.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://myself659.github.io/apple-touch-icon.png><link rel=mask-icon href=https://myself659.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-144475213-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="TCP连接下载文件失败，也许该看看这篇文章"><meta property="og:description" content="体验一下标题党，现在自媒体横行，容我也放肆一回（多了我也不行，替自己码字能力捉急）！ 另起一行，到此为止，进入正题 缘起 最近通过uc浏览器下载a"><meta property="og:type" content="article"><meta property="og:url" content="https://myself659.github.io/post/2017-02-16-tcp-slow-down/"><meta property="og:image" content="https://myself659.github.io/"><meta property="article:section" content="post"><meta property="article:published_time" content="2017-02-16T11:58:06+02:00"><meta property="article:modified_time" content="2017-02-16T11:58:06+02:00"><meta property="og:site_name" content="沉风网事"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://myself659.github.io/"><meta name=twitter:title content="TCP连接下载文件失败，也许该看看这篇文章"><meta name=twitter:description content="体验一下标题党，现在自媒体横行，容我也放肆一回（多了我也不行，替自己码字能力捉急）！ 另起一行，到此为止，进入正题 缘起 最近通过uc浏览器下载a"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://myself659.github.io/post/"},{"@type":"ListItem","position":2,"name":"TCP连接下载文件失败，也许该看看这篇文章","item":"https://myself659.github.io/post/2017-02-16-tcp-slow-down/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TCP连接下载文件失败，也许该看看这篇文章","name":"TCP连接下载文件失败，也许该看看这篇文章","description":"体验一下标题党，现在自媒体横行，容我也放肆一回（多了我也不行，替自己码字能力捉急）！ 另起一行，到此为止，进入正题 缘起 最近通过uc浏览器下载a","keywords":["Network"],"articleBody":"体验一下标题党，现在自媒体横行，容我也放肆一回（多了我也不行，替自己码字能力捉急）！\n另起一行，到此为止，进入正题\n缘起 最近通过uc浏览器下载apk的时候，偶尔出现下载apk，下载了60%左右卡住，想到以前看到这篇文章：The curious case of slow downloads（PS：毕竟这个问题不是常出现，就算一次下载失败，反正可以重新下载，总能下载成功的）\n说明 由于本人英文水平有限，翻译水平更是不足，就不具体翻译上面的文章，仅作简单说明，更深的理解请阅读The curious case of slow downloads\n问题描述 Cloudflare是美国一家CDN厂商，他们的工程师发现下面的问题：\n一些下载速度很慢的连接被突然关闭，导致用户下载失败\n这些连接不是客户端主动关闭，而是服务端主动关闭的\n问题原因 原文有具体解决这个问题详细过程，还是值得一看，这里不作描述。\n在满足如下条件情况下会出现下载失败：\nsocket发送缓冲区可用空间低于缓冲区总大小的三分之一 用户下载速度不能达到在60秒内使该socket发送缓冲区可用空间超过缓冲区总大小的三分之一 nginx配置项send_timeout对应值为60秒 当满足上述条件，当60秒超时后，nginx会关闭该连接\n这里大家可能有一个问题，网速慢也会不断发送，怎么会超时出现关闭连接？\n这里有一个普遍的误解：认为send像recv那样，每发送成功一个都上报epoll事件（以linux为例）,而实际send上报epoll事件条件如下：\nsend buffer有可用发送空间 进入发送队列的数据一定要低于LOWAT的设置值（注意：linux 内核2.6版本没有这个限制，linux 内核4.5版本以上有此条件，其他版本情况未知） 发送缓存区的可用空间一定要超过大于发送空间的已使用的空间的二分之一 其中第三个条件对应内核代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 unsigned int tcp_poll(struct file *file, struct socket *sock, poll_table *wait) { unsigned int mask; struct sock *sk = sock-\u003esk; struct tcp_sock *tp = tcp_sk(sk); sock_poll_wait(file, sk-\u003esk_sleep, wait); if (sk-\u003esk_state == TCP_LISTEN) // 侦听状态，进入listen poll，即检查侦听socket的accpet队列是否为空 return inet_csk_listen_poll(sk); /* Socket is not locked. We are protected from async events * by poll logic and correct handling of state changes * made by other threads is impossible in any case. */ mask = 0; /* * POLLHUP is certainly not done right. But poll() doesn't * have a notion of HUP in just one direction, and for a * socket the read side is more interesting. * * Some poll() documentation says that POLLHUP is incompatible * with the POLLOUT/POLLWR flags, so somebody should check this * all. But careful, it tends to be safer to return too many * bits than too few, and you can easily break real applications * if you don't tell them that something has hung up! * * Check-me. * * Check number 1. POLLHUP is _UNMASKABLE_ event (see UNIX98 and * our fs/select.c). It means that after we received EOF, * poll always returns immediately, making impossible poll() on write() * in state CLOSE_WAIT. One solution is evident --- to set POLLHUP * if and only if shutdown has been made in both directions. * Actually, it is interesting to look how Solaris and DUX * solve this dilemma. I would prefer, if POLLHUP were maskable, * then we could set it on SND_SHUTDOWN. BTW examples given * in Stevens' books assume exactly this behaviour, it explains * why POLLHUP is incompatible with POLLOUT. --ANK * * NOTE. Check for TCP_CLOSE is added. The goal is to prevent * blocking on fresh not-connected or disconnected socket. --ANK */ /* socket 与tcp 状态转化 poll事件 */ if (sk-\u003esk_shutdown == SHUTDOWN_MASK || sk-\u003esk_state == TCP_CLOSE) mask |= POLLHUP; if (sk-\u003esk_shutdown \u0026 RCV_SHUTDOWN) mask |= POLLIN | POLLRDNORM | POLLRDHUP; /* Connected? */ if ((1 \u003c\u003c sk-\u003esk_state) \u0026 ~(TCPF_SYN_SENT | TCPF_SYN_RECV)) { int target = sock_rcvlowat(sk, 0, INT_MAX); if (tp-\u003eurg_seq == tp-\u003ecopied_seq \u0026\u0026 !sock_flag(sk, SOCK_URGINLINE) \u0026\u0026 tp-\u003eurg_data) target--; /* Potential race condition. If read of tp below will * escape above sk-\u003esk_state, we can be illegally awaken * in SYN_* states. */ /* 未处理接收报文字节数超过了最小阈值，满足可读条件 */ if (tp-\u003ercv_nxt - tp-\u003ecopied_seq \u003e= target) mask |= POLLIN | POLLRDNORM; if (!(sk-\u003esk_shutdown \u0026 SEND_SHUTDOWN)) { /* sk-\u003esk_sndbuf - sk-\u003esk_wmem_queued \u003e= sk-\u003esk_wmem_queued\u003e\u003e1 (简单理解为最大值 0.5* sk-\u003esk_wmem_queued) 如果未发送报文超过了66%，那么不会继续上报POLLOUT事件 */ if (sk_stream_wspace(sk) \u003e= sk_stream_min_wspace(sk)) { mask |= POLLOUT | POLLWRNORM; } else { /* send SIGIO later */ /* 发送SIGIO */ set_bit(SOCK_ASYNC_NOSPACE, \u0026sk-\u003esk_socket-\u003eflags); set_bit(SOCK_NOSPACE, \u0026sk-\u003esk_socket-\u003eflags); /* Race breaker. If space is freed after * wspace test but before the flags are set, * IO signal will be lost. */ if (sk_stream_wspace(sk) \u003e= sk_stream_min_wspace(sk)) mask |= POLLOUT | POLLWRNORM; } } else mask |= POLLOUT | POLLWRNORM; if (tp-\u003eurg_data \u0026 TCP_URG_VALID) mask |= POLLPRI; } /* This barrier is coupled with smp_wmb() in tcp_reset() */ smp_rmb(); if (sk-\u003esk_err) mask |= POLLERR; return mask; } 解决方案 知道上面的原因对应可以选择方案如下：\n方案一：增加send_timeout时间，例如将时间调整为280秒，可以保证在5M发送缓冲区条件下，用户下载速度超过50Kbps不会出现超时导致连接被关闭\n方案二：通过设置/proc/sys/net/ipv4/tcp_wmem值减小socket发送缓冲区大小，发送缓冲区减小，那么在一定下载速率下在指定的时间需要完成下载的大小变小，就可以避免上述的问题出现的条件\n显而易见，这种两种方案都不能从根本上解决问题，只是降低问题出现的概率（这也是进步）\n方案三：改变超时处理，而不是直接关闭，可利用ioctl(TIOCOUTQ)来获取有多少数据仍停留在发送缓冲区，调整超时时间，具体实现可以参考The curious case of slow downloads中提到的方案：a Linux specific patch to NGINX\n相比较于方案一和方案二，方案三对网络速率变化与波动适应性强\n总结 The curious case of slow downloads值得一看（感谢cloudflare工程师没有放弃一些偶现的问题） nginx现有实现单一固化的处理导致不适应tcp传输的多变性 在复杂多变的网络环境下，保证传输高可靠性里面需要很多技术细节需要挖掘 网络是复杂的，主要由于以下原因： 网络协议复杂，例如tcp 网络本身不可靠 网络连接多样性 网络要求高：低延迟，少丢包，抖动小，高速率，自适应 参考 The curious case of slow downloads linux-2.26.32 ","wordCount":"2009","inLanguage":"zh","datePublished":"2017-02-16T11:58:06+02:00","dateModified":"2017-02-16T11:58:06+02:00","author":{"@type":"Person","name":"沉风"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://myself659.github.io/post/2017-02-16-tcp-slow-down/"},"publisher":{"@type":"Organization","name":"沉风网事","logo":{"@type":"ImageObject","url":"https://myself659.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://myself659.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://myself659.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://myself659.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://myself659.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://myself659.github.io/search/ title=Search><span>Search</span></a></li><li><a href=https://myself659.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://myself659.github.io/about/ title=About><span>About</span></a></li><li><a href=https://myself659.github.io/post/leetcode/ title=LeetCode><span>LeetCode</span></a></li><li><a href=https://myself659.github.io/post/read-post/ title=Reading><span>Reading</span></a></li><li><a href=https://myself659.github.io/post/share-post/ title=Share><span>Share</span></a></li><li><a href=https://myself659.github.io/post/slide-post/ title=Slide><span>Slide</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://myself659.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://myself659.github.io/post/>Posts</a></div><h1 class=post-title>TCP连接下载文件失败，也许该看看这篇文章</h1><div class=post-meta><span title='2017-02-16 11:58:06 +0200 +0200'>2017-02-16</span>&nbsp;·&nbsp;沉风</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e7%bc%98%e8%b5%b7 aria-label=缘起>缘起</a></li><li><a href=#%e8%af%b4%e6%98%8e aria-label=说明>说明</a></li><li><a href=#%e9%97%ae%e9%a2%98%e6%8f%8f%e8%bf%b0 aria-label=问题描述>问题描述</a></li><li><a href=#%e9%97%ae%e9%a2%98%e5%8e%9f%e5%9b%a0 aria-label=问题原因>问题原因</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 aria-label=解决方案>解决方案</a></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div><div class=post-content><p>体验一下标题党，现在自媒体横行，容我也放肆一回（多了我也不行，替自己码字能力捉急）！</p><p>另起一行，到此为止，进入正题</p><h3 id=缘起>缘起<a hidden class=anchor aria-hidden=true href=#缘起>#</a></h3><p>最近通过uc浏览器下载apk的时候，偶尔出现下载apk，下载了60%左右卡住，想到以前看到这篇文章：<a href=https://blog.cloudflare.com/the-curious-case-of-slow-downloads/>The curious case of slow downloads</a>（PS：毕竟这个问题不是常出现，就算一次下载失败，反正可以重新下载，总能下载成功的）</p><h3 id=说明>说明<a hidden class=anchor aria-hidden=true href=#说明>#</a></h3><p>由于本人英文水平有限，翻译水平更是不足，就不具体翻译上面的文章，仅作简单说明，更深的理解请阅读<a href=https://blog.cloudflare.com/the-curious-case-of-slow-downloads/>The curious case of slow downloads</a></p><h3 id=问题描述>问题描述<a hidden class=anchor aria-hidden=true href=#问题描述>#</a></h3><p>Cloudflare是美国一家CDN厂商，他们的工程师发现下面的问题：</p><blockquote><p>一些下载速度很慢的连接被突然关闭，导致用户下载失败</p></blockquote><blockquote><p>这些连接不是客户端主动关闭，而是服务端主动关闭的</p></blockquote><h3 id=问题原因>问题原因<a hidden class=anchor aria-hidden=true href=#问题原因>#</a></h3><p>原文有具体解决这个问题详细过程，还是值得一看，这里不作描述。</p><p>在满足如下条件情况下会出现下载失败：</p><ol><li>socket发送缓冲区可用空间低于缓冲区总大小的三分之一</li><li>用户下载速度不能达到在60秒内使该socket发送缓冲区可用空间超过缓冲区总大小的三分之一</li><li>nginx配置项send_timeout对应值为60秒</li></ol><p>当满足上述条件，当60秒超时后，nginx会关闭该连接</p><p>这里大家可能有一个问题，网速慢也会不断发送，怎么会超时出现关闭连接？</p><p>这里有一个普遍的误解：认为send像recv那样，每发送成功一个都上报epoll事件（以linux为例）,而实际send上报epoll事件条件如下：</p><ol><li>send buffer有可用发送空间</li><li>进入发送队列的数据一定要低于LOWAT的设置值（注意：linux 内核2.6版本没有这个限制，linux 内核4.5版本以上有此条件，其他版本情况未知）</li><li>发送缓存区的可用空间一定要超过大于发送空间的已使用的空间的二分之一</li></ol><p>其中第三个条件对应内核代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>  1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>  2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3>  3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4>  4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5>  5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6>  6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7>  7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8>  8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9>  9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10> 10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11> 11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12> 12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13> 13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14> 14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15> 15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16> 16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17> 17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18> 18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19> 19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20> 20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21> 21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22> 22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23> 23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24> 24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25> 25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26> 26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27> 27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28> 28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29> 29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30> 30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31> 31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32> 32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33> 33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34> 34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35> 35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36> 36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37> 37</a>
</span><span class=lnt id=hl-0-38><a class=lnlinks href=#hl-0-38> 38</a>
</span><span class=lnt id=hl-0-39><a class=lnlinks href=#hl-0-39> 39</a>
</span><span class=lnt id=hl-0-40><a class=lnlinks href=#hl-0-40> 40</a>
</span><span class=lnt id=hl-0-41><a class=lnlinks href=#hl-0-41> 41</a>
</span><span class=lnt id=hl-0-42><a class=lnlinks href=#hl-0-42> 42</a>
</span><span class=lnt id=hl-0-43><a class=lnlinks href=#hl-0-43> 43</a>
</span><span class=lnt id=hl-0-44><a class=lnlinks href=#hl-0-44> 44</a>
</span><span class=lnt id=hl-0-45><a class=lnlinks href=#hl-0-45> 45</a>
</span><span class=lnt id=hl-0-46><a class=lnlinks href=#hl-0-46> 46</a>
</span><span class=lnt id=hl-0-47><a class=lnlinks href=#hl-0-47> 47</a>
</span><span class=lnt id=hl-0-48><a class=lnlinks href=#hl-0-48> 48</a>
</span><span class=lnt id=hl-0-49><a class=lnlinks href=#hl-0-49> 49</a>
</span><span class=lnt id=hl-0-50><a class=lnlinks href=#hl-0-50> 50</a>
</span><span class=lnt id=hl-0-51><a class=lnlinks href=#hl-0-51> 51</a>
</span><span class=lnt id=hl-0-52><a class=lnlinks href=#hl-0-52> 52</a>
</span><span class=lnt id=hl-0-53><a class=lnlinks href=#hl-0-53> 53</a>
</span><span class=lnt id=hl-0-54><a class=lnlinks href=#hl-0-54> 54</a>
</span><span class=lnt id=hl-0-55><a class=lnlinks href=#hl-0-55> 55</a>
</span><span class=lnt id=hl-0-56><a class=lnlinks href=#hl-0-56> 56</a>
</span><span class=lnt id=hl-0-57><a class=lnlinks href=#hl-0-57> 57</a>
</span><span class=lnt id=hl-0-58><a class=lnlinks href=#hl-0-58> 58</a>
</span><span class=lnt id=hl-0-59><a class=lnlinks href=#hl-0-59> 59</a>
</span><span class=lnt id=hl-0-60><a class=lnlinks href=#hl-0-60> 60</a>
</span><span class=lnt id=hl-0-61><a class=lnlinks href=#hl-0-61> 61</a>
</span><span class=lnt id=hl-0-62><a class=lnlinks href=#hl-0-62> 62</a>
</span><span class=lnt id=hl-0-63><a class=lnlinks href=#hl-0-63> 63</a>
</span><span class=lnt id=hl-0-64><a class=lnlinks href=#hl-0-64> 64</a>
</span><span class=lnt id=hl-0-65><a class=lnlinks href=#hl-0-65> 65</a>
</span><span class=lnt id=hl-0-66><a class=lnlinks href=#hl-0-66> 66</a>
</span><span class=lnt id=hl-0-67><a class=lnlinks href=#hl-0-67> 67</a>
</span><span class=lnt id=hl-0-68><a class=lnlinks href=#hl-0-68> 68</a>
</span><span class=lnt id=hl-0-69><a class=lnlinks href=#hl-0-69> 69</a>
</span><span class=lnt id=hl-0-70><a class=lnlinks href=#hl-0-70> 70</a>
</span><span class=lnt id=hl-0-71><a class=lnlinks href=#hl-0-71> 71</a>
</span><span class=lnt id=hl-0-72><a class=lnlinks href=#hl-0-72> 72</a>
</span><span class=lnt id=hl-0-73><a class=lnlinks href=#hl-0-73> 73</a>
</span><span class=lnt id=hl-0-74><a class=lnlinks href=#hl-0-74> 74</a>
</span><span class=lnt id=hl-0-75><a class=lnlinks href=#hl-0-75> 75</a>
</span><span class=lnt id=hl-0-76><a class=lnlinks href=#hl-0-76> 76</a>
</span><span class=lnt id=hl-0-77><a class=lnlinks href=#hl-0-77> 77</a>
</span><span class=lnt id=hl-0-78><a class=lnlinks href=#hl-0-78> 78</a>
</span><span class=lnt id=hl-0-79><a class=lnlinks href=#hl-0-79> 79</a>
</span><span class=lnt id=hl-0-80><a class=lnlinks href=#hl-0-80> 80</a>
</span><span class=lnt id=hl-0-81><a class=lnlinks href=#hl-0-81> 81</a>
</span><span class=lnt id=hl-0-82><a class=lnlinks href=#hl-0-82> 82</a>
</span><span class=lnt id=hl-0-83><a class=lnlinks href=#hl-0-83> 83</a>
</span><span class=lnt id=hl-0-84><a class=lnlinks href=#hl-0-84> 84</a>
</span><span class=lnt id=hl-0-85><a class=lnlinks href=#hl-0-85> 85</a>
</span><span class=lnt id=hl-0-86><a class=lnlinks href=#hl-0-86> 86</a>
</span><span class=lnt id=hl-0-87><a class=lnlinks href=#hl-0-87> 87</a>
</span><span class=lnt id=hl-0-88><a class=lnlinks href=#hl-0-88> 88</a>
</span><span class=lnt id=hl-0-89><a class=lnlinks href=#hl-0-89> 89</a>
</span><span class=lnt id=hl-0-90><a class=lnlinks href=#hl-0-90> 90</a>
</span><span class=lnt id=hl-0-91><a class=lnlinks href=#hl-0-91> 91</a>
</span><span class=lnt id=hl-0-92><a class=lnlinks href=#hl-0-92> 92</a>
</span><span class=lnt id=hl-0-93><a class=lnlinks href=#hl-0-93> 93</a>
</span><span class=lnt id=hl-0-94><a class=lnlinks href=#hl-0-94> 94</a>
</span><span class=lnt id=hl-0-95><a class=lnlinks href=#hl-0-95> 95</a>
</span><span class=lnt id=hl-0-96><a class=lnlinks href=#hl-0-96> 96</a>
</span><span class=lnt id=hl-0-97><a class=lnlinks href=#hl-0-97> 97</a>
</span><span class=lnt id=hl-0-98><a class=lnlinks href=#hl-0-98> 98</a>
</span><span class=lnt id=hl-0-99><a class=lnlinks href=#hl-0-99> 99</a>
</span><span class=lnt id=hl-0-100><a class=lnlinks href=#hl-0-100>100</a>
</span><span class=lnt id=hl-0-101><a class=lnlinks href=#hl-0-101>101</a>
</span><span class=lnt id=hl-0-102><a class=lnlinks href=#hl-0-102>102</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>unsigned int tcp_poll(struct file *file, struct socket *sock, poll_table *wait)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    unsigned int mask;
</span></span><span class=line><span class=cl>    struct sock *sk = sock-&gt;sk;
</span></span><span class=line><span class=cl>    struct tcp_sock *tp = tcp_sk(sk);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    sock_poll_wait(file, sk-&gt;sk_sleep, wait);
</span></span><span class=line><span class=cl>    if (sk-&gt;sk_state == TCP_LISTEN) // 侦听状态，进入listen poll，即检查侦听socket的accpet队列是否为空
</span></span><span class=line><span class=cl>        return inet_csk_listen_poll(sk);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /* Socket is not locked. We are protected from async events
</span></span><span class=line><span class=cl>     * by poll logic and correct handling of state changes
</span></span><span class=line><span class=cl>     * made by other threads is impossible in any case.
</span></span><span class=line><span class=cl>     */
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    mask = 0;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /*
</span></span><span class=line><span class=cl>     * POLLHUP is certainly not done right. But poll() doesn&#39;t
</span></span><span class=line><span class=cl>     * have a notion of HUP in just one direction, and for a
</span></span><span class=line><span class=cl>     * socket the read side is more interesting.
</span></span><span class=line><span class=cl>     *
</span></span><span class=line><span class=cl>     * Some poll() documentation says that POLLHUP is incompatible
</span></span><span class=line><span class=cl>     * with the POLLOUT/POLLWR flags, so somebody should check this
</span></span><span class=line><span class=cl>     * all. But careful, it tends to be safer to return too many
</span></span><span class=line><span class=cl>     * bits than too few, and you can easily break real applications
</span></span><span class=line><span class=cl>     * if you don&#39;t tell them that something has hung up!
</span></span><span class=line><span class=cl>     *
</span></span><span class=line><span class=cl>     * Check-me.
</span></span><span class=line><span class=cl>     *
</span></span><span class=line><span class=cl>     * Check number 1. POLLHUP is _UNMASKABLE_ event (see UNIX98 and
</span></span><span class=line><span class=cl>     * our fs/select.c). It means that after we received EOF,
</span></span><span class=line><span class=cl>     * poll always returns immediately, making impossible poll() on write()
</span></span><span class=line><span class=cl>     * in state CLOSE_WAIT. One solution is evident --- to set POLLHUP
</span></span><span class=line><span class=cl>     * if and only if shutdown has been made in both directions.
</span></span><span class=line><span class=cl>     * Actually, it is interesting to look how Solaris and DUX
</span></span><span class=line><span class=cl>     * solve this dilemma. I would prefer, if POLLHUP were maskable,
</span></span><span class=line><span class=cl>     * then we could set it on SND_SHUTDOWN. BTW examples given
</span></span><span class=line><span class=cl>     * in Stevens&#39; books assume exactly this behaviour, it explains
</span></span><span class=line><span class=cl>     * why POLLHUP is incompatible with POLLOUT.    --ANK
</span></span><span class=line><span class=cl>     *
</span></span><span class=line><span class=cl>     * NOTE. Check for TCP_CLOSE is added. The goal is to prevent
</span></span><span class=line><span class=cl>     * blocking on fresh not-connected or disconnected socket. --ANK
</span></span><span class=line><span class=cl>     */
</span></span><span class=line><span class=cl>     /* socket 与tcp 状态转化 poll事件 */
</span></span><span class=line><span class=cl>    if (sk-&gt;sk_shutdown == SHUTDOWN_MASK || sk-&gt;sk_state == TCP_CLOSE)
</span></span><span class=line><span class=cl>        mask |= POLLHUP;
</span></span><span class=line><span class=cl>    if (sk-&gt;sk_shutdown &amp; RCV_SHUTDOWN)
</span></span><span class=line><span class=cl>        mask |= POLLIN | POLLRDNORM | POLLRDHUP;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /* Connected? */
</span></span><span class=line><span class=cl>    if ((1 &lt;&lt; sk-&gt;sk_state) &amp; ~(TCPF_SYN_SENT | TCPF_SYN_RECV)) {
</span></span><span class=line><span class=cl>        int target = sock_rcvlowat(sk, 0, INT_MAX);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        if (tp-&gt;urg_seq == tp-&gt;copied_seq &amp;&amp;
</span></span><span class=line><span class=cl>            !sock_flag(sk, SOCK_URGINLINE) &amp;&amp;
</span></span><span class=line><span class=cl>            tp-&gt;urg_data)
</span></span><span class=line><span class=cl>            target--;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        /* Potential race condition. If read of tp below will
</span></span><span class=line><span class=cl>         * escape above sk-&gt;sk_state, we can be illegally awaken
</span></span><span class=line><span class=cl>         * in SYN_* states. */
</span></span><span class=line><span class=cl>         /*
</span></span><span class=line><span class=cl>         未处理接收报文字节数超过了最小阈值，满足可读条件
</span></span><span class=line><span class=cl>         */
</span></span><span class=line><span class=cl>        if (tp-&gt;rcv_nxt - tp-&gt;copied_seq &gt;= target)
</span></span><span class=line><span class=cl>            mask |= POLLIN | POLLRDNORM;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        if (!(sk-&gt;sk_shutdown &amp; SEND_SHUTDOWN)) {
</span></span><span class=line><span class=cl>            /*  
</span></span><span class=line><span class=cl>            sk-&gt;sk_sndbuf - sk-&gt;sk_wmem_queued &gt;=   sk-&gt;sk_wmem_queued&gt;&gt;1 (简单理解为最大值 0.5* sk-&gt;sk_wmem_queued)
</span></span><span class=line><span class=cl>            如果未发送报文超过了66%，那么不会继续上报POLLOUT事件
</span></span><span class=line><span class=cl>            */
</span></span><span class=line><span class=cl>            if (sk_stream_wspace(sk) &gt;= sk_stream_min_wspace(sk)) {
</span></span><span class=line><span class=cl>                mask |= POLLOUT | POLLWRNORM;
</span></span><span class=line><span class=cl>            } else { 
</span></span><span class=line><span class=cl>                /* send SIGIO later */
</span></span><span class=line><span class=cl>                /* 发送SIGIO  */
</span></span><span class=line><span class=cl>                set_bit(SOCK_ASYNC_NOSPACE,
</span></span><span class=line><span class=cl>                    &amp;sk-&gt;sk_socket-&gt;flags);
</span></span><span class=line><span class=cl>                set_bit(SOCK_NOSPACE, &amp;sk-&gt;sk_socket-&gt;flags);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                /* Race breaker. If space is freed after
</span></span><span class=line><span class=cl>                 * wspace test but before the flags are set,
</span></span><span class=line><span class=cl>                 * IO signal will be lost.
</span></span><span class=line><span class=cl>                 */
</span></span><span class=line><span class=cl>                if (sk_stream_wspace(sk) &gt;= sk_stream_min_wspace(sk))
</span></span><span class=line><span class=cl>                    mask |= POLLOUT | POLLWRNORM;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        } else
</span></span><span class=line><span class=cl>            mask |= POLLOUT | POLLWRNORM;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        if (tp-&gt;urg_data &amp; TCP_URG_VALID)
</span></span><span class=line><span class=cl>            mask |= POLLPRI;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    /* This barrier is coupled with smp_wmb() in tcp_reset() */
</span></span><span class=line><span class=cl>    smp_rmb();
</span></span><span class=line><span class=cl>    if (sk-&gt;sk_err)
</span></span><span class=line><span class=cl>        mask |= POLLERR;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return mask;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=解决方案>解决方案<a hidden class=anchor aria-hidden=true href=#解决方案>#</a></h3><p>知道上面的原因对应可以选择方案如下：</p><p>方案一：增加send_timeout时间，例如将时间调整为280秒，可以保证在5M发送缓冲区条件下，用户下载速度超过50Kbps不会出现超时导致连接被关闭</p><p>方案二：通过设置/proc/sys/net/ipv4/tcp_wmem值减小socket发送缓冲区大小，发送缓冲区减小，那么在一定下载速率下在指定的时间需要完成下载的大小变小，就可以避免上述的问题出现的条件</p><p>显而易见，这种两种方案都不能从根本上解决问题，只是降低问题出现的概率（这也是进步）</p><p>方案三：改变超时处理，而不是直接关闭，可利用ioctl(TIOCOUTQ)来获取有多少数据仍停留在发送缓冲区，调整超时时间，具体实现可以参考<a href=https://blog.cloudflare.com/the-curious-case-of-slow-downloads/>The curious case of slow downloads</a>中提到的方案：<a href=https://github.com/cloudflare/cloudflare-blog/blob/master/2016-03-slow-downloads/nginx_send_minimum_rate.patch>a Linux specific patch to NGINX</a></p><p>相比较于方案一和方案二，方案三对网络速率变化与波动适应性强</p><h3 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h3><ol><li><a href=https://blog.cloudflare.com/the-curious-case-of-slow-downloads/>The curious case of slow downloads</a>值得一看（感谢cloudflare工程师没有放弃一些偶现的问题）</li><li>nginx现有实现单一固化的处理导致不适应tcp传输的多变性</li><li>在复杂多变的网络环境下，保证传输高可靠性里面需要很多技术细节需要挖掘</li><li>网络是复杂的，主要由于以下原因：</li></ol><ul><li>网络协议复杂，例如tcp</li><li>网络本身不可靠</li><li>网络连接多样性</li><li>网络要求高：低延迟，少丢包，抖动小，高速率，自适应</li></ul><h3 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h3><ol><li><a href=https://blog.cloudflare.com/the-curious-case-of-slow-downloads/>The curious case of slow downloads</a></li><li><a href=https://github.com/myself659/linux-2.26.32>linux-2.26.32</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://myself659.github.io/tags/network/>Network</a></li></ul><nav class=paginav><a class=prev href=https://myself659.github.io/post/2017-02-20-go-case-1-my-shadeofgo/><span class=title>« 上一页</span><br><span>Go的50度灰补充--http response只能读一次</span></a>
<a class=next href=https://myself659.github.io/post/internet/2017-02-03-country-internet-user/><span class=title>下一页 »</span><br><span>互联网在农村-用户</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share TCP连接下载文件失败，也许该看看这篇文章 on twitter" href="https://twitter.com/intent/tweet/?text=TCP%e8%bf%9e%e6%8e%a5%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6%e5%a4%b1%e8%b4%a5%ef%bc%8c%e4%b9%9f%e8%ae%b8%e8%af%a5%e7%9c%8b%e7%9c%8b%e8%bf%99%e7%af%87%e6%96%87%e7%ab%a0&amp;url=https%3a%2f%2fmyself659.github.io%2fpost%2f2017-02-16-tcp-slow-down%2f&amp;hashtags=Network"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TCP连接下载文件失败，也许该看看这篇文章 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmyself659.github.io%2fpost%2f2017-02-16-tcp-slow-down%2f&amp;title=TCP%e8%bf%9e%e6%8e%a5%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6%e5%a4%b1%e8%b4%a5%ef%bc%8c%e4%b9%9f%e8%ae%b8%e8%af%a5%e7%9c%8b%e7%9c%8b%e8%bf%99%e7%af%87%e6%96%87%e7%ab%a0&amp;summary=TCP%e8%bf%9e%e6%8e%a5%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6%e5%a4%b1%e8%b4%a5%ef%bc%8c%e4%b9%9f%e8%ae%b8%e8%af%a5%e7%9c%8b%e7%9c%8b%e8%bf%99%e7%af%87%e6%96%87%e7%ab%a0&amp;source=https%3a%2f%2fmyself659.github.io%2fpost%2f2017-02-16-tcp-slow-down%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TCP连接下载文件失败，也许该看看这篇文章 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmyself659.github.io%2fpost%2f2017-02-16-tcp-slow-down%2f&title=TCP%e8%bf%9e%e6%8e%a5%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6%e5%a4%b1%e8%b4%a5%ef%bc%8c%e4%b9%9f%e8%ae%b8%e8%af%a5%e7%9c%8b%e7%9c%8b%e8%bf%99%e7%af%87%e6%96%87%e7%ab%a0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TCP连接下载文件失败，也许该看看这篇文章 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmyself659.github.io%2fpost%2f2017-02-16-tcp-slow-down%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TCP连接下载文件失败，也许该看看这篇文章 on whatsapp" href="https://api.whatsapp.com/send?text=TCP%e8%bf%9e%e6%8e%a5%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6%e5%a4%b1%e8%b4%a5%ef%bc%8c%e4%b9%9f%e8%ae%b8%e8%af%a5%e7%9c%8b%e7%9c%8b%e8%bf%99%e7%af%87%e6%96%87%e7%ab%a0%20-%20https%3a%2f%2fmyself659.github.io%2fpost%2f2017-02-16-tcp-slow-down%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TCP连接下载文件失败，也许该看看这篇文章 on telegram" href="https://telegram.me/share/url?text=TCP%e8%bf%9e%e6%8e%a5%e4%b8%8b%e8%bd%bd%e6%96%87%e4%bb%b6%e5%a4%b1%e8%b4%a5%ef%bc%8c%e4%b9%9f%e8%ae%b8%e8%af%a5%e7%9c%8b%e7%9c%8b%e8%bf%99%e7%af%87%e6%96%87%e7%ab%a0&amp;url=https%3a%2f%2fmyself659.github.io%2fpost%2f2017-02-16-tcp-slow-down%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://myself659.github.io/>沉风网事</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>