<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go channel 编程篇 | 沉风网事</title><meta name=keywords content="golang"><meta name=description content="本篇以ChanBroker版本迭代过程，总结常见Channel编程问题 简介 ChanBroker设计主要参考Kafka模型，主要提供进程内go"><meta name=author content="沉风"><link rel=canonical href=https://myself659.github.io/post/2016-08-20-go-channel-program-demo/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.bf5f9f73cf17311d52cedbcda82c922e91b2f566d88a85ad9f5b5a08b586bd5f.css integrity="sha256-v1+fc88XMR1SztvNqCySLpGy9WbYioWtn1taCLWGvV8=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://myself659.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://myself659.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://myself659.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://myself659.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://myself659.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-144475213-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Go channel 编程篇"><meta property="og:description" content="本篇以ChanBroker版本迭代过程，总结常见Channel编程问题 简介 ChanBroker设计主要参考Kafka模型，主要提供进程内go"><meta property="og:type" content="article"><meta property="og:url" content="https://myself659.github.io/post/2016-08-20-go-channel-program-demo/"><meta property="og:image" content="https://myself659.github.io/"><meta property="article:section" content="post"><meta property="article:published_time" content="2016-08-20T11:58:06+02:00"><meta property="article:modified_time" content="2016-08-20T11:58:06+02:00"><meta property="og:site_name" content="沉风网事"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://myself659.github.io/"><meta name=twitter:title content="Go channel 编程篇"><meta name=twitter:description content="本篇以ChanBroker版本迭代过程，总结常见Channel编程问题 简介 ChanBroker设计主要参考Kafka模型，主要提供进程内go"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://myself659.github.io/post/"},{"@type":"ListItem","position":2,"name":"Go channel 编程篇","item":"https://myself659.github.io/post/2016-08-20-go-channel-program-demo/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go channel 编程篇","name":"Go channel 编程篇","description":"本篇以ChanBroker版本迭代过程，总结常见Channel编程问题 简介 ChanBroker设计主要参考Kafka模型，主要提供进程内go","keywords":["golang"],"articleBody":"本篇以ChanBroker版本迭代过程，总结常见Channel编程问题\n简介 ChanBroker设计主要参考Kafka模型，主要提供进程内goroutine之间通信，实现以下功能：\n支持多个Publisher发布内容 支持Subscriber注册与去注册订阅 发布内容可以是任何形式 ChanBroker根据订阅情况完成内容推送 版本1 具体代码如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 package ChanBroker type Content interface{} type Subscriber chan Content type ChanBroker struct { RegSub chan Subscriber UnRegSub chan Subscriber Contents chan Content Stop chan bool Subscribers map[Subscriber]bool } func NewChanBroker() *ChanBroker { ChanBroker := new(ChanBroker) ChanBroker.RegSub = make(chan Subscriber) ChanBroker.UnRegSub = make(chan Subscriber) ChanBroker.Contents = make(chan Content) ChanBroker.Stop = make(chan bool) ChanBroker.Subscribers = make(map[Subscriber]bool) ChanBroker.run() return ChanBroker } func (self *ChanBroker) run() { go func() { // Broker goroutine for { select { case content := \u003c-self.Contents: for sub := range self.Subscribers { sub \u003c- content } case sub := \u003c-self.RegSub: self.Subscribers[sub] = true case sub := \u003c-self.UnRegSub: delete(self.Subscribers, sub) close(sub) case \u003c-self.Stop: for sub := range self.Subscribers { delete(self.Subscribers, sub) close(sub) } return } } }() } func (self *ChanBroker) RegSubscriber() Subscriber { sub := make(Subscriber) self.RegSub \u003c- sub return sub } func (self *ChanBroker) UnRegSubscriber(sub Subscriber) { self.UnRegSub \u003c- sub } func (self *ChanBroker) StopPublish() { self.Stop \u003c- true } func (self *ChanBroker) PubContent(c Content) { self.Contents \u003c- c } 存在以下问题，具体如下：\n问题1：不支持扩展 问题描述：\n在一个Broker goroutine内完成注册与去注册以及内容发布推送给Subscriber，无法控制Subscriber数量，且不支持扩展\n解决思路：\n主要修改如下：\n增加Pusher goroutine，Pusher goroutine支持动态创建，由Pusher goroutine完成具体内容的推送 问题2： 推送内容到Subscriber存在Deadlock风险 问题描述：\n例如一个Subscriber不能正确从通道接收订阅内容，那么Broker会阻塞在上述代码的34行，与此同时其他Subscriber都会阻塞，极有可能引起级联阻塞，影响恶劣\n解决思路：\n主要修改如下：\n支持Subscriber可以定制订阅通道的大小，利用队列缓存内容 增加Pusher goroutine，避免由于某个内容的推送导致整个内容推送的阻塞 增加超时机制，避免在具体内容推送过程由于某一个Subscriber不正常工作影响其他的Subscriber 问题3： Broker goroutine退出后调用RegSubscriber，UnRegSubscriber，StopPublish，PubContent函数存在Deadlock风险 问题描述：\n如题\n解决思路：\n主要修改如下：\nChanBroker增加退出状态描述，避免Broker goroutine退出之后上述函数向Broker goroutine 的channel发送信息 版本2 具体代码如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 package ChanBroker import ( \"fmt\" \"sync\" \"time\" ) type Content interface{} type Subscriber chan Content type ChanBroker struct { RegSub chan Subscriber UnRegSub chan Subscriber Contents chan Content Stop chan bool exit bool Subscribers map[Subscriber]bool lock sync.RWMutex timeout time.Duration } func NewChanBroker(timeout time.Duration) *ChanBroker { ChanBroker := new(ChanBroker) ChanBroker.RegSub = make(chan Subscriber) ChanBroker.UnRegSub = make(chan Subscriber) ChanBroker.Contents = make(chan Content) ChanBroker.Stop = make(chan bool) ChanBroker.exit = false ChanBroker.Subscribers = make(map[Subscriber]bool) ChanBroker.timeout = timeout ChanBroker.run() return ChanBroker } func (self *ChanBroker) run() { go func() { // Broker goroutine for { select { case content := \u003c-self.Contents: go func() { // Pusher goroutine self.lock.RLock() for sub := range self.Subscribers { select { case sub \u003c- content: case \u003c-time.After(self.timeout): fmt.Println(sub, \"time out \") } } self.lock.RUnlock() }() case sub := \u003c-self.RegSub: self.lock.Lock() self.Subscribers[sub] = true self.lock.Unlock() case sub := \u003c-self.UnRegSub: self.lock.Lock() delete(self.Subscribers, sub) self.lock.Unlock() close(sub) // may be close of closed channel case \u003c-self.Stop: if self.exit == false { self.exit = true close(self.Stop) self.lock.Lock() for sub := range self.Subscribers { delete(self.Subscribers, sub) // 必须先删除再close close(sub) } self.lock.Unlock() return // exit goroutine } } } }() } func (self *ChanBroker) RegSubscriber(size uint) Subscriber { if self.exit == true { return nil } sub := make(Subscriber, size) self.RegSub \u003c- sub // maybe block return sub } func (self *ChanBroker) UnRegSubscriber(sub Subscriber) { if self.exit == true { return } self.UnRegSub \u003c- sub // maybe block } func (self *ChanBroker) StopPublish() { if self.exit == true { return } self.Stop \u003c- true // maybe panic } func (self *ChanBroker) PubContent(c Content) { self.Contents \u003c- c // maybe block } 存在以下问题，具体如下：\n问题1：存在 panic:close of closed channel的风险 问题描述：\n如果Subscriber goroutine两次调用UnRegSubscriber，就会发生close of closed channel，导致panic\n相应代码如下：\n1 2 3 4 5 case sub := \u003c-self.UnRegSub: self.lock.Lock() delete(self.Subscribers, sub) self.lock.Unlock() close(sub) // may be close of closed channel 解决思路：\n很简单，关闭前检查Subscriber对应channel是否订阅map当中，代码如下：\n1 2 3 4 5 6 7 8 case sub := \u003c-self.UnRegSub: self.lock.Lock() _, ok := self.Subscribers[sub] if ok { delete(self.Subscribers, sub) close(sub) } self.lock.Unlock() 问题2：不靠谱的exit标记 问题描述：\nexit标记不能同步goroutines对Stop通道的写操作与关闭操作，具体分析如下：\n写操作代码如下：\n1 2 3 4 5 6 7 8 func (self *ChanBroker) RegSubscriber(size uint) Subscriber { if self.exit == true { return nil } sub := make(Subscriber, size) self.RegSub \u003c- sub // maybe block return sub } 关闭操作代码段如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 case \u003c-self.Stop: if self.exit == false { self.exit = true close(self.Stop) self.lock.Lock() for sub := range self.Subscribers { delete(self.Subscribers, sub) // 必须先删除再close close(sub) } self.lock.Unlock() return // exit goroutine } 在多核多个goroutine并发情况，极小概率会发生如下情况：\n某同一个时刻，CPU0 运行RegSubscriber goroutine检查exit标记为false，CPU0继续运行，CPU1运行到关闭操作代码段第1行，继续运行 CPU0 继续运行RegSubscriber goroutine，直到阻塞在第6行, 切换运行其他goroutine，CPU 1 关闭Stop Channel,并退出broken goroutine CPU0 继续运行其他goroutine，RegSubscriber goroutine一直阻塞在第6行,等待 broken goroutine 读Stop channel CPU0 继续执行其他goroutine，RegSubscriber goroutine一直阻塞在第6行，,等待 broken goroutine 读Stop channel CPU0 继续执行其他goroutine，RegSubscriber goroutine一直阻塞在第6行，,等待 broken goroutine 读Stop channel … 解决思路：\n不用exit标记了，将状态关联到Stop Channel状态上（这又掉到另一个坑里）\n问题3：不能保证Subscribers有序的接收消息 问题描述：\n版本2中每接收一个Content都会启动一个Push goroutine,这些Push goroutine执行是无序执行的，有序的内容推送需求遇上了无序的goroutine，自然有问题了\n解决思路：\n方案1：无序推送，由Content自身加上序号，同时由各个Subscriber处理逻辑根据序号保证有序处理Content\n方案2：每一个Subcriber有一个Content队列，保证有序推送，简化各个Subscriber处理逻辑，具体实现见版本5\n版本3 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 package ChanBroker import ( \"errors\" \"fmt\" \"sync\" \"time\" ) type Content interface{} type Subscriber chan Content type ChanBroker struct { RegSub chan Subscriber UnRegSub chan Subscriber Contents chan Content Stop chan bool exit bool Subscribers map[Subscriber]bool lock sync.RWMutex timeout time.Duration } var errBrokerExit error = errors.New(\"Broker exit\") var errTimeOut error = errors.New(\"Time out\") func NewChanBroker(timeout time.Duration) *ChanBroker { ChanBroker := new(ChanBroker) ChanBroker.RegSub = make(chan Subscriber) ChanBroker.UnRegSub = make(chan Subscriber) ChanBroker.Contents = make(chan Content) ChanBroker.Stop = make(chan bool) ChanBroker.exit = false ChanBroker.Subscribers = make(map[Subscriber]bool) ChanBroker.timeout = timeout ChanBroker.run() return ChanBroker } func (self *ChanBroker) run() { go func() { for { select { case content := \u003c-self.Contents: go func() { self.lock.RLock() for sub := range self.Subscribers { select { case sub \u003c- content: case \u003c-time.After(self.timeout): fmt.Println(sub, \"time out \") } } self.lock.RUnlock() }() case sub := \u003c-self.RegSub: self.lock.Lock() self.Subscribers[sub] = true self.lock.Unlock() case sub := \u003c-self.UnRegSub: self.lock.Lock() _, ok := self.Subscribers[sub] if ok { delete(self.Subscribers, sub) close(sub) } self.lock.Unlock() case \u003c-self.Stop: close(self.Stop) self.lock.Lock() for sub := range self.Subscribers { delete(self.Subscribers, sub) close(sub) } self.lock.Unlock() return // exit goroutine } } }() } func (self *ChanBroker) RegSubscriber(size uint) (Subscriber, error) { select { case _, ok := \u003c-self.Stop: if ok == false { return nil, errBrokerExit } else { sub := make(Subscriber, size) self.RegSub \u003c- sub return sub, nil } case \u003c-time.After(self.timeout): return nil, errTimeOut default: sub := make(Subscriber, size) self.RegSub \u003c- sub return sub, nil } } func (self *ChanBroker) UnRegSubscriber(sub Subscriber) { select { case _, ok := \u003c-self.Stop: if ok == false { return } else { self.UnRegSub \u003c- sub return } case \u003c-time.After(self.timeout): return default: self.UnRegSub \u003c- sub return } } func (self *ChanBroker) StopPublish() { select { case _, ok := \u003c-self.Stop: if ok == false { return } else { self.Stop \u003c- true return } default: self.Stop \u003c- true return } } func (self *ChanBroker) PubContent(c Content) error { select { case _, ok := \u003c-self.Stop: if ok == false { return errBrokerExit } else { self.Contents \u003c- c return nil } case \u003c-time.After(self.timeout): return errTimeOut default: self.Contents \u003c- c return nil } } 存在以下问题，具体如下：\n问题1： 读channel出现错误的竞争 问题描述：\n版本3的一个错误的方案选择，导致Stop Channel出现读竞争，导致不能停止发布，出现goroutine leak，分析如下：\nStop Channel 只会写一次 Stop Channel 却有多个读goroutine 基于上面有情况，并不能保证Broker goroutine 能收到停止发布的信息，如果被其他goroutine收到，导致Broker goroutine收不到结束消息，进而不能关闭所有Subscriber，导致所有Subscriber goroutine泄露 解决思路：\n版本3引入关闭状态是一个错误的设计，引入状态，也就引入对依赖状态的对象，增加了代码的复杂性，状态的维护容易导致bug，在设计与代码应当追求无状态设计（好处多多）, 这里采用超时来解决，如果超时用由调用者确定处理策略\n版本4 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 package ChanBroker import ( \"errors\" \"fmt\" \"sync\" \"time\" ) type Content interface{} type Subscriber chan Content type ChanBroker struct { RegSub chan Subscriber UnRegSub chan Subscriber Contents chan Content Stop chan bool exit bool Subscribers map[Subscriber]bool lock sync.RWMutex timeout time.Duration } var errBrokerExit error = errors.New(\"ChanBroker exit\") var errTimeOut error = errors.New(\"ChanBroker Time out\") func NewChanBroker(timeout time.Duration) *ChanBroker { ChanBroker := new(ChanBroker) ChanBroker.RegSub = make(chan Subscriber) ChanBroker.UnRegSub = make(chan Subscriber) ChanBroker.Contents = make(chan Content) ChanBroker.Stop = make(chan bool) ChanBroker.exit = false ChanBroker.Subscribers = make(map[Subscriber]bool) ChanBroker.timeout = timeout ChanBroker.run() return ChanBroker } func (self *ChanBroker) run() { go func() { for { select { case content := \u003c-self.Contents: go func() { self.lock.RLock() for sub := range self.Subscribers { select { case sub \u003c- content: case \u003c-time.After(self.timeout): fmt.Println(sub, \"time out \") } } self.lock.RUnlock() }() case sub := \u003c-self.RegSub: self.lock.Lock() self.Subscribers[sub] = true self.lock.Unlock() case sub := \u003c-self.UnRegSub: self.lock.Lock() _, ok := self.Subscribers[sub] if ok { delete(self.Subscribers, sub) close(sub) } self.lock.Unlock() case \u003c-self.Stop: // close(self.Stop) self.lock.Lock() for sub := range self.Subscribers { delete(self.Subscribers, sub) close(sub) } self.lock.Unlock() return // exit goroutine } } }() } func (self *ChanBroker) RegSubscriber(size uint) (Subscriber, error) { sub := make(Subscriber, size) select { case \u003c-time.After(self.timeout): return nil, errTimeOut case self.RegSub \u003c- sub: return sub, nil } } func (self *ChanBroker) UnRegSubscriber(sub Subscriber) { select { case \u003c-time.After(self.timeout): return case self.UnRegSub \u003c- sub: return } } func (self *ChanBroker) StopPublish() error { select { case self.Stop \u003c- true: return nil case \u003c-time.After(self.timeout): return errTimeOut } } func (self *ChanBroker) PubContent(c Content) error { select { case \u003c-time.After(self.timeout): return errTimeOut case self.Contents \u003c- c: return nil } } 存在以下问题，具体如下：\n问题1：timeout问题 问题描述：\ntimeout 导致长时间持有读锁 timeout 导致消息丢失，并没有推送成功 上一个Subscriber超时影响后面Subscriber内容的实时性 解决方案：\n采用select实现channel非阻塞写 对于非阻塞写失败，加入Subscriber对应的链表 非阻塞写保证避免Subscribers之间相互影响 问题2：锁问题 问题描述：\n每个Pusher goroutine持有读锁，一定情况下会成为性能的瓶颈 解决方案：\n在上面避免阻塞的基础上，只有一个goroutine来推送内容 版本5 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 package ChanBroker import ( \"container/list\" \"errors\" \"time\" ) type Content interface{} type Subscriber chan Content type ChanBroker struct { regSub chan Subscriber unRegSub chan Subscriber contents chan Content stop chan bool subscribers map[Subscriber]*list.List timeout time.Duration cachenum uint timerChan \u003c-chan time.Time } var ErrBrokerExit error = errors.New(\"ChanBroker exit\") var ErrPublishTimeOut error = errors.New(\"ChanBroker Pulish Time out\") var ErrRegTimeOut error = errors.New(\"ChanBroker Reg Time out\") var ErrStopPublishTimeOut error = errors.New(\"ChanBroker Stop Publish Time out\") func NewChanBroker(timeout time.Duration) *ChanBroker { Broker := new(ChanBroker) Broker.regSub = make(chan Subscriber) Broker.unRegSub = make(chan Subscriber) Broker.contents = make(chan Content) Broker.stop = make(chan bool, 1) Broker.subscribers = make(map[Subscriber]*list.List) Broker.timeout = timeout Broker.cachenum = 0 Broker.timerChan = nil Broker.run() return Broker } func (self *ChanBroker) onContentPush(content Content) { for sub, clist := range self.subscribers { loop := true for next := clist.Front(); next != nil \u0026\u0026 loop == true; { cur := next next = cur.Next() select { case sub \u003c- cur.Value: if self.cachenum \u003e 0 { self.cachenum-- } clist.Remove(cur) default: loop = false } } len := clist.Len() if len == 0 { select { case sub \u003c- content: default: clist.PushBack(content) self.cachenum++ } } else { clist.PushBack(content) self.cachenum++ } } if self.cachenum \u003e 0 \u0026\u0026 self.timerChan == nil { timer := time.NewTimer(self.timeout) self.timerChan = timer.C } } func (self *ChanBroker) onTimerPush() { for sub, clist := range self.subscribers { loop := true for next := clist.Front(); next != nil \u0026\u0026 loop == true; { cur := next next = cur.Next() select { case sub \u003c- cur.Value: if self.cachenum \u003e 0 { self.cachenum-- } clist.Remove(cur) default: loop = false } } } if self.cachenum \u003e 0 { timer := time.NewTimer(self.timeout) self.timerChan = timer.C } else { self.timerChan = nil } } func (self *ChanBroker) run() { go func() { // Broker Goroutine for { select { case content := \u003c-self.contents: self.onContentPush(content) case \u003c-self.timerChan: self.onTimerPush() case sub := \u003c-self.regSub: clist := list.New() self.subscribers[sub] = clist case sub := \u003c-self.unRegSub: _, ok := self.subscribers[sub] if ok { delete(self.subscribers, sub) close(sub) } case _, ok := \u003c-self.stop: if ok == true { close(self.stop) } else { if self.cachenum == 0 { return } } self.onTimerPush() for sub, clist := range self.subscribers { if clist.Len() == 0 { delete(self.subscribers, sub) close(sub) } } } } }() } func (self *ChanBroker) RegSubscriber(size uint) (Subscriber, error) { sub := make(Subscriber, size) select { case \u003c-time.After(self.timeout): return nil, ErrRegTimeOut case self.regSub \u003c- sub: return sub, nil } } func (self *ChanBroker) UnRegSubscriber(sub Subscriber) { select { case \u003c-time.After(self.timeout): return case self.unRegSub \u003c- sub: return } } func (self *ChanBroker) StopPublish() error { select { case self.stop \u003c- true: return nil case \u003c-time.After(self.timeout): return ErrStopPublishTimeOut } } func (self *ChanBroker) PubContent(c Content) error { select { case \u003c-time.After(self.timeout): return ErrPublishTimeOut case self.contents \u003c- c: return nil } } 存在以下问题，具体如下：\n问题1：不支持扩展 问题描述：\n在一个Broker goroutine内完成注册与去注册以及内容发布推送给Subscriber，无法控制Subscriber数量，且不支持扩展\n解决思路：\n业务场景：chanbroker是进程内goroutines之间pub-sub通信方式一种实现方案，一个goroutine占用一个核来处理能满足绝太多数需求 即使不能满足极个别需求，也可以选择创建多个ChanBroker来实现扩展 channel编程总结 避免Panic，参考Go channel 特点篇 最大程度保证非阻塞 若非业务需要，避免channel之间读写竞争 channel使用很灵活，也容易出错，建议多在设计上下功夫，分解问题采用简单的模型来解决问题 避免多余的channel状态引入,例如关闭channel 要有并发意识，由代码想到goroutine的运行 禁止通道复用，避免复用带来的复杂性 初期测试很重要，而且应作到充分测试 Don’t communicate by sharing memory, share memory by communicating 由于个人水平有限，有什么不足与错误，敬请指正！\n","wordCount":"5034","inLanguage":"zh","datePublished":"2016-08-20T11:58:06+02:00","dateModified":"2016-08-20T11:58:06+02:00","author":{"@type":"Person","name":"沉风"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://myself659.github.io/post/2016-08-20-go-channel-program-demo/"},"publisher":{"@type":"Organization","name":"沉风网事","logo":{"@type":"ImageObject","url":"https://myself659.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://myself659.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://myself659.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://myself659.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://myself659.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://myself659.github.io/search/ title=Search><span>Search</span></a></li><li><a href=https://myself659.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://myself659.github.io/about/ title=About><span>About</span></a></li><li><a href=https://myself659.github.io/post/leetcode/ title=LeetCode><span>LeetCode</span></a></li><li><a href=https://myself659.github.io/post/read-post/ title=Reading><span>Reading</span></a></li><li><a href=https://myself659.github.io/post/share-post/ title=Share><span>Share</span></a></li><li><a href=https://myself659.github.io/post/slide-post/ title=Slide><span>Slide</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://myself659.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://myself659.github.io/post/>Posts</a></div><h1 class=post-title>Go channel 编程篇</h1><div class=post-meta><span title='2016-08-20 11:58:06 +0200 +0200'>2016-08-20</span>&nbsp;·&nbsp;沉风</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e7%ae%80%e4%bb%8b aria-label=简介>简介</a></li><li><a href=#%e7%89%88%e6%9c%ac1 aria-label=版本1>版本1</a><ul><li><a href=#%e9%97%ae%e9%a2%981%e4%b8%8d%e6%94%af%e6%8c%81%e6%89%a9%e5%b1%95 aria-label=问题1：不支持扩展>问题1：不支持扩展</a></li><li><a href=#%e9%97%ae%e9%a2%982-%e6%8e%a8%e9%80%81%e5%86%85%e5%ae%b9%e5%88%b0subscriber%e5%ad%98%e5%9c%a8deadlock%e9%a3%8e%e9%99%a9 aria-label="问题2： 推送内容到Subscriber存在Deadlock风险">问题2： 推送内容到Subscriber存在Deadlock风险</a></li><li><a href=#%e9%97%ae%e9%a2%983-broker-goroutine%e9%80%80%e5%87%ba%e5%90%8e%e8%b0%83%e7%94%a8regsubscriberunregsubscriberstoppublishpubcontent%e5%87%bd%e6%95%b0%e5%ad%98%e5%9c%a8deadlock%e9%a3%8e%e9%99%a9 aria-label="问题3： Broker goroutine退出后调用RegSubscriber，UnRegSubscriber，StopPublish，PubContent函数存在Deadlock风险">问题3： Broker goroutine退出后调用RegSubscriber，UnRegSubscriber，StopPublish，PubContent函数存在Deadlock风险</a></li></ul></li><li><a href=#%e7%89%88%e6%9c%ac2 aria-label=版本2>版本2</a><ul><li><a href=#%e9%97%ae%e9%a2%981%e5%ad%98%e5%9c%a8-panicclose-of-closed-channel%e7%9a%84%e9%a3%8e%e9%99%a9 aria-label="问题1：存在 panic:close of closed channel的风险">问题1：存在 panic:close of closed channel的风险</a></li><li><a href=#%e9%97%ae%e9%a2%982%e4%b8%8d%e9%9d%a0%e8%b0%b1%e7%9a%84exit%e6%a0%87%e8%ae%b0 aria-label=问题2：不靠谱的exit标记>问题2：不靠谱的exit标记</a></li><li><a href=#%e9%97%ae%e9%a2%983%e4%b8%8d%e8%83%bd%e4%bf%9d%e8%af%81subscribers%e6%9c%89%e5%ba%8f%e7%9a%84%e6%8e%a5%e6%94%b6%e6%b6%88%e6%81%af aria-label=问题3：不能保证Subscribers有序的接收消息>问题3：不能保证Subscribers有序的接收消息</a></li></ul></li><li><a href=#%e7%89%88%e6%9c%ac3 aria-label=版本3>版本3</a><ul><li><a href=#%e9%97%ae%e9%a2%981-%e8%af%bbchannel%e5%87%ba%e7%8e%b0%e9%94%99%e8%af%af%e7%9a%84%e7%ab%9e%e4%ba%89 aria-label="问题1： 读channel出现错误的竞争">问题1： 读channel出现错误的竞争</a></li></ul></li><li><a href=#%e7%89%88%e6%9c%ac4 aria-label=版本4>版本4</a><ul><li><a href=#%e9%97%ae%e9%a2%981timeout%e9%97%ae%e9%a2%98 aria-label=问题1：timeout问题>问题1：timeout问题</a></li><li><a href=#%e9%97%ae%e9%a2%982%e9%94%81%e9%97%ae%e9%a2%98 aria-label=问题2：锁问题>问题2：锁问题</a></li></ul></li><li><a href=#%e7%89%88%e6%9c%ac5 aria-label=版本5>版本5</a><ul><li><a href=#%e9%97%ae%e9%a2%981%e4%b8%8d%e6%94%af%e6%8c%81%e6%89%a9%e5%b1%95-1 aria-label=问题1：不支持扩展>问题1：不支持扩展</a></li></ul></li><li><a href=#channel%e7%bc%96%e7%a8%8b%e6%80%bb%e7%bb%93 aria-label=channel编程总结>channel编程总结</a></li></ul></div></details></div><div class=post-content><p>本篇以<a href=https://github.com/myself659/ChanBroker>ChanBroker</a>版本迭代过程，总结常见Channel编程问题</p><h3 id=简介>简介<a hidden class=anchor aria-hidden=true href=#简介>#</a></h3><p>ChanBroker设计主要参考Kafka模型，主要提供进程内goroutine之间通信，实现以下功能：</p><ol><li>支持多个Publisher发布内容</li><li>支持Subscriber注册与去注册订阅</li><li>发布内容可以是任何形式</li><li>ChanBroker根据订阅情况完成内容推送</li></ol><h3 id=版本1>版本1<a hidden class=anchor aria-hidden=true href=#版本1>#</a></h3><p>具体代码如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31>31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32>32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33>33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34>34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35>35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36>36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37>37</a>
</span><span class=lnt id=hl-0-38><a class=lnlinks href=#hl-0-38>38</a>
</span><span class=lnt id=hl-0-39><a class=lnlinks href=#hl-0-39>39</a>
</span><span class=lnt id=hl-0-40><a class=lnlinks href=#hl-0-40>40</a>
</span><span class=lnt id=hl-0-41><a class=lnlinks href=#hl-0-41>41</a>
</span><span class=lnt id=hl-0-42><a class=lnlinks href=#hl-0-42>42</a>
</span><span class=lnt id=hl-0-43><a class=lnlinks href=#hl-0-43>43</a>
</span><span class=lnt id=hl-0-44><a class=lnlinks href=#hl-0-44>44</a>
</span><span class=lnt id=hl-0-45><a class=lnlinks href=#hl-0-45>45</a>
</span><span class=lnt id=hl-0-46><a class=lnlinks href=#hl-0-46>46</a>
</span><span class=lnt id=hl-0-47><a class=lnlinks href=#hl-0-47>47</a>
</span><span class=lnt id=hl-0-48><a class=lnlinks href=#hl-0-48>48</a>
</span><span class=lnt id=hl-0-49><a class=lnlinks href=#hl-0-49>49</a>
</span><span class=lnt id=hl-0-50><a class=lnlinks href=#hl-0-50>50</a>
</span><span class=lnt id=hl-0-51><a class=lnlinks href=#hl-0-51>51</a>
</span><span class=lnt id=hl-0-52><a class=lnlinks href=#hl-0-52>52</a>
</span><span class=lnt id=hl-0-53><a class=lnlinks href=#hl-0-53>53</a>
</span><span class=lnt id=hl-0-54><a class=lnlinks href=#hl-0-54>54</a>
</span><span class=lnt id=hl-0-55><a class=lnlinks href=#hl-0-55>55</a>
</span><span class=lnt id=hl-0-56><a class=lnlinks href=#hl-0-56>56</a>
</span><span class=lnt id=hl-0-57><a class=lnlinks href=#hl-0-57>57</a>
</span><span class=lnt id=hl-0-58><a class=lnlinks href=#hl-0-58>58</a>
</span><span class=lnt id=hl-0-59><a class=lnlinks href=#hl-0-59>59</a>
</span><span class=lnt id=hl-0-60><a class=lnlinks href=#hl-0-60>60</a>
</span><span class=lnt id=hl-0-61><a class=lnlinks href=#hl-0-61>61</a>
</span><span class=lnt id=hl-0-62><a class=lnlinks href=#hl-0-62>62</a>
</span><span class=lnt id=hl-0-63><a class=lnlinks href=#hl-0-63>63</a>
</span><span class=lnt id=hl-0-64><a class=lnlinks href=#hl-0-64>64</a>
</span><span class=lnt id=hl-0-65><a class=lnlinks href=#hl-0-65>65</a>
</span><span class=lnt id=hl-0-66><a class=lnlinks href=#hl-0-66>66</a>
</span><span class=lnt id=hl-0-67><a class=lnlinks href=#hl-0-67>67</a>
</span><span class=lnt id=hl-0-68><a class=lnlinks href=#hl-0-68>68</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>ChanBroker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Content</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Subscriber</span> <span class=kd>chan</span> <span class=nx>Content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ChanBroker</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>RegSub</span>      <span class=kd>chan</span> <span class=nx>Subscriber</span>
</span></span><span class=line><span class=cl>    <span class=nx>UnRegSub</span>    <span class=kd>chan</span> <span class=nx>Subscriber</span>
</span></span><span class=line><span class=cl>    <span class=nx>Contents</span>    <span class=kd>chan</span> <span class=nx>Content</span>
</span></span><span class=line><span class=cl>    <span class=nx>Stop</span>        <span class=kd>chan</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>Subscribers</span> <span class=kd>map</span><span class=p>[</span><span class=nx>Subscriber</span><span class=p>]</span><span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewChanBroker</span><span class=p>()</span> <span class=o>*</span><span class=nx>ChanBroker</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>ChanBroker</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>RegSub</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>UnRegSub</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Contents</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Stop</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>Subscriber</span><span class=p>]</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>ChanBroker</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// Broker goroutine  
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>content</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Contents</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>sub</span> <span class=o>&lt;-</span> <span class=nx>content</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>RegSub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>[</span><span class=nx>sub</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>UnRegSub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>delete</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>close</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nb>delete</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nb>close</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>  
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>RegSubscriber</span><span class=p>()</span> <span class=nx>Subscriber</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>sub</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>self</span><span class=p>.</span><span class=nx>RegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>sub</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>UnRegSubscriber</span><span class=p>(</span><span class=nx>sub</span> <span class=nx>Subscriber</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>self</span><span class=p>.</span><span class=nx>UnRegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>StopPublish</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span> <span class=o>&lt;-</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>PubContent</span><span class=p>(</span><span class=nx>c</span> <span class=nx>Content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>self</span><span class=p>.</span><span class=nx>Contents</span> <span class=o>&lt;-</span> <span class=nx>c</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>存在以下问题，具体如下：</p><h4 id=问题1不支持扩展>问题1：不支持扩展<a hidden class=anchor aria-hidden=true href=#问题1不支持扩展>#</a></h4><p><strong>问题描述</strong>：</p><p>在一个Broker goroutine内完成注册与去注册以及内容发布推送给Subscriber，无法控制Subscriber数量，且不支持扩展</p><p><strong>解决思路</strong>：</p><p>主要修改如下：</p><ol><li>增加Pusher goroutine，Pusher goroutine支持动态创建，由Pusher goroutine完成具体内容的推送</li></ol><h4 id=问题2-推送内容到subscriber存在deadlock风险>问题2： 推送内容到Subscriber存在Deadlock风险<a hidden class=anchor aria-hidden=true href=#问题2-推送内容到subscriber存在deadlock风险>#</a></h4><p><strong>问题描述</strong>：</p><p>例如一个Subscriber不能正确从通道接收订阅内容，那么Broker会阻塞在上述代码的34行，与此同时其他Subscriber都会阻塞，极有可能引起级联阻塞，影响恶劣</p><p><strong>解决思路</strong>：</p><p>主要修改如下：</p><ol><li>支持Subscriber可以定制订阅通道的大小，利用队列缓存内容</li><li>增加Pusher goroutine，避免由于某个内容的推送导致整个内容推送的阻塞</li><li>增加超时机制，避免在具体内容推送过程由于某一个Subscriber不正常工作影响其他的Subscriber</li></ol><h4 id=问题3-broker-goroutine退出后调用regsubscriberunregsubscriberstoppublishpubcontent函数存在deadlock风险>问题3： Broker goroutine退出后调用RegSubscriber，UnRegSubscriber，StopPublish，PubContent函数存在Deadlock风险<a hidden class=anchor aria-hidden=true href=#问题3-broker-goroutine退出后调用regsubscriberunregsubscriberstoppublishpubcontent函数存在deadlock风险>#</a></h4><p><strong>问题描述</strong>：</p><p>如题</p><p><strong>解决思路</strong>：</p><p>主要修改如下：</p><ol><li>ChanBroker增加退出状态描述，避免Broker goroutine退出之后上述函数向Broker goroutine 的channel发送信息</li></ol><h3 id=版本2>版本2<a hidden class=anchor aria-hidden=true href=#版本2>#</a></h3><p>具体代码如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>  1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>  2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>  3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4>  4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5>  5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6>  6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7>  7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8>  8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9>  9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10> 10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11> 11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12> 12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13> 13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14> 14</a>
</span><span class=lnt id=hl-1-15><a class=lnlinks href=#hl-1-15> 15</a>
</span><span class=lnt id=hl-1-16><a class=lnlinks href=#hl-1-16> 16</a>
</span><span class=lnt id=hl-1-17><a class=lnlinks href=#hl-1-17> 17</a>
</span><span class=lnt id=hl-1-18><a class=lnlinks href=#hl-1-18> 18</a>
</span><span class=lnt id=hl-1-19><a class=lnlinks href=#hl-1-19> 19</a>
</span><span class=lnt id=hl-1-20><a class=lnlinks href=#hl-1-20> 20</a>
</span><span class=lnt id=hl-1-21><a class=lnlinks href=#hl-1-21> 21</a>
</span><span class=lnt id=hl-1-22><a class=lnlinks href=#hl-1-22> 22</a>
</span><span class=lnt id=hl-1-23><a class=lnlinks href=#hl-1-23> 23</a>
</span><span class=lnt id=hl-1-24><a class=lnlinks href=#hl-1-24> 24</a>
</span><span class=lnt id=hl-1-25><a class=lnlinks href=#hl-1-25> 25</a>
</span><span class=lnt id=hl-1-26><a class=lnlinks href=#hl-1-26> 26</a>
</span><span class=lnt id=hl-1-27><a class=lnlinks href=#hl-1-27> 27</a>
</span><span class=lnt id=hl-1-28><a class=lnlinks href=#hl-1-28> 28</a>
</span><span class=lnt id=hl-1-29><a class=lnlinks href=#hl-1-29> 29</a>
</span><span class=lnt id=hl-1-30><a class=lnlinks href=#hl-1-30> 30</a>
</span><span class=lnt id=hl-1-31><a class=lnlinks href=#hl-1-31> 31</a>
</span><span class=lnt id=hl-1-32><a class=lnlinks href=#hl-1-32> 32</a>
</span><span class=lnt id=hl-1-33><a class=lnlinks href=#hl-1-33> 33</a>
</span><span class=lnt id=hl-1-34><a class=lnlinks href=#hl-1-34> 34</a>
</span><span class=lnt id=hl-1-35><a class=lnlinks href=#hl-1-35> 35</a>
</span><span class=lnt id=hl-1-36><a class=lnlinks href=#hl-1-36> 36</a>
</span><span class=lnt id=hl-1-37><a class=lnlinks href=#hl-1-37> 37</a>
</span><span class=lnt id=hl-1-38><a class=lnlinks href=#hl-1-38> 38</a>
</span><span class=lnt id=hl-1-39><a class=lnlinks href=#hl-1-39> 39</a>
</span><span class=lnt id=hl-1-40><a class=lnlinks href=#hl-1-40> 40</a>
</span><span class=lnt id=hl-1-41><a class=lnlinks href=#hl-1-41> 41</a>
</span><span class=lnt id=hl-1-42><a class=lnlinks href=#hl-1-42> 42</a>
</span><span class=lnt id=hl-1-43><a class=lnlinks href=#hl-1-43> 43</a>
</span><span class=lnt id=hl-1-44><a class=lnlinks href=#hl-1-44> 44</a>
</span><span class=lnt id=hl-1-45><a class=lnlinks href=#hl-1-45> 45</a>
</span><span class=lnt id=hl-1-46><a class=lnlinks href=#hl-1-46> 46</a>
</span><span class=lnt id=hl-1-47><a class=lnlinks href=#hl-1-47> 47</a>
</span><span class=lnt id=hl-1-48><a class=lnlinks href=#hl-1-48> 48</a>
</span><span class=lnt id=hl-1-49><a class=lnlinks href=#hl-1-49> 49</a>
</span><span class=lnt id=hl-1-50><a class=lnlinks href=#hl-1-50> 50</a>
</span><span class=lnt id=hl-1-51><a class=lnlinks href=#hl-1-51> 51</a>
</span><span class=lnt id=hl-1-52><a class=lnlinks href=#hl-1-52> 52</a>
</span><span class=lnt id=hl-1-53><a class=lnlinks href=#hl-1-53> 53</a>
</span><span class=lnt id=hl-1-54><a class=lnlinks href=#hl-1-54> 54</a>
</span><span class=lnt id=hl-1-55><a class=lnlinks href=#hl-1-55> 55</a>
</span><span class=lnt id=hl-1-56><a class=lnlinks href=#hl-1-56> 56</a>
</span><span class=lnt id=hl-1-57><a class=lnlinks href=#hl-1-57> 57</a>
</span><span class=lnt id=hl-1-58><a class=lnlinks href=#hl-1-58> 58</a>
</span><span class=lnt id=hl-1-59><a class=lnlinks href=#hl-1-59> 59</a>
</span><span class=lnt id=hl-1-60><a class=lnlinks href=#hl-1-60> 60</a>
</span><span class=lnt id=hl-1-61><a class=lnlinks href=#hl-1-61> 61</a>
</span><span class=lnt id=hl-1-62><a class=lnlinks href=#hl-1-62> 62</a>
</span><span class=lnt id=hl-1-63><a class=lnlinks href=#hl-1-63> 63</a>
</span><span class=lnt id=hl-1-64><a class=lnlinks href=#hl-1-64> 64</a>
</span><span class=lnt id=hl-1-65><a class=lnlinks href=#hl-1-65> 65</a>
</span><span class=lnt id=hl-1-66><a class=lnlinks href=#hl-1-66> 66</a>
</span><span class=lnt id=hl-1-67><a class=lnlinks href=#hl-1-67> 67</a>
</span><span class=lnt id=hl-1-68><a class=lnlinks href=#hl-1-68> 68</a>
</span><span class=lnt id=hl-1-69><a class=lnlinks href=#hl-1-69> 69</a>
</span><span class=lnt id=hl-1-70><a class=lnlinks href=#hl-1-70> 70</a>
</span><span class=lnt id=hl-1-71><a class=lnlinks href=#hl-1-71> 71</a>
</span><span class=lnt id=hl-1-72><a class=lnlinks href=#hl-1-72> 72</a>
</span><span class=lnt id=hl-1-73><a class=lnlinks href=#hl-1-73> 73</a>
</span><span class=lnt id=hl-1-74><a class=lnlinks href=#hl-1-74> 74</a>
</span><span class=lnt id=hl-1-75><a class=lnlinks href=#hl-1-75> 75</a>
</span><span class=lnt id=hl-1-76><a class=lnlinks href=#hl-1-76> 76</a>
</span><span class=lnt id=hl-1-77><a class=lnlinks href=#hl-1-77> 77</a>
</span><span class=lnt id=hl-1-78><a class=lnlinks href=#hl-1-78> 78</a>
</span><span class=lnt id=hl-1-79><a class=lnlinks href=#hl-1-79> 79</a>
</span><span class=lnt id=hl-1-80><a class=lnlinks href=#hl-1-80> 80</a>
</span><span class=lnt id=hl-1-81><a class=lnlinks href=#hl-1-81> 81</a>
</span><span class=lnt id=hl-1-82><a class=lnlinks href=#hl-1-82> 82</a>
</span><span class=lnt id=hl-1-83><a class=lnlinks href=#hl-1-83> 83</a>
</span><span class=lnt id=hl-1-84><a class=lnlinks href=#hl-1-84> 84</a>
</span><span class=lnt id=hl-1-85><a class=lnlinks href=#hl-1-85> 85</a>
</span><span class=lnt id=hl-1-86><a class=lnlinks href=#hl-1-86> 86</a>
</span><span class=lnt id=hl-1-87><a class=lnlinks href=#hl-1-87> 87</a>
</span><span class=lnt id=hl-1-88><a class=lnlinks href=#hl-1-88> 88</a>
</span><span class=lnt id=hl-1-89><a class=lnlinks href=#hl-1-89> 89</a>
</span><span class=lnt id=hl-1-90><a class=lnlinks href=#hl-1-90> 90</a>
</span><span class=lnt id=hl-1-91><a class=lnlinks href=#hl-1-91> 91</a>
</span><span class=lnt id=hl-1-92><a class=lnlinks href=#hl-1-92> 92</a>
</span><span class=lnt id=hl-1-93><a class=lnlinks href=#hl-1-93> 93</a>
</span><span class=lnt id=hl-1-94><a class=lnlinks href=#hl-1-94> 94</a>
</span><span class=lnt id=hl-1-95><a class=lnlinks href=#hl-1-95> 95</a>
</span><span class=lnt id=hl-1-96><a class=lnlinks href=#hl-1-96> 96</a>
</span><span class=lnt id=hl-1-97><a class=lnlinks href=#hl-1-97> 97</a>
</span><span class=lnt id=hl-1-98><a class=lnlinks href=#hl-1-98> 98</a>
</span><span class=lnt id=hl-1-99><a class=lnlinks href=#hl-1-99> 99</a>
</span><span class=lnt id=hl-1-100><a class=lnlinks href=#hl-1-100>100</a>
</span><span class=lnt id=hl-1-101><a class=lnlinks href=#hl-1-101>101</a>
</span><span class=lnt id=hl-1-102><a class=lnlinks href=#hl-1-102>102</a>
</span><span class=lnt id=hl-1-103><a class=lnlinks href=#hl-1-103>103</a>
</span><span class=lnt id=hl-1-104><a class=lnlinks href=#hl-1-104>104</a>
</span><span class=lnt id=hl-1-105><a class=lnlinks href=#hl-1-105>105</a>
</span><span class=lnt id=hl-1-106><a class=lnlinks href=#hl-1-106>106</a>
</span><span class=lnt id=hl-1-107><a class=lnlinks href=#hl-1-107>107</a>
</span><span class=lnt id=hl-1-108><a class=lnlinks href=#hl-1-108>108</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>ChanBroker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Content</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Subscriber</span> <span class=kd>chan</span> <span class=nx>Content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ChanBroker</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>RegSub</span>      <span class=kd>chan</span> <span class=nx>Subscriber</span>
</span></span><span class=line><span class=cl>    <span class=nx>UnRegSub</span>    <span class=kd>chan</span> <span class=nx>Subscriber</span>
</span></span><span class=line><span class=cl>    <span class=nx>Contents</span>    <span class=kd>chan</span> <span class=nx>Content</span>
</span></span><span class=line><span class=cl>    <span class=nx>Stop</span>        <span class=kd>chan</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>exit</span>        <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>Subscribers</span> <span class=kd>map</span><span class=p>[</span><span class=nx>Subscriber</span><span class=p>]</span><span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>lock</span>        <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>    <span class=nx>timeout</span>     <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewChanBroker</span><span class=p>(</span><span class=nx>timeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=o>*</span><span class=nx>ChanBroker</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>ChanBroker</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>RegSub</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>UnRegSub</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Contents</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Stop</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>exit</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>Subscriber</span><span class=p>]</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>timeout</span> <span class=p>=</span> <span class=nx>timeout</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>ChanBroker</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// Broker goroutine 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>content</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Contents</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// Pusher goroutine 
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>case</span> <span class=nx>sub</span> <span class=o>&lt;-</span> <span class=nx>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>sub</span><span class=p>,</span> <span class=s>&#34;time out &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>}()</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>RegSub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>[</span><span class=nx>sub</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>UnRegSub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nb>delete</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nb>close</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span> <span class=c1>// may be close of closed channel
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>self</span><span class=p>.</span><span class=nx>exit</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>self</span><span class=p>.</span><span class=nx>exit</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>                    <span class=nb>close</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nb>delete</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span> <span class=c1>// 必须先删除再close
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nb>close</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=c1>// exit goroutine
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>RegSubscriber</span><span class=p>(</span><span class=nx>size</span> <span class=kt>uint</span><span class=p>)</span> <span class=nx>Subscriber</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>self</span><span class=p>.</span><span class=nx>exit</span> <span class=o>==</span> <span class=kc>true</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>sub</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>Subscriber</span><span class=p>,</span> <span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>self</span><span class=p>.</span><span class=nx>RegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span> <span class=c1>// maybe block
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>sub</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>UnRegSubscriber</span><span class=p>(</span><span class=nx>sub</span> <span class=nx>Subscriber</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>self</span><span class=p>.</span><span class=nx>exit</span> <span class=o>==</span> <span class=kc>true</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>self</span><span class=p>.</span><span class=nx>UnRegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span> <span class=c1>// maybe block
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>StopPublish</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>self</span><span class=p>.</span><span class=nx>exit</span> <span class=o>==</span> <span class=kc>true</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span> <span class=o>&lt;-</span> <span class=kc>true</span> <span class=c1>// maybe panic
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>PubContent</span><span class=p>(</span><span class=nx>c</span> <span class=nx>Content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>self</span><span class=p>.</span><span class=nx>Contents</span> <span class=o>&lt;-</span> <span class=nx>c</span> <span class=c1>// maybe block
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>存在以下问题，具体如下：</p><h4 id=问题1存在-panicclose-of-closed-channel的风险>问题1：存在 panic:close of closed channel的风险<a hidden class=anchor aria-hidden=true href=#问题1存在-panicclose-of-closed-channel的风险>#</a></h4><p><strong>问题描述</strong>：</p><p>如果Subscriber goroutine两次调用UnRegSubscriber，就会发生close of closed channel，导致panic</p><p>相应代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>  case sub := &lt;-self.UnRegSub:
</span></span><span class=line><span class=cl>                self.lock.Lock()
</span></span><span class=line><span class=cl>                delete(self.Subscribers, sub)
</span></span><span class=line><span class=cl>                self.lock.Unlock()
</span></span><span class=line><span class=cl>                close(sub) // may be close of closed channel
</span></span></code></pre></td></tr></table></div></div><p><strong>解决思路</strong>：</p><p>很简单，关闭前检查Subscriber对应channel是否订阅map当中，代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4>4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5>5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6>6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7>7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>case sub := &lt;-self.UnRegSub:
</span></span><span class=line><span class=cl>                self.lock.Lock()
</span></span><span class=line><span class=cl>                _, ok := self.Subscribers[sub]
</span></span><span class=line><span class=cl>                if ok {
</span></span><span class=line><span class=cl>                    delete(self.Subscribers, sub)
</span></span><span class=line><span class=cl>                    close(sub)
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>                self.lock.Unlock()
</span></span></code></pre></td></tr></table></div></div><h4 id=问题2不靠谱的exit标记>问题2：不靠谱的exit标记<a hidden class=anchor aria-hidden=true href=#问题2不靠谱的exit标记>#</a></h4><p><strong>问题描述</strong>：</p><p>exit标记不能同步goroutines对Stop通道的写操作与关闭操作，具体分析如下：</p><p>写操作代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2>2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3>3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4>4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5>5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6>6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7>7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (self *ChanBroker) RegSubscriber(size uint) Subscriber {
</span></span><span class=line><span class=cl>    if self.exit == true {
</span></span><span class=line><span class=cl>        return nil
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    sub := make(Subscriber, size)
</span></span><span class=line><span class=cl>    self.RegSub &lt;- sub // maybe block
</span></span><span class=line><span class=cl>    return sub
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>关闭操作代码段如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> case &lt;-self.Stop:
</span></span><span class=line><span class=cl>                if self.exit == false {
</span></span><span class=line><span class=cl>                    self.exit = true
</span></span><span class=line><span class=cl>                    close(self.Stop)
</span></span><span class=line><span class=cl>                    self.lock.Lock()
</span></span><span class=line><span class=cl>                    for sub := range self.Subscribers {
</span></span><span class=line><span class=cl>                        delete(self.Subscribers, sub) // 必须先删除再close
</span></span><span class=line><span class=cl>                        close(sub)
</span></span><span class=line><span class=cl>                    }
</span></span><span class=line><span class=cl>                    self.lock.Unlock()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    return // exit goroutine
</span></span><span class=line><span class=cl>                }
</span></span></code></pre></td></tr></table></div></div><p>在多核多个goroutine并发情况，极小概率会发生如下情况：</p><ol><li>某同一个时刻，CPU0 运行RegSubscriber goroutine检查exit标记为false，CPU0继续运行，CPU1运行到关闭操作代码段第1行，继续运行</li><li>CPU0 继续运行RegSubscriber goroutine，直到阻塞在第6行, 切换运行其他goroutine，CPU 1 关闭Stop Channel,并退出broken goroutine</li><li>CPU0 继续运行其他goroutine，RegSubscriber goroutine一直阻塞在第6行,等待 broken goroutine 读Stop channel</li><li>CPU0 继续执行其他goroutine，RegSubscriber goroutine一直阻塞在第6行，,等待 broken goroutine 读Stop channel</li><li>CPU0 继续执行其他goroutine，RegSubscriber goroutine一直阻塞在第6行，,等待 broken goroutine 读Stop channel</li><li>&mldr;</li></ol><p><strong>解决思路</strong>：</p><p>不用exit标记了，将状态关联到Stop Channel状态上（这又掉到另一个坑里）</p><h4 id=问题3不能保证subscribers有序的接收消息>问题3：不能保证Subscribers有序的接收消息<a hidden class=anchor aria-hidden=true href=#问题3不能保证subscribers有序的接收消息>#</a></h4><p><strong>问题描述</strong>：</p><p>版本2中每接收一个Content都会启动一个Push goroutine,这些Push goroutine执行是无序执行的，有序的内容推送需求遇上了无序的goroutine，自然有问题了</p><p><strong>解决思路</strong>：</p><p>方案1：无序推送，由Content自身加上序号，同时由各个Subscriber处理逻辑根据序号保证有序处理Content</p><p>方案2：每一个Subcriber有一个Content队列，保证有序推送，简化各个Subscriber处理逻辑，具体实现见版本5</p><h3 id=版本3>版本3<a hidden class=anchor aria-hidden=true href=#版本3>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1>  1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2>  2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3>  3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4>  4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5>  5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6>  6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7>  7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8>  8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9>  9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10> 10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11> 11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12> 12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13> 13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14> 14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15> 15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16> 16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17> 17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18> 18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19> 19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20> 20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21> 21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22> 22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23> 23</a>
</span><span class=lnt id=hl-6-24><a class=lnlinks href=#hl-6-24> 24</a>
</span><span class=lnt id=hl-6-25><a class=lnlinks href=#hl-6-25> 25</a>
</span><span class=lnt id=hl-6-26><a class=lnlinks href=#hl-6-26> 26</a>
</span><span class=lnt id=hl-6-27><a class=lnlinks href=#hl-6-27> 27</a>
</span><span class=lnt id=hl-6-28><a class=lnlinks href=#hl-6-28> 28</a>
</span><span class=lnt id=hl-6-29><a class=lnlinks href=#hl-6-29> 29</a>
</span><span class=lnt id=hl-6-30><a class=lnlinks href=#hl-6-30> 30</a>
</span><span class=lnt id=hl-6-31><a class=lnlinks href=#hl-6-31> 31</a>
</span><span class=lnt id=hl-6-32><a class=lnlinks href=#hl-6-32> 32</a>
</span><span class=lnt id=hl-6-33><a class=lnlinks href=#hl-6-33> 33</a>
</span><span class=lnt id=hl-6-34><a class=lnlinks href=#hl-6-34> 34</a>
</span><span class=lnt id=hl-6-35><a class=lnlinks href=#hl-6-35> 35</a>
</span><span class=lnt id=hl-6-36><a class=lnlinks href=#hl-6-36> 36</a>
</span><span class=lnt id=hl-6-37><a class=lnlinks href=#hl-6-37> 37</a>
</span><span class=lnt id=hl-6-38><a class=lnlinks href=#hl-6-38> 38</a>
</span><span class=lnt id=hl-6-39><a class=lnlinks href=#hl-6-39> 39</a>
</span><span class=lnt id=hl-6-40><a class=lnlinks href=#hl-6-40> 40</a>
</span><span class=lnt id=hl-6-41><a class=lnlinks href=#hl-6-41> 41</a>
</span><span class=lnt id=hl-6-42><a class=lnlinks href=#hl-6-42> 42</a>
</span><span class=lnt id=hl-6-43><a class=lnlinks href=#hl-6-43> 43</a>
</span><span class=lnt id=hl-6-44><a class=lnlinks href=#hl-6-44> 44</a>
</span><span class=lnt id=hl-6-45><a class=lnlinks href=#hl-6-45> 45</a>
</span><span class=lnt id=hl-6-46><a class=lnlinks href=#hl-6-46> 46</a>
</span><span class=lnt id=hl-6-47><a class=lnlinks href=#hl-6-47> 47</a>
</span><span class=lnt id=hl-6-48><a class=lnlinks href=#hl-6-48> 48</a>
</span><span class=lnt id=hl-6-49><a class=lnlinks href=#hl-6-49> 49</a>
</span><span class=lnt id=hl-6-50><a class=lnlinks href=#hl-6-50> 50</a>
</span><span class=lnt id=hl-6-51><a class=lnlinks href=#hl-6-51> 51</a>
</span><span class=lnt id=hl-6-52><a class=lnlinks href=#hl-6-52> 52</a>
</span><span class=lnt id=hl-6-53><a class=lnlinks href=#hl-6-53> 53</a>
</span><span class=lnt id=hl-6-54><a class=lnlinks href=#hl-6-54> 54</a>
</span><span class=lnt id=hl-6-55><a class=lnlinks href=#hl-6-55> 55</a>
</span><span class=lnt id=hl-6-56><a class=lnlinks href=#hl-6-56> 56</a>
</span><span class=lnt id=hl-6-57><a class=lnlinks href=#hl-6-57> 57</a>
</span><span class=lnt id=hl-6-58><a class=lnlinks href=#hl-6-58> 58</a>
</span><span class=lnt id=hl-6-59><a class=lnlinks href=#hl-6-59> 59</a>
</span><span class=lnt id=hl-6-60><a class=lnlinks href=#hl-6-60> 60</a>
</span><span class=lnt id=hl-6-61><a class=lnlinks href=#hl-6-61> 61</a>
</span><span class=lnt id=hl-6-62><a class=lnlinks href=#hl-6-62> 62</a>
</span><span class=lnt id=hl-6-63><a class=lnlinks href=#hl-6-63> 63</a>
</span><span class=lnt id=hl-6-64><a class=lnlinks href=#hl-6-64> 64</a>
</span><span class=lnt id=hl-6-65><a class=lnlinks href=#hl-6-65> 65</a>
</span><span class=lnt id=hl-6-66><a class=lnlinks href=#hl-6-66> 66</a>
</span><span class=lnt id=hl-6-67><a class=lnlinks href=#hl-6-67> 67</a>
</span><span class=lnt id=hl-6-68><a class=lnlinks href=#hl-6-68> 68</a>
</span><span class=lnt id=hl-6-69><a class=lnlinks href=#hl-6-69> 69</a>
</span><span class=lnt id=hl-6-70><a class=lnlinks href=#hl-6-70> 70</a>
</span><span class=lnt id=hl-6-71><a class=lnlinks href=#hl-6-71> 71</a>
</span><span class=lnt id=hl-6-72><a class=lnlinks href=#hl-6-72> 72</a>
</span><span class=lnt id=hl-6-73><a class=lnlinks href=#hl-6-73> 73</a>
</span><span class=lnt id=hl-6-74><a class=lnlinks href=#hl-6-74> 74</a>
</span><span class=lnt id=hl-6-75><a class=lnlinks href=#hl-6-75> 75</a>
</span><span class=lnt id=hl-6-76><a class=lnlinks href=#hl-6-76> 76</a>
</span><span class=lnt id=hl-6-77><a class=lnlinks href=#hl-6-77> 77</a>
</span><span class=lnt id=hl-6-78><a class=lnlinks href=#hl-6-78> 78</a>
</span><span class=lnt id=hl-6-79><a class=lnlinks href=#hl-6-79> 79</a>
</span><span class=lnt id=hl-6-80><a class=lnlinks href=#hl-6-80> 80</a>
</span><span class=lnt id=hl-6-81><a class=lnlinks href=#hl-6-81> 81</a>
</span><span class=lnt id=hl-6-82><a class=lnlinks href=#hl-6-82> 82</a>
</span><span class=lnt id=hl-6-83><a class=lnlinks href=#hl-6-83> 83</a>
</span><span class=lnt id=hl-6-84><a class=lnlinks href=#hl-6-84> 84</a>
</span><span class=lnt id=hl-6-85><a class=lnlinks href=#hl-6-85> 85</a>
</span><span class=lnt id=hl-6-86><a class=lnlinks href=#hl-6-86> 86</a>
</span><span class=lnt id=hl-6-87><a class=lnlinks href=#hl-6-87> 87</a>
</span><span class=lnt id=hl-6-88><a class=lnlinks href=#hl-6-88> 88</a>
</span><span class=lnt id=hl-6-89><a class=lnlinks href=#hl-6-89> 89</a>
</span><span class=lnt id=hl-6-90><a class=lnlinks href=#hl-6-90> 90</a>
</span><span class=lnt id=hl-6-91><a class=lnlinks href=#hl-6-91> 91</a>
</span><span class=lnt id=hl-6-92><a class=lnlinks href=#hl-6-92> 92</a>
</span><span class=lnt id=hl-6-93><a class=lnlinks href=#hl-6-93> 93</a>
</span><span class=lnt id=hl-6-94><a class=lnlinks href=#hl-6-94> 94</a>
</span><span class=lnt id=hl-6-95><a class=lnlinks href=#hl-6-95> 95</a>
</span><span class=lnt id=hl-6-96><a class=lnlinks href=#hl-6-96> 96</a>
</span><span class=lnt id=hl-6-97><a class=lnlinks href=#hl-6-97> 97</a>
</span><span class=lnt id=hl-6-98><a class=lnlinks href=#hl-6-98> 98</a>
</span><span class=lnt id=hl-6-99><a class=lnlinks href=#hl-6-99> 99</a>
</span><span class=lnt id=hl-6-100><a class=lnlinks href=#hl-6-100>100</a>
</span><span class=lnt id=hl-6-101><a class=lnlinks href=#hl-6-101>101</a>
</span><span class=lnt id=hl-6-102><a class=lnlinks href=#hl-6-102>102</a>
</span><span class=lnt id=hl-6-103><a class=lnlinks href=#hl-6-103>103</a>
</span><span class=lnt id=hl-6-104><a class=lnlinks href=#hl-6-104>104</a>
</span><span class=lnt id=hl-6-105><a class=lnlinks href=#hl-6-105>105</a>
</span><span class=lnt id=hl-6-106><a class=lnlinks href=#hl-6-106>106</a>
</span><span class=lnt id=hl-6-107><a class=lnlinks href=#hl-6-107>107</a>
</span><span class=lnt id=hl-6-108><a class=lnlinks href=#hl-6-108>108</a>
</span><span class=lnt id=hl-6-109><a class=lnlinks href=#hl-6-109>109</a>
</span><span class=lnt id=hl-6-110><a class=lnlinks href=#hl-6-110>110</a>
</span><span class=lnt id=hl-6-111><a class=lnlinks href=#hl-6-111>111</a>
</span><span class=lnt id=hl-6-112><a class=lnlinks href=#hl-6-112>112</a>
</span><span class=lnt id=hl-6-113><a class=lnlinks href=#hl-6-113>113</a>
</span><span class=lnt id=hl-6-114><a class=lnlinks href=#hl-6-114>114</a>
</span><span class=lnt id=hl-6-115><a class=lnlinks href=#hl-6-115>115</a>
</span><span class=lnt id=hl-6-116><a class=lnlinks href=#hl-6-116>116</a>
</span><span class=lnt id=hl-6-117><a class=lnlinks href=#hl-6-117>117</a>
</span><span class=lnt id=hl-6-118><a class=lnlinks href=#hl-6-118>118</a>
</span><span class=lnt id=hl-6-119><a class=lnlinks href=#hl-6-119>119</a>
</span><span class=lnt id=hl-6-120><a class=lnlinks href=#hl-6-120>120</a>
</span><span class=lnt id=hl-6-121><a class=lnlinks href=#hl-6-121>121</a>
</span><span class=lnt id=hl-6-122><a class=lnlinks href=#hl-6-122>122</a>
</span><span class=lnt id=hl-6-123><a class=lnlinks href=#hl-6-123>123</a>
</span><span class=lnt id=hl-6-124><a class=lnlinks href=#hl-6-124>124</a>
</span><span class=lnt id=hl-6-125><a class=lnlinks href=#hl-6-125>125</a>
</span><span class=lnt id=hl-6-126><a class=lnlinks href=#hl-6-126>126</a>
</span><span class=lnt id=hl-6-127><a class=lnlinks href=#hl-6-127>127</a>
</span><span class=lnt id=hl-6-128><a class=lnlinks href=#hl-6-128>128</a>
</span><span class=lnt id=hl-6-129><a class=lnlinks href=#hl-6-129>129</a>
</span><span class=lnt id=hl-6-130><a class=lnlinks href=#hl-6-130>130</a>
</span><span class=lnt id=hl-6-131><a class=lnlinks href=#hl-6-131>131</a>
</span><span class=lnt id=hl-6-132><a class=lnlinks href=#hl-6-132>132</a>
</span><span class=lnt id=hl-6-133><a class=lnlinks href=#hl-6-133>133</a>
</span><span class=lnt id=hl-6-134><a class=lnlinks href=#hl-6-134>134</a>
</span><span class=lnt id=hl-6-135><a class=lnlinks href=#hl-6-135>135</a>
</span><span class=lnt id=hl-6-136><a class=lnlinks href=#hl-6-136>136</a>
</span><span class=lnt id=hl-6-137><a class=lnlinks href=#hl-6-137>137</a>
</span><span class=lnt id=hl-6-138><a class=lnlinks href=#hl-6-138>138</a>
</span><span class=lnt id=hl-6-139><a class=lnlinks href=#hl-6-139>139</a>
</span><span class=lnt id=hl-6-140><a class=lnlinks href=#hl-6-140>140</a>
</span><span class=lnt id=hl-6-141><a class=lnlinks href=#hl-6-141>141</a>
</span><span class=lnt id=hl-6-142><a class=lnlinks href=#hl-6-142>142</a>
</span><span class=lnt id=hl-6-143><a class=lnlinks href=#hl-6-143>143</a>
</span><span class=lnt id=hl-6-144><a class=lnlinks href=#hl-6-144>144</a>
</span><span class=lnt id=hl-6-145><a class=lnlinks href=#hl-6-145>145</a>
</span><span class=lnt id=hl-6-146><a class=lnlinks href=#hl-6-146>146</a>
</span><span class=lnt id=hl-6-147><a class=lnlinks href=#hl-6-147>147</a>
</span><span class=lnt id=hl-6-148><a class=lnlinks href=#hl-6-148>148</a>
</span><span class=lnt id=hl-6-149><a class=lnlinks href=#hl-6-149>149</a>
</span><span class=lnt id=hl-6-150><a class=lnlinks href=#hl-6-150>150</a>
</span><span class=lnt id=hl-6-151><a class=lnlinks href=#hl-6-151>151</a>
</span><span class=lnt id=hl-6-152><a class=lnlinks href=#hl-6-152>152</a>
</span><span class=lnt id=hl-6-153><a class=lnlinks href=#hl-6-153>153</a>
</span><span class=lnt id=hl-6-154><a class=lnlinks href=#hl-6-154>154</a>
</span><span class=lnt id=hl-6-155><a class=lnlinks href=#hl-6-155>155</a>
</span><span class=lnt id=hl-6-156><a class=lnlinks href=#hl-6-156>156</a>
</span><span class=lnt id=hl-6-157><a class=lnlinks href=#hl-6-157>157</a>
</span><span class=lnt id=hl-6-158><a class=lnlinks href=#hl-6-158>158</a>
</span><span class=lnt id=hl-6-159><a class=lnlinks href=#hl-6-159>159</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>ChanBroker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Content</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Subscriber</span> <span class=kd>chan</span> <span class=nx>Content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ChanBroker</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>RegSub</span>      <span class=kd>chan</span> <span class=nx>Subscriber</span>
</span></span><span class=line><span class=cl>    <span class=nx>UnRegSub</span>    <span class=kd>chan</span> <span class=nx>Subscriber</span>
</span></span><span class=line><span class=cl>    <span class=nx>Contents</span>    <span class=kd>chan</span> <span class=nx>Content</span>
</span></span><span class=line><span class=cl>    <span class=nx>Stop</span>        <span class=kd>chan</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>exit</span>        <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>Subscribers</span> <span class=kd>map</span><span class=p>[</span><span class=nx>Subscriber</span><span class=p>]</span><span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>lock</span>        <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>    <span class=nx>timeout</span>     <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>errBrokerExit</span> <span class=kt>error</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;Broker exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>errTimeOut</span> <span class=kt>error</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;Time out&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewChanBroker</span><span class=p>(</span><span class=nx>timeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=o>*</span><span class=nx>ChanBroker</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>ChanBroker</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>RegSub</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>UnRegSub</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Contents</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Stop</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>exit</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>Subscriber</span><span class=p>]</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>timeout</span> <span class=p>=</span> <span class=nx>timeout</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>ChanBroker</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>content</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Contents</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>case</span> <span class=nx>sub</span> <span class=o>&lt;-</span> <span class=nx>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>sub</span><span class=p>,</span> <span class=s>&#34;time out &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>RegSub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>[</span><span class=nx>sub</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>UnRegSub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>[</span><span class=nx>sub</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nb>delete</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nb>close</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>close</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nb>delete</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nb>close</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=c1>// exit goroutine
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>RegSubscriber</span><span class=p>(</span><span class=nx>size</span> <span class=kt>uint</span><span class=p>)</span> <span class=p>(</span><span class=nx>Subscriber</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>ok</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errBrokerExit</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>sub</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>Subscriber</span><span class=p>,</span> <span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>self</span><span class=p>.</span><span class=nx>RegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>sub</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errTimeOut</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>sub</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>Subscriber</span><span class=p>,</span> <span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>RegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>sub</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>UnRegSubscriber</span><span class=p>(</span><span class=nx>sub</span> <span class=nx>Subscriber</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>ok</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>self</span><span class=p>.</span><span class=nx>UnRegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>UnRegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>StopPublish</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>ok</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span> <span class=o>&lt;-</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span> <span class=o>&lt;-</span> <span class=kc>true</span> 
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>PubContent</span><span class=p>(</span><span class=nx>c</span> <span class=nx>Content</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>ok</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>errBrokerExit</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>self</span><span class=p>.</span><span class=nx>Contents</span> <span class=o>&lt;-</span> <span class=nx>c</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>errTimeOut</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>Contents</span> <span class=o>&lt;-</span> <span class=nx>c</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>存在以下问题，具体如下：</p><h4 id=问题1-读channel出现错误的竞争>问题1： 读channel出现错误的竞争<a hidden class=anchor aria-hidden=true href=#问题1-读channel出现错误的竞争>#</a></h4><p><strong>问题描述</strong>：</p><p>版本3的一个错误的方案选择，导致Stop Channel出现读竞争，导致不能停止发布，出现goroutine leak，分析如下：</p><ol><li>Stop Channel 只会写一次</li><li>Stop Channel 却有多个读goroutine</li><li>基于上面有情况，并不能保证Broker goroutine 能收到停止发布的信息，如果被其他goroutine收到，导致Broker goroutine收不到结束消息，进而不能关闭所有Subscriber，导致所有Subscriber goroutine泄露</li></ol><p><strong>解决思路</strong>：</p><p>版本3引入关闭状态是一个错误的设计，引入状态，也就引入对依赖状态的对象，增加了代码的复杂性，状态的维护容易导致bug，在设计与代码应当追求无状态设计（好处多多）, 这里采用超时来解决，如果超时用由调用者确定处理策略</p><h3 id=版本4>版本4<a hidden class=anchor aria-hidden=true href=#版本4>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>  1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>  2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>  3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>  4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5>  5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6>  6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7>  7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8>  8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9>  9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10> 10</a>
</span><span class=lnt id=hl-7-11><a class=lnlinks href=#hl-7-11> 11</a>
</span><span class=lnt id=hl-7-12><a class=lnlinks href=#hl-7-12> 12</a>
</span><span class=lnt id=hl-7-13><a class=lnlinks href=#hl-7-13> 13</a>
</span><span class=lnt id=hl-7-14><a class=lnlinks href=#hl-7-14> 14</a>
</span><span class=lnt id=hl-7-15><a class=lnlinks href=#hl-7-15> 15</a>
</span><span class=lnt id=hl-7-16><a class=lnlinks href=#hl-7-16> 16</a>
</span><span class=lnt id=hl-7-17><a class=lnlinks href=#hl-7-17> 17</a>
</span><span class=lnt id=hl-7-18><a class=lnlinks href=#hl-7-18> 18</a>
</span><span class=lnt id=hl-7-19><a class=lnlinks href=#hl-7-19> 19</a>
</span><span class=lnt id=hl-7-20><a class=lnlinks href=#hl-7-20> 20</a>
</span><span class=lnt id=hl-7-21><a class=lnlinks href=#hl-7-21> 21</a>
</span><span class=lnt id=hl-7-22><a class=lnlinks href=#hl-7-22> 22</a>
</span><span class=lnt id=hl-7-23><a class=lnlinks href=#hl-7-23> 23</a>
</span><span class=lnt id=hl-7-24><a class=lnlinks href=#hl-7-24> 24</a>
</span><span class=lnt id=hl-7-25><a class=lnlinks href=#hl-7-25> 25</a>
</span><span class=lnt id=hl-7-26><a class=lnlinks href=#hl-7-26> 26</a>
</span><span class=lnt id=hl-7-27><a class=lnlinks href=#hl-7-27> 27</a>
</span><span class=lnt id=hl-7-28><a class=lnlinks href=#hl-7-28> 28</a>
</span><span class=lnt id=hl-7-29><a class=lnlinks href=#hl-7-29> 29</a>
</span><span class=lnt id=hl-7-30><a class=lnlinks href=#hl-7-30> 30</a>
</span><span class=lnt id=hl-7-31><a class=lnlinks href=#hl-7-31> 31</a>
</span><span class=lnt id=hl-7-32><a class=lnlinks href=#hl-7-32> 32</a>
</span><span class=lnt id=hl-7-33><a class=lnlinks href=#hl-7-33> 33</a>
</span><span class=lnt id=hl-7-34><a class=lnlinks href=#hl-7-34> 34</a>
</span><span class=lnt id=hl-7-35><a class=lnlinks href=#hl-7-35> 35</a>
</span><span class=lnt id=hl-7-36><a class=lnlinks href=#hl-7-36> 36</a>
</span><span class=lnt id=hl-7-37><a class=lnlinks href=#hl-7-37> 37</a>
</span><span class=lnt id=hl-7-38><a class=lnlinks href=#hl-7-38> 38</a>
</span><span class=lnt id=hl-7-39><a class=lnlinks href=#hl-7-39> 39</a>
</span><span class=lnt id=hl-7-40><a class=lnlinks href=#hl-7-40> 40</a>
</span><span class=lnt id=hl-7-41><a class=lnlinks href=#hl-7-41> 41</a>
</span><span class=lnt id=hl-7-42><a class=lnlinks href=#hl-7-42> 42</a>
</span><span class=lnt id=hl-7-43><a class=lnlinks href=#hl-7-43> 43</a>
</span><span class=lnt id=hl-7-44><a class=lnlinks href=#hl-7-44> 44</a>
</span><span class=lnt id=hl-7-45><a class=lnlinks href=#hl-7-45> 45</a>
</span><span class=lnt id=hl-7-46><a class=lnlinks href=#hl-7-46> 46</a>
</span><span class=lnt id=hl-7-47><a class=lnlinks href=#hl-7-47> 47</a>
</span><span class=lnt id=hl-7-48><a class=lnlinks href=#hl-7-48> 48</a>
</span><span class=lnt id=hl-7-49><a class=lnlinks href=#hl-7-49> 49</a>
</span><span class=lnt id=hl-7-50><a class=lnlinks href=#hl-7-50> 50</a>
</span><span class=lnt id=hl-7-51><a class=lnlinks href=#hl-7-51> 51</a>
</span><span class=lnt id=hl-7-52><a class=lnlinks href=#hl-7-52> 52</a>
</span><span class=lnt id=hl-7-53><a class=lnlinks href=#hl-7-53> 53</a>
</span><span class=lnt id=hl-7-54><a class=lnlinks href=#hl-7-54> 54</a>
</span><span class=lnt id=hl-7-55><a class=lnlinks href=#hl-7-55> 55</a>
</span><span class=lnt id=hl-7-56><a class=lnlinks href=#hl-7-56> 56</a>
</span><span class=lnt id=hl-7-57><a class=lnlinks href=#hl-7-57> 57</a>
</span><span class=lnt id=hl-7-58><a class=lnlinks href=#hl-7-58> 58</a>
</span><span class=lnt id=hl-7-59><a class=lnlinks href=#hl-7-59> 59</a>
</span><span class=lnt id=hl-7-60><a class=lnlinks href=#hl-7-60> 60</a>
</span><span class=lnt id=hl-7-61><a class=lnlinks href=#hl-7-61> 61</a>
</span><span class=lnt id=hl-7-62><a class=lnlinks href=#hl-7-62> 62</a>
</span><span class=lnt id=hl-7-63><a class=lnlinks href=#hl-7-63> 63</a>
</span><span class=lnt id=hl-7-64><a class=lnlinks href=#hl-7-64> 64</a>
</span><span class=lnt id=hl-7-65><a class=lnlinks href=#hl-7-65> 65</a>
</span><span class=lnt id=hl-7-66><a class=lnlinks href=#hl-7-66> 66</a>
</span><span class=lnt id=hl-7-67><a class=lnlinks href=#hl-7-67> 67</a>
</span><span class=lnt id=hl-7-68><a class=lnlinks href=#hl-7-68> 68</a>
</span><span class=lnt id=hl-7-69><a class=lnlinks href=#hl-7-69> 69</a>
</span><span class=lnt id=hl-7-70><a class=lnlinks href=#hl-7-70> 70</a>
</span><span class=lnt id=hl-7-71><a class=lnlinks href=#hl-7-71> 71</a>
</span><span class=lnt id=hl-7-72><a class=lnlinks href=#hl-7-72> 72</a>
</span><span class=lnt id=hl-7-73><a class=lnlinks href=#hl-7-73> 73</a>
</span><span class=lnt id=hl-7-74><a class=lnlinks href=#hl-7-74> 74</a>
</span><span class=lnt id=hl-7-75><a class=lnlinks href=#hl-7-75> 75</a>
</span><span class=lnt id=hl-7-76><a class=lnlinks href=#hl-7-76> 76</a>
</span><span class=lnt id=hl-7-77><a class=lnlinks href=#hl-7-77> 77</a>
</span><span class=lnt id=hl-7-78><a class=lnlinks href=#hl-7-78> 78</a>
</span><span class=lnt id=hl-7-79><a class=lnlinks href=#hl-7-79> 79</a>
</span><span class=lnt id=hl-7-80><a class=lnlinks href=#hl-7-80> 80</a>
</span><span class=lnt id=hl-7-81><a class=lnlinks href=#hl-7-81> 81</a>
</span><span class=lnt id=hl-7-82><a class=lnlinks href=#hl-7-82> 82</a>
</span><span class=lnt id=hl-7-83><a class=lnlinks href=#hl-7-83> 83</a>
</span><span class=lnt id=hl-7-84><a class=lnlinks href=#hl-7-84> 84</a>
</span><span class=lnt id=hl-7-85><a class=lnlinks href=#hl-7-85> 85</a>
</span><span class=lnt id=hl-7-86><a class=lnlinks href=#hl-7-86> 86</a>
</span><span class=lnt id=hl-7-87><a class=lnlinks href=#hl-7-87> 87</a>
</span><span class=lnt id=hl-7-88><a class=lnlinks href=#hl-7-88> 88</a>
</span><span class=lnt id=hl-7-89><a class=lnlinks href=#hl-7-89> 89</a>
</span><span class=lnt id=hl-7-90><a class=lnlinks href=#hl-7-90> 90</a>
</span><span class=lnt id=hl-7-91><a class=lnlinks href=#hl-7-91> 91</a>
</span><span class=lnt id=hl-7-92><a class=lnlinks href=#hl-7-92> 92</a>
</span><span class=lnt id=hl-7-93><a class=lnlinks href=#hl-7-93> 93</a>
</span><span class=lnt id=hl-7-94><a class=lnlinks href=#hl-7-94> 94</a>
</span><span class=lnt id=hl-7-95><a class=lnlinks href=#hl-7-95> 95</a>
</span><span class=lnt id=hl-7-96><a class=lnlinks href=#hl-7-96> 96</a>
</span><span class=lnt id=hl-7-97><a class=lnlinks href=#hl-7-97> 97</a>
</span><span class=lnt id=hl-7-98><a class=lnlinks href=#hl-7-98> 98</a>
</span><span class=lnt id=hl-7-99><a class=lnlinks href=#hl-7-99> 99</a>
</span><span class=lnt id=hl-7-100><a class=lnlinks href=#hl-7-100>100</a>
</span><span class=lnt id=hl-7-101><a class=lnlinks href=#hl-7-101>101</a>
</span><span class=lnt id=hl-7-102><a class=lnlinks href=#hl-7-102>102</a>
</span><span class=lnt id=hl-7-103><a class=lnlinks href=#hl-7-103>103</a>
</span><span class=lnt id=hl-7-104><a class=lnlinks href=#hl-7-104>104</a>
</span><span class=lnt id=hl-7-105><a class=lnlinks href=#hl-7-105>105</a>
</span><span class=lnt id=hl-7-106><a class=lnlinks href=#hl-7-106>106</a>
</span><span class=lnt id=hl-7-107><a class=lnlinks href=#hl-7-107>107</a>
</span><span class=lnt id=hl-7-108><a class=lnlinks href=#hl-7-108>108</a>
</span><span class=lnt id=hl-7-109><a class=lnlinks href=#hl-7-109>109</a>
</span><span class=lnt id=hl-7-110><a class=lnlinks href=#hl-7-110>110</a>
</span><span class=lnt id=hl-7-111><a class=lnlinks href=#hl-7-111>111</a>
</span><span class=lnt id=hl-7-112><a class=lnlinks href=#hl-7-112>112</a>
</span><span class=lnt id=hl-7-113><a class=lnlinks href=#hl-7-113>113</a>
</span><span class=lnt id=hl-7-114><a class=lnlinks href=#hl-7-114>114</a>
</span><span class=lnt id=hl-7-115><a class=lnlinks href=#hl-7-115>115</a>
</span><span class=lnt id=hl-7-116><a class=lnlinks href=#hl-7-116>116</a>
</span><span class=lnt id=hl-7-117><a class=lnlinks href=#hl-7-117>117</a>
</span><span class=lnt id=hl-7-118><a class=lnlinks href=#hl-7-118>118</a>
</span><span class=lnt id=hl-7-119><a class=lnlinks href=#hl-7-119>119</a>
</span><span class=lnt id=hl-7-120><a class=lnlinks href=#hl-7-120>120</a>
</span><span class=lnt id=hl-7-121><a class=lnlinks href=#hl-7-121>121</a>
</span><span class=lnt id=hl-7-122><a class=lnlinks href=#hl-7-122>122</a>
</span><span class=lnt id=hl-7-123><a class=lnlinks href=#hl-7-123>123</a>
</span><span class=lnt id=hl-7-124><a class=lnlinks href=#hl-7-124>124</a>
</span><span class=lnt id=hl-7-125><a class=lnlinks href=#hl-7-125>125</a>
</span><span class=lnt id=hl-7-126><a class=lnlinks href=#hl-7-126>126</a>
</span><span class=lnt id=hl-7-127><a class=lnlinks href=#hl-7-127>127</a>
</span><span class=lnt id=hl-7-128><a class=lnlinks href=#hl-7-128>128</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>ChanBroker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Content</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Subscriber</span> <span class=kd>chan</span> <span class=nx>Content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ChanBroker</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>RegSub</span>      <span class=kd>chan</span> <span class=nx>Subscriber</span>
</span></span><span class=line><span class=cl>    <span class=nx>UnRegSub</span>    <span class=kd>chan</span> <span class=nx>Subscriber</span>
</span></span><span class=line><span class=cl>    <span class=nx>Contents</span>    <span class=kd>chan</span> <span class=nx>Content</span>
</span></span><span class=line><span class=cl>    <span class=nx>Stop</span>        <span class=kd>chan</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>exit</span>        <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>Subscribers</span> <span class=kd>map</span><span class=p>[</span><span class=nx>Subscriber</span><span class=p>]</span><span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>lock</span>        <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>    <span class=nx>timeout</span>     <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>errBrokerExit</span> <span class=kt>error</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;ChanBroker exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>errTimeOut</span> <span class=kt>error</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;ChanBroker Time out&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewChanBroker</span><span class=p>(</span><span class=nx>timeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=o>*</span><span class=nx>ChanBroker</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>ChanBroker</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>RegSub</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>UnRegSub</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Contents</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Stop</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>exit</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>Subscriber</span><span class=p>]</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nx>timeout</span> <span class=p>=</span> <span class=nx>timeout</span>
</span></span><span class=line><span class=cl>    <span class=nx>ChanBroker</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>ChanBroker</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>content</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Contents</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>case</span> <span class=nx>sub</span> <span class=o>&lt;-</span> <span class=nx>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>sub</span><span class=p>,</span> <span class=s>&#34;time out &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>RegSub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>[</span><span class=nx>sub</span><span class=p>]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>UnRegSub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>[</span><span class=nx>sub</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nb>delete</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nb>close</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// close(self.Stop)
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nb>delete</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>Subscribers</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nb>close</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=c1>// exit goroutine
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>RegSubscriber</span><span class=p>(</span><span class=nx>size</span> <span class=kt>uint</span><span class=p>)</span> <span class=p>(</span><span class=nx>Subscriber</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>sub</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>Subscriber</span><span class=p>,</span> <span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errTimeOut</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>self</span><span class=p>.</span><span class=nx>RegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>sub</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>UnRegSubscriber</span><span class=p>(</span><span class=nx>sub</span> <span class=nx>Subscriber</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>self</span><span class=p>.</span><span class=nx>UnRegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>StopPublish</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Stop</span> <span class=o>&lt;-</span> <span class=kc>true</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>errTimeOut</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>PubContent</span><span class=p>(</span><span class=nx>c</span> <span class=nx>Content</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>errTimeOut</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>self</span><span class=p>.</span><span class=nx>Contents</span> <span class=o>&lt;-</span> <span class=nx>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>存在以下问题，具体如下：</p><h4 id=问题1timeout问题>问题1：timeout问题<a hidden class=anchor aria-hidden=true href=#问题1timeout问题>#</a></h4><p><strong>问题描述：</strong></p><ol><li>timeout 导致长时间持有读锁</li><li>timeout 导致消息丢失，并没有推送成功</li><li>上一个Subscriber超时影响后面Subscriber内容的实时性</li></ol><p><strong>解决方案：</strong></p><ol><li>采用select实现channel非阻塞写</li><li>对于非阻塞写失败，加入Subscriber对应的链表</li><li>非阻塞写保证避免Subscribers之间相互影响</li></ol><h4 id=问题2锁问题>问题2：锁问题<a hidden class=anchor aria-hidden=true href=#问题2锁问题>#</a></h4><p><strong>问题描述：</strong></p><ol><li>每个Pusher goroutine持有读锁，一定情况下会成为性能的瓶颈</li></ol><p><strong>解决方案：</strong></p><ol><li>在上面避免阻塞的基础上，只有一个goroutine来推送内容</li></ol><h3 id=版本5>版本5<a hidden class=anchor aria-hidden=true href=#版本5>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>  1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2>  2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3>  3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4>  4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5>  5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6>  6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7>  7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8>  8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9>  9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10> 10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11> 11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12> 12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13> 13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14> 14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15> 15</a>
</span><span class=lnt id=hl-8-16><a class=lnlinks href=#hl-8-16> 16</a>
</span><span class=lnt id=hl-8-17><a class=lnlinks href=#hl-8-17> 17</a>
</span><span class=lnt id=hl-8-18><a class=lnlinks href=#hl-8-18> 18</a>
</span><span class=lnt id=hl-8-19><a class=lnlinks href=#hl-8-19> 19</a>
</span><span class=lnt id=hl-8-20><a class=lnlinks href=#hl-8-20> 20</a>
</span><span class=lnt id=hl-8-21><a class=lnlinks href=#hl-8-21> 21</a>
</span><span class=lnt id=hl-8-22><a class=lnlinks href=#hl-8-22> 22</a>
</span><span class=lnt id=hl-8-23><a class=lnlinks href=#hl-8-23> 23</a>
</span><span class=lnt id=hl-8-24><a class=lnlinks href=#hl-8-24> 24</a>
</span><span class=lnt id=hl-8-25><a class=lnlinks href=#hl-8-25> 25</a>
</span><span class=lnt id=hl-8-26><a class=lnlinks href=#hl-8-26> 26</a>
</span><span class=lnt id=hl-8-27><a class=lnlinks href=#hl-8-27> 27</a>
</span><span class=lnt id=hl-8-28><a class=lnlinks href=#hl-8-28> 28</a>
</span><span class=lnt id=hl-8-29><a class=lnlinks href=#hl-8-29> 29</a>
</span><span class=lnt id=hl-8-30><a class=lnlinks href=#hl-8-30> 30</a>
</span><span class=lnt id=hl-8-31><a class=lnlinks href=#hl-8-31> 31</a>
</span><span class=lnt id=hl-8-32><a class=lnlinks href=#hl-8-32> 32</a>
</span><span class=lnt id=hl-8-33><a class=lnlinks href=#hl-8-33> 33</a>
</span><span class=lnt id=hl-8-34><a class=lnlinks href=#hl-8-34> 34</a>
</span><span class=lnt id=hl-8-35><a class=lnlinks href=#hl-8-35> 35</a>
</span><span class=lnt id=hl-8-36><a class=lnlinks href=#hl-8-36> 36</a>
</span><span class=lnt id=hl-8-37><a class=lnlinks href=#hl-8-37> 37</a>
</span><span class=lnt id=hl-8-38><a class=lnlinks href=#hl-8-38> 38</a>
</span><span class=lnt id=hl-8-39><a class=lnlinks href=#hl-8-39> 39</a>
</span><span class=lnt id=hl-8-40><a class=lnlinks href=#hl-8-40> 40</a>
</span><span class=lnt id=hl-8-41><a class=lnlinks href=#hl-8-41> 41</a>
</span><span class=lnt id=hl-8-42><a class=lnlinks href=#hl-8-42> 42</a>
</span><span class=lnt id=hl-8-43><a class=lnlinks href=#hl-8-43> 43</a>
</span><span class=lnt id=hl-8-44><a class=lnlinks href=#hl-8-44> 44</a>
</span><span class=lnt id=hl-8-45><a class=lnlinks href=#hl-8-45> 45</a>
</span><span class=lnt id=hl-8-46><a class=lnlinks href=#hl-8-46> 46</a>
</span><span class=lnt id=hl-8-47><a class=lnlinks href=#hl-8-47> 47</a>
</span><span class=lnt id=hl-8-48><a class=lnlinks href=#hl-8-48> 48</a>
</span><span class=lnt id=hl-8-49><a class=lnlinks href=#hl-8-49> 49</a>
</span><span class=lnt id=hl-8-50><a class=lnlinks href=#hl-8-50> 50</a>
</span><span class=lnt id=hl-8-51><a class=lnlinks href=#hl-8-51> 51</a>
</span><span class=lnt id=hl-8-52><a class=lnlinks href=#hl-8-52> 52</a>
</span><span class=lnt id=hl-8-53><a class=lnlinks href=#hl-8-53> 53</a>
</span><span class=lnt id=hl-8-54><a class=lnlinks href=#hl-8-54> 54</a>
</span><span class=lnt id=hl-8-55><a class=lnlinks href=#hl-8-55> 55</a>
</span><span class=lnt id=hl-8-56><a class=lnlinks href=#hl-8-56> 56</a>
</span><span class=lnt id=hl-8-57><a class=lnlinks href=#hl-8-57> 57</a>
</span><span class=lnt id=hl-8-58><a class=lnlinks href=#hl-8-58> 58</a>
</span><span class=lnt id=hl-8-59><a class=lnlinks href=#hl-8-59> 59</a>
</span><span class=lnt id=hl-8-60><a class=lnlinks href=#hl-8-60> 60</a>
</span><span class=lnt id=hl-8-61><a class=lnlinks href=#hl-8-61> 61</a>
</span><span class=lnt id=hl-8-62><a class=lnlinks href=#hl-8-62> 62</a>
</span><span class=lnt id=hl-8-63><a class=lnlinks href=#hl-8-63> 63</a>
</span><span class=lnt id=hl-8-64><a class=lnlinks href=#hl-8-64> 64</a>
</span><span class=lnt id=hl-8-65><a class=lnlinks href=#hl-8-65> 65</a>
</span><span class=lnt id=hl-8-66><a class=lnlinks href=#hl-8-66> 66</a>
</span><span class=lnt id=hl-8-67><a class=lnlinks href=#hl-8-67> 67</a>
</span><span class=lnt id=hl-8-68><a class=lnlinks href=#hl-8-68> 68</a>
</span><span class=lnt id=hl-8-69><a class=lnlinks href=#hl-8-69> 69</a>
</span><span class=lnt id=hl-8-70><a class=lnlinks href=#hl-8-70> 70</a>
</span><span class=lnt id=hl-8-71><a class=lnlinks href=#hl-8-71> 71</a>
</span><span class=lnt id=hl-8-72><a class=lnlinks href=#hl-8-72> 72</a>
</span><span class=lnt id=hl-8-73><a class=lnlinks href=#hl-8-73> 73</a>
</span><span class=lnt id=hl-8-74><a class=lnlinks href=#hl-8-74> 74</a>
</span><span class=lnt id=hl-8-75><a class=lnlinks href=#hl-8-75> 75</a>
</span><span class=lnt id=hl-8-76><a class=lnlinks href=#hl-8-76> 76</a>
</span><span class=lnt id=hl-8-77><a class=lnlinks href=#hl-8-77> 77</a>
</span><span class=lnt id=hl-8-78><a class=lnlinks href=#hl-8-78> 78</a>
</span><span class=lnt id=hl-8-79><a class=lnlinks href=#hl-8-79> 79</a>
</span><span class=lnt id=hl-8-80><a class=lnlinks href=#hl-8-80> 80</a>
</span><span class=lnt id=hl-8-81><a class=lnlinks href=#hl-8-81> 81</a>
</span><span class=lnt id=hl-8-82><a class=lnlinks href=#hl-8-82> 82</a>
</span><span class=lnt id=hl-8-83><a class=lnlinks href=#hl-8-83> 83</a>
</span><span class=lnt id=hl-8-84><a class=lnlinks href=#hl-8-84> 84</a>
</span><span class=lnt id=hl-8-85><a class=lnlinks href=#hl-8-85> 85</a>
</span><span class=lnt id=hl-8-86><a class=lnlinks href=#hl-8-86> 86</a>
</span><span class=lnt id=hl-8-87><a class=lnlinks href=#hl-8-87> 87</a>
</span><span class=lnt id=hl-8-88><a class=lnlinks href=#hl-8-88> 88</a>
</span><span class=lnt id=hl-8-89><a class=lnlinks href=#hl-8-89> 89</a>
</span><span class=lnt id=hl-8-90><a class=lnlinks href=#hl-8-90> 90</a>
</span><span class=lnt id=hl-8-91><a class=lnlinks href=#hl-8-91> 91</a>
</span><span class=lnt id=hl-8-92><a class=lnlinks href=#hl-8-92> 92</a>
</span><span class=lnt id=hl-8-93><a class=lnlinks href=#hl-8-93> 93</a>
</span><span class=lnt id=hl-8-94><a class=lnlinks href=#hl-8-94> 94</a>
</span><span class=lnt id=hl-8-95><a class=lnlinks href=#hl-8-95> 95</a>
</span><span class=lnt id=hl-8-96><a class=lnlinks href=#hl-8-96> 96</a>
</span><span class=lnt id=hl-8-97><a class=lnlinks href=#hl-8-97> 97</a>
</span><span class=lnt id=hl-8-98><a class=lnlinks href=#hl-8-98> 98</a>
</span><span class=lnt id=hl-8-99><a class=lnlinks href=#hl-8-99> 99</a>
</span><span class=lnt id=hl-8-100><a class=lnlinks href=#hl-8-100>100</a>
</span><span class=lnt id=hl-8-101><a class=lnlinks href=#hl-8-101>101</a>
</span><span class=lnt id=hl-8-102><a class=lnlinks href=#hl-8-102>102</a>
</span><span class=lnt id=hl-8-103><a class=lnlinks href=#hl-8-103>103</a>
</span><span class=lnt id=hl-8-104><a class=lnlinks href=#hl-8-104>104</a>
</span><span class=lnt id=hl-8-105><a class=lnlinks href=#hl-8-105>105</a>
</span><span class=lnt id=hl-8-106><a class=lnlinks href=#hl-8-106>106</a>
</span><span class=lnt id=hl-8-107><a class=lnlinks href=#hl-8-107>107</a>
</span><span class=lnt id=hl-8-108><a class=lnlinks href=#hl-8-108>108</a>
</span><span class=lnt id=hl-8-109><a class=lnlinks href=#hl-8-109>109</a>
</span><span class=lnt id=hl-8-110><a class=lnlinks href=#hl-8-110>110</a>
</span><span class=lnt id=hl-8-111><a class=lnlinks href=#hl-8-111>111</a>
</span><span class=lnt id=hl-8-112><a class=lnlinks href=#hl-8-112>112</a>
</span><span class=lnt id=hl-8-113><a class=lnlinks href=#hl-8-113>113</a>
</span><span class=lnt id=hl-8-114><a class=lnlinks href=#hl-8-114>114</a>
</span><span class=lnt id=hl-8-115><a class=lnlinks href=#hl-8-115>115</a>
</span><span class=lnt id=hl-8-116><a class=lnlinks href=#hl-8-116>116</a>
</span><span class=lnt id=hl-8-117><a class=lnlinks href=#hl-8-117>117</a>
</span><span class=lnt id=hl-8-118><a class=lnlinks href=#hl-8-118>118</a>
</span><span class=lnt id=hl-8-119><a class=lnlinks href=#hl-8-119>119</a>
</span><span class=lnt id=hl-8-120><a class=lnlinks href=#hl-8-120>120</a>
</span><span class=lnt id=hl-8-121><a class=lnlinks href=#hl-8-121>121</a>
</span><span class=lnt id=hl-8-122><a class=lnlinks href=#hl-8-122>122</a>
</span><span class=lnt id=hl-8-123><a class=lnlinks href=#hl-8-123>123</a>
</span><span class=lnt id=hl-8-124><a class=lnlinks href=#hl-8-124>124</a>
</span><span class=lnt id=hl-8-125><a class=lnlinks href=#hl-8-125>125</a>
</span><span class=lnt id=hl-8-126><a class=lnlinks href=#hl-8-126>126</a>
</span><span class=lnt id=hl-8-127><a class=lnlinks href=#hl-8-127>127</a>
</span><span class=lnt id=hl-8-128><a class=lnlinks href=#hl-8-128>128</a>
</span><span class=lnt id=hl-8-129><a class=lnlinks href=#hl-8-129>129</a>
</span><span class=lnt id=hl-8-130><a class=lnlinks href=#hl-8-130>130</a>
</span><span class=lnt id=hl-8-131><a class=lnlinks href=#hl-8-131>131</a>
</span><span class=lnt id=hl-8-132><a class=lnlinks href=#hl-8-132>132</a>
</span><span class=lnt id=hl-8-133><a class=lnlinks href=#hl-8-133>133</a>
</span><span class=lnt id=hl-8-134><a class=lnlinks href=#hl-8-134>134</a>
</span><span class=lnt id=hl-8-135><a class=lnlinks href=#hl-8-135>135</a>
</span><span class=lnt id=hl-8-136><a class=lnlinks href=#hl-8-136>136</a>
</span><span class=lnt id=hl-8-137><a class=lnlinks href=#hl-8-137>137</a>
</span><span class=lnt id=hl-8-138><a class=lnlinks href=#hl-8-138>138</a>
</span><span class=lnt id=hl-8-139><a class=lnlinks href=#hl-8-139>139</a>
</span><span class=lnt id=hl-8-140><a class=lnlinks href=#hl-8-140>140</a>
</span><span class=lnt id=hl-8-141><a class=lnlinks href=#hl-8-141>141</a>
</span><span class=lnt id=hl-8-142><a class=lnlinks href=#hl-8-142>142</a>
</span><span class=lnt id=hl-8-143><a class=lnlinks href=#hl-8-143>143</a>
</span><span class=lnt id=hl-8-144><a class=lnlinks href=#hl-8-144>144</a>
</span><span class=lnt id=hl-8-145><a class=lnlinks href=#hl-8-145>145</a>
</span><span class=lnt id=hl-8-146><a class=lnlinks href=#hl-8-146>146</a>
</span><span class=lnt id=hl-8-147><a class=lnlinks href=#hl-8-147>147</a>
</span><span class=lnt id=hl-8-148><a class=lnlinks href=#hl-8-148>148</a>
</span><span class=lnt id=hl-8-149><a class=lnlinks href=#hl-8-149>149</a>
</span><span class=lnt id=hl-8-150><a class=lnlinks href=#hl-8-150>150</a>
</span><span class=lnt id=hl-8-151><a class=lnlinks href=#hl-8-151>151</a>
</span><span class=lnt id=hl-8-152><a class=lnlinks href=#hl-8-152>152</a>
</span><span class=lnt id=hl-8-153><a class=lnlinks href=#hl-8-153>153</a>
</span><span class=lnt id=hl-8-154><a class=lnlinks href=#hl-8-154>154</a>
</span><span class=lnt id=hl-8-155><a class=lnlinks href=#hl-8-155>155</a>
</span><span class=lnt id=hl-8-156><a class=lnlinks href=#hl-8-156>156</a>
</span><span class=lnt id=hl-8-157><a class=lnlinks href=#hl-8-157>157</a>
</span><span class=lnt id=hl-8-158><a class=lnlinks href=#hl-8-158>158</a>
</span><span class=lnt id=hl-8-159><a class=lnlinks href=#hl-8-159>159</a>
</span><span class=lnt id=hl-8-160><a class=lnlinks href=#hl-8-160>160</a>
</span><span class=lnt id=hl-8-161><a class=lnlinks href=#hl-8-161>161</a>
</span><span class=lnt id=hl-8-162><a class=lnlinks href=#hl-8-162>162</a>
</span><span class=lnt id=hl-8-163><a class=lnlinks href=#hl-8-163>163</a>
</span><span class=lnt id=hl-8-164><a class=lnlinks href=#hl-8-164>164</a>
</span><span class=lnt id=hl-8-165><a class=lnlinks href=#hl-8-165>165</a>
</span><span class=lnt id=hl-8-166><a class=lnlinks href=#hl-8-166>166</a>
</span><span class=lnt id=hl-8-167><a class=lnlinks href=#hl-8-167>167</a>
</span><span class=lnt id=hl-8-168><a class=lnlinks href=#hl-8-168>168</a>
</span><span class=lnt id=hl-8-169><a class=lnlinks href=#hl-8-169>169</a>
</span><span class=lnt id=hl-8-170><a class=lnlinks href=#hl-8-170>170</a>
</span><span class=lnt id=hl-8-171><a class=lnlinks href=#hl-8-171>171</a>
</span><span class=lnt id=hl-8-172><a class=lnlinks href=#hl-8-172>172</a>
</span><span class=lnt id=hl-8-173><a class=lnlinks href=#hl-8-173>173</a>
</span><span class=lnt id=hl-8-174><a class=lnlinks href=#hl-8-174>174</a>
</span><span class=lnt id=hl-8-175><a class=lnlinks href=#hl-8-175>175</a>
</span><span class=lnt id=hl-8-176><a class=lnlinks href=#hl-8-176>176</a>
</span><span class=lnt id=hl-8-177><a class=lnlinks href=#hl-8-177>177</a>
</span><span class=lnt id=hl-8-178><a class=lnlinks href=#hl-8-178>178</a>
</span><span class=lnt id=hl-8-179><a class=lnlinks href=#hl-8-179>179</a>
</span><span class=lnt id=hl-8-180><a class=lnlinks href=#hl-8-180>180</a>
</span><span class=lnt id=hl-8-181><a class=lnlinks href=#hl-8-181>181</a>
</span><span class=lnt id=hl-8-182><a class=lnlinks href=#hl-8-182>182</a>
</span><span class=lnt id=hl-8-183><a class=lnlinks href=#hl-8-183>183</a>
</span><span class=lnt id=hl-8-184><a class=lnlinks href=#hl-8-184>184</a>
</span><span class=lnt id=hl-8-185><a class=lnlinks href=#hl-8-185>185</a>
</span><span class=lnt id=hl-8-186><a class=lnlinks href=#hl-8-186>186</a>
</span><span class=lnt id=hl-8-187><a class=lnlinks href=#hl-8-187>187</a>
</span><span class=lnt id=hl-8-188><a class=lnlinks href=#hl-8-188>188</a>
</span><span class=lnt id=hl-8-189><a class=lnlinks href=#hl-8-189>189</a>
</span><span class=lnt id=hl-8-190><a class=lnlinks href=#hl-8-190>190</a>
</span><span class=lnt id=hl-8-191><a class=lnlinks href=#hl-8-191>191</a>
</span><span class=lnt id=hl-8-192><a class=lnlinks href=#hl-8-192>192</a>
</span><span class=lnt id=hl-8-193><a class=lnlinks href=#hl-8-193>193</a>
</span><span class=lnt id=hl-8-194><a class=lnlinks href=#hl-8-194>194</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>ChanBroker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;container/list&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Content</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Subscriber</span> <span class=kd>chan</span> <span class=nx>Content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ChanBroker</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>regSub</span>      <span class=kd>chan</span> <span class=nx>Subscriber</span>
</span></span><span class=line><span class=cl>    <span class=nx>unRegSub</span>    <span class=kd>chan</span> <span class=nx>Subscriber</span>
</span></span><span class=line><span class=cl>    <span class=nx>contents</span>    <span class=kd>chan</span> <span class=nx>Content</span>
</span></span><span class=line><span class=cl>    <span class=nx>stop</span>        <span class=kd>chan</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>subscribers</span> <span class=kd>map</span><span class=p>[</span><span class=nx>Subscriber</span><span class=p>]</span><span class=o>*</span><span class=nx>list</span><span class=p>.</span><span class=nx>List</span>
</span></span><span class=line><span class=cl>    <span class=nx>timeout</span>     <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>    <span class=nx>cachenum</span>    <span class=kt>uint</span>
</span></span><span class=line><span class=cl>    <span class=nx>timerChan</span>   <span class=o>&lt;-</span><span class=kd>chan</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ErrBrokerExit</span> <span class=kt>error</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;ChanBroker exit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ErrPublishTimeOut</span> <span class=kt>error</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;ChanBroker Pulish Time out&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ErrRegTimeOut</span> <span class=kt>error</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;ChanBroker Reg Time out&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ErrStopPublishTimeOut</span> <span class=kt>error</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;ChanBroker Stop Publish Time out&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewChanBroker</span><span class=p>(</span><span class=nx>timeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=o>*</span><span class=nx>ChanBroker</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Broker</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>ChanBroker</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Broker</span><span class=p>.</span><span class=nx>regSub</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Broker</span><span class=p>.</span><span class=nx>unRegSub</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Subscriber</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Broker</span><span class=p>.</span><span class=nx>contents</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>Content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Broker</span><span class=p>.</span><span class=nx>stop</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>Broker</span><span class=p>.</span><span class=nx>subscribers</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>Subscriber</span><span class=p>]</span><span class=o>*</span><span class=nx>list</span><span class=p>.</span><span class=nx>List</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Broker</span><span class=p>.</span><span class=nx>timeout</span> <span class=p>=</span> <span class=nx>timeout</span>
</span></span><span class=line><span class=cl>    <span class=nx>Broker</span><span class=p>.</span><span class=nx>cachenum</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nx>Broker</span><span class=p>.</span><span class=nx>timerChan</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=nx>Broker</span><span class=p>.</span><span class=nf>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>Broker</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>onContentPush</span><span class=p>(</span><span class=nx>content</span> <span class=nx>Content</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>sub</span><span class=p>,</span> <span class=nx>clist</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>loop</span> <span class=o>:=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>next</span> <span class=o>:=</span> <span class=nx>clist</span><span class=p>.</span><span class=nf>Front</span><span class=p>();</span> <span class=nx>next</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>loop</span> <span class=o>==</span> <span class=kc>true</span><span class=p>;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>cur</span> <span class=o>:=</span> <span class=nx>next</span>
</span></span><span class=line><span class=cl>            <span class=nx>next</span> <span class=p>=</span> <span class=nx>cur</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>&lt;-</span> <span class=nx>cur</span><span class=p>.</span><span class=nx>Value</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>self</span><span class=p>.</span><span class=nx>cachenum</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>self</span><span class=p>.</span><span class=nx>cachenum</span><span class=o>--</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>clist</span><span class=p>.</span><span class=nf>Remove</span><span class=p>(</span><span class=nx>cur</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>loop</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>len</span> <span class=o>:=</span> <span class=nx>clist</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>len</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>&lt;-</span> <span class=nx>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>clist</span><span class=p>.</span><span class=nf>PushBack</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>cachenum</span><span class=o>++</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>clist</span><span class=p>.</span><span class=nf>PushBack</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>self</span><span class=p>.</span><span class=nx>cachenum</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>self</span><span class=p>.</span><span class=nx>cachenum</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>self</span><span class=p>.</span><span class=nx>timerChan</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>timer</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>timerChan</span> <span class=p>=</span> <span class=nx>timer</span><span class=p>.</span><span class=nx>C</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>onTimerPush</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>sub</span><span class=p>,</span> <span class=nx>clist</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>loop</span> <span class=o>:=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>next</span> <span class=o>:=</span> <span class=nx>clist</span><span class=p>.</span><span class=nf>Front</span><span class=p>();</span> <span class=nx>next</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>loop</span> <span class=o>==</span> <span class=kc>true</span><span class=p>;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>cur</span> <span class=o>:=</span> <span class=nx>next</span>
</span></span><span class=line><span class=cl>            <span class=nx>next</span> <span class=p>=</span> <span class=nx>cur</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>&lt;-</span> <span class=nx>cur</span><span class=p>.</span><span class=nx>Value</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>self</span><span class=p>.</span><span class=nx>cachenum</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>self</span><span class=p>.</span><span class=nx>cachenum</span><span class=o>--</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>clist</span><span class=p>.</span><span class=nf>Remove</span><span class=p>(</span><span class=nx>cur</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>loop</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>self</span><span class=p>.</span><span class=nx>cachenum</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>timer</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>timerChan</span> <span class=p>=</span> <span class=nx>timer</span><span class=p>.</span><span class=nx>C</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>timerChan</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// Broker Goroutine
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>content</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>contents</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nf>onContentPush</span><span class=p>(</span><span class=nx>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>timerChan</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nf>onTimerPush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>regSub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>clist</span> <span class=o>:=</span> <span class=nx>list</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nx>subscribers</span><span class=p>[</span><span class=nx>sub</span><span class=p>]</span> <span class=p>=</span> <span class=nx>clist</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>sub</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>unRegSub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>subscribers</span><span class=p>[</span><span class=nx>sub</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nb>delete</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>subscribers</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nb>close</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>self</span><span class=p>.</span><span class=nx>stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>ok</span> <span class=o>==</span> <span class=kc>true</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nb>close</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=nx>self</span><span class=p>.</span><span class=nx>cachenum</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>self</span><span class=p>.</span><span class=nf>onTimerPush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=nx>sub</span><span class=p>,</span> <span class=nx>clist</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>self</span><span class=p>.</span><span class=nx>subscribers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=nx>clist</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nb>delete</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>subscribers</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=nb>close</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>RegSubscriber</span><span class=p>(</span><span class=nx>size</span> <span class=kt>uint</span><span class=p>)</span> <span class=p>(</span><span class=nx>Subscriber</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>sub</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>Subscriber</span><span class=p>,</span> <span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>ErrRegTimeOut</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>self</span><span class=p>.</span><span class=nx>regSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>sub</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>UnRegSubscriber</span><span class=p>(</span><span class=nx>sub</span> <span class=nx>Subscriber</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>self</span><span class=p>.</span><span class=nx>unRegSub</span> <span class=o>&lt;-</span> <span class=nx>sub</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>StopPublish</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>self</span><span class=p>.</span><span class=nx>stop</span> <span class=o>&lt;-</span> <span class=kc>true</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>ErrStopPublishTimeOut</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>self</span> <span class=o>*</span><span class=nx>ChanBroker</span><span class=p>)</span> <span class=nf>PubContent</span><span class=p>(</span><span class=nx>c</span> <span class=nx>Content</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>ErrPublishTimeOut</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>self</span><span class=p>.</span><span class=nx>contents</span> <span class=o>&lt;-</span> <span class=nx>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>存在以下问题，具体如下：</p><h4 id=问题1不支持扩展-1>问题1：不支持扩展<a hidden class=anchor aria-hidden=true href=#问题1不支持扩展-1>#</a></h4><p><strong>问题描述</strong>：</p><p>在一个Broker goroutine内完成注册与去注册以及内容发布推送给Subscriber，无法控制Subscriber数量，且不支持扩展</p><p><strong>解决思路</strong>：</p><ol><li>业务场景：chanbroker是进程内goroutines之间pub-sub通信方式一种实现方案，一个goroutine占用一个核来处理能满足绝太多数需求</li><li>即使不能满足极个别需求，也可以选择创建多个ChanBroker来实现扩展</li></ol><h3 id=channel编程总结>channel编程总结<a hidden class=anchor aria-hidden=true href=#channel编程总结>#</a></h3><ol><li>避免Panic，参考<a href=http://myself659.github.io/go-channel-feature/>Go channel 特点篇</a></li><li>最大程度保证非阻塞</li><li>若非业务需要，避免channel之间读写竞争</li><li>channel使用很灵活，也容易出错，建议多在设计上下功夫，分解问题采用简单的模型来解决问题</li><li>避免多余的channel状态引入,例如关闭channel</li><li>要有并发意识，由代码想到goroutine的运行</li><li>禁止通道复用，避免复用带来的复杂性</li><li>初期测试很重要，而且应作到充分测试</li><li>Don&rsquo;t communicate by sharing memory, share memory by communicating</li></ol><p>由于个人水平有限，有什么不足与错误，敬请指正！</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://myself659.github.io/tags/golang/>golang</a></li></ul><nav class=paginav><a class=prev href=https://myself659.github.io/post/2016-09-10-from-cepoll-to-go-net/><span class=title>« 上一页</span><br><span>从C语言epoll编程到go net实现分析</span></a>
<a class=next href=https://myself659.github.io/post/2016-08-05-im-user-state/><span class=title>下一页 »</span><br><span>IM后端系统设计总结(2)</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Go channel 编程篇 on twitter" href="https://twitter.com/intent/tweet/?text=Go%20channel%20%e7%bc%96%e7%a8%8b%e7%af%87&amp;url=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-08-20-go-channel-program-demo%2f&amp;hashtags=golang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Go channel 编程篇 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-08-20-go-channel-program-demo%2f&amp;title=Go%20channel%20%e7%bc%96%e7%a8%8b%e7%af%87&amp;summary=Go%20channel%20%e7%bc%96%e7%a8%8b%e7%af%87&amp;source=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-08-20-go-channel-program-demo%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Go channel 编程篇 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-08-20-go-channel-program-demo%2f&title=Go%20channel%20%e7%bc%96%e7%a8%8b%e7%af%87"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Go channel 编程篇 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-08-20-go-channel-program-demo%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Go channel 编程篇 on whatsapp" href="https://api.whatsapp.com/send?text=Go%20channel%20%e7%bc%96%e7%a8%8b%e7%af%87%20-%20https%3a%2f%2fmyself659.github.io%2fpost%2f2016-08-20-go-channel-program-demo%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Go channel 编程篇 on telegram" href="https://telegram.me/share/url?text=Go%20channel%20%e7%bc%96%e7%a8%8b%e7%af%87&amp;url=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-08-20-go-channel-program-demo%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>comments</span><br></div><div id=tcomment></div><script src=https://utteranc.es/client.js repo=https://github.com/myself659/ipds-public issue-term=title theme=github-light crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://myself659.github.io/>沉风网事</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>