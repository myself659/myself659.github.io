<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>从C语言epoll编程到go net实现分析 | 沉风网事</title><meta name=keywords content="golang"><meta name=description content="说明 go源码版本：1.7 go源码运行环境：Linux epoll在c语言编程示例 先看一下大家比较熟悉的epoll在c语言中应用，代码取自rtm"><meta name=author content="沉风"><link rel=canonical href=https://myself659.github.io/post/2016-09-10-from-cepoll-to-go-net/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.bf5f9f73cf17311d52cedbcda82c922e91b2f566d88a85ad9f5b5a08b586bd5f.css integrity="sha256-v1+fc88XMR1SztvNqCySLpGy9WbYioWtn1taCLWGvV8=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://myself659.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://myself659.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://myself659.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://myself659.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://myself659.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-144475213-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="从C语言epoll编程到go net实现分析"><meta property="og:description" content="说明 go源码版本：1.7 go源码运行环境：Linux epoll在c语言编程示例 先看一下大家比较熟悉的epoll在c语言中应用，代码取自rtm"><meta property="og:type" content="article"><meta property="og:url" content="https://myself659.github.io/post/2016-09-10-from-cepoll-to-go-net/"><meta property="og:image" content="https://myself659.github.io/"><meta property="article:section" content="post"><meta property="article:published_time" content="2016-09-10T11:58:06+02:00"><meta property="article:modified_time" content="2016-09-10T11:58:06+02:00"><meta property="og:site_name" content="沉风网事"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://myself659.github.io/"><meta name=twitter:title content="从C语言epoll编程到go net实现分析"><meta name=twitter:description content="说明 go源码版本：1.7 go源码运行环境：Linux epoll在c语言编程示例 先看一下大家比较熟悉的epoll在c语言中应用，代码取自rtm"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://myself659.github.io/post/"},{"@type":"ListItem","position":2,"name":"从C语言epoll编程到go net实现分析","item":"https://myself659.github.io/post/2016-09-10-from-cepoll-to-go-net/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"从C语言epoll编程到go net实现分析","name":"从C语言epoll编程到go net实现分析","description":"说明 go源码版本：1.7 go源码运行环境：Linux epoll在c语言编程示例 先看一下大家比较熟悉的epoll在c语言中应用，代码取自rtm","keywords":["golang"],"articleBody":"说明 go源码版本：1.7 go源码运行环境：Linux epoll在c语言编程示例 先看一下大家比较熟悉的epoll在c语言中应用，代码取自rtmpserver_demo中的文件rtmpepollsrv.c\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 int RtmpSessionHandle(int iFd, int iEvent, void *pContext) { int iRet; RTMP_SESSION *pSession = (RTMP_SESSION *)pContext; if(iEvent\u0026EPOLLIN ) { if(0 == pSession-\u003ehandshake) { iRet = RtmpSessionHandshake(pSession); if(0 != iRet) { RtmpSessionHandleFin(pSession); } } else { iRet = RtmpPktHandle(pSession); } } if(iEvent \u0026 (EPOLLERR |EPOLLHUP) ) { RtmpSessionHandleFin(pSession); } return iRet; } int ListenHandle(int iFd, int iEvent, void *pContext) { int iNewFd; int iRet = 0; struct sockaddr tmpAddr; memset(\u0026tmpAddr, 0, sizeof(tmpAddr)); int iSocketSize = sizeof(tmpAddr); EPOLL_CTX *pCtx; RTMP_SESSION *pServer; if(iEvent|EPOLLIN) { iNewFd = accept(iFd, \u0026tmpAddr, (socklen_t *)\u0026iSocketSize); if(RTMP_EPOLLSRV_INVALIDFD \u003c iNewFd) { pServer = (RTMP_SESSION *)malloc(sizeof(RTMP_SESSION)); if(NULL == pServer) { return -1; } pServer-\u003ehandshake = 0; pCtx = (EPOLL_CTX *)malloc(sizeof(EPOLL_CTX)); if(NULL == pCtx) { free(pServer); return -1; } pServer-\u003esocket = iNewFd; pCtx-\u003eiFd = iNewFd; pCtx-\u003epContext = pServer; pCtx-\u003epfHandle = RtmpSessionHandle; /* 加入epoll */ iRet = epoll_op(g_iEpollFd, EPOLL_CTL_ADD, iNewFd, EPOLLIN|EPOLLERR|EPOLLHUP, pCtx); } else { printf(\"accept errno:%s\",strerror(errno)); } } return iRet; } int epoll_op(int iEpollFd, int iOp, int iFd, int iEvent, EPOLL_CTX *pCtx) { int iRet; struct epoll_event ev; ev.events = iEvent; ev.data.ptr = pCtx; iRet = epoll_ctl(iEpollFd, iOp, iFd, \u0026ev); return iRet; } int epoll_loop(int iEpollFd) { int iNum; struct epoll_event astEpEvent[RTMP_EPOLLSRV_MAXEPOLL]; int i; EpollCallBack_PF pfHandle; EPOLL_CTX *pCtx; for( ; ;) { iNum= epoll_wait(iEpollFd, \u0026astEpEvent[0], RTMP_EPOLLSRV_MAXEPOLL, -1); if( 0 \u003c iNum) { for(i = 0; i \u003c iNum; i++) { pCtx = (EPOLL_CTX *)astEpEvent[i].data.ptr; pfHandle = pCtx-\u003epfHandle; (void)pfHandle(pCtx-\u003eiFd, astEpEvent[i].events, pCtx-\u003epContext); } } else { printf(\"epoll_wait failed\\r\\n\"); } } return 0; } int main(void) { int iFd; struct sockaddr_in addr; printf(\"in the main\\r\\n\"); /* 初始化epoll */ g_iEpollFd = epoll_create(200); if(RTMP_EPOLLSRV_INVALIDFD \u003e= g_iEpollFd) { printf(\"create epoll failed\\r\\n\"); return -1; } /* 创建侦听端口 */ iFd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP); if(RTMP_EPOLLSRV_INVALIDFD \u003e= iFd) { printf(\"create listen socket failed\\r\\n\"); return -1; } addr.sin_family = AF_INET; addr.sin_addr.s_addr = inet_addr(g_cRtmpSrvAddr); addr.sin_port = htons(g_usRtmpSrvPort); if( 0 != bind(iFd, (struct sockaddr *) \u0026addr, sizeof(struct sockaddr_in))) { return -1; } if( 0 != listen(iFd, 200)) { return -1; } EPOLL_CTX *pEpollCtx = (EPOLL_CTX *)malloc(sizeof(EPOLL_CTX)); if(NULL == pEpollCtx) { return -1; } pEpollCtx-\u003eiFd = iFd; pEpollCtx-\u003epfHandle = ListenHandle; pEpollCtx-\u003epContext = NULL; /* 加入epoll */ if(0 != epoll_op(g_iEpollFd, EPOLL_CTL_ADD, iFd, EPOLLIN|EPOLLERR|EPOLLHUP, pEpollCtx)) { return -1; } g_iListenFd = iFd; epoll_loop(g_iEpollFd); return 0; } 功能 上述代码代码主要通过epoll实现一个最基本的网络服务器（侦听一个端口，处理这个端口上连接）\n几个重要数据结构\n实现分析 简单说明如下：\n用下面的结构体EPOLL_CTX保存epoll的回调及异步处理的上下文\n1 2 3 4 5 6 typedef struct { int iFd; EpollCallBack_PF pfHandle; void *pContext; }EPOLL_CTX; 从面向过程编程角度简单梳理一下epoll相关的代码\n创建epoll 加入epoll 进入epoll_loop,处理epoll事件 go 编程示例 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package main import ( \"fmt\" \"net\" \"os\" ) const ( CONN_HOST = \"localhost\" CONN_PORT = \"3333\" CONN_TYPE = \"tcp\" ) func main() { // Listen for incoming connections. l, err := net.Listen(CONN_TYPE, CONN_HOST+\":\"+CONN_PORT) if err != nil { fmt.Println(\"Error listening:\", err.Error()) os.Exit(1) } // Close the listener when the application closes. defer l.Close() fmt.Println(\"Listening on \" + CONN_HOST + \":\" + CONN_PORT) for { // Listen for an incoming connection. conn, err := l.Accept() if err != nil { fmt.Println(\"Error accepting: \", err.Error()) os.Exit(1) } // Handle connections in a new goroutine. go handleRequest(conn) } } // Handles incoming requests. func handleRequest(conn net.Conn) { // Make a buffer to hold incoming data. buf := make([]byte, 1024) // Read the incoming connection into the buffer. reqLen, err := conn.Read(buf) if err != nil { fmt.Println(\"Error reading:\", err.Error()) conn.Close() return } fmt.Printf(\"recv:%s, len=%d\\n\", string(buf), reqLen) // Send a response back to person contacting us. conn.Write([]byte(\"Message received.\")) // Close the connection when you're done with it. conn.Close() } 对比 handleRequest代码对应c语言版本epoll回调，但是这个代码与业务逻辑很搭，读取报文，进行处理，返回结果这些操作可以同一个函数内（也就是同一个逻辑上面）实现，没有异步回调就是爽啊 go语言上编程上不需要看到epoll，也就没添加/删除epoll的操作 编程模型方面无论是原生的回调还是reactor模型，go语言更符合业务的逻辑，而不需要考虑epoll相关处理 够简洁明了，有着与c语言相当的性能，程序员们让我们一起go吧！ Go Net实现分析 通过以上对比，显而易见，go语言保证效率的情况，在易用性大大超过了c，那golang是如何实现的？下面具体分析golang的net库实现\ngoroutine调度时机 一般在以下四种情况下进行goroutine调度：\nchannel收发 显示调用go函数 阻塞的系统调用，如read,write GC epoll使用 先简单看一下各个epoll操作代码实现，先找到他们，再分析如何利用这些操作来完成简洁的网络编程\nepoll初始化 对应c语言版本的epoll_create，go语言版本在初始化在下面的代码中完成:\n1 2 3 4 5 6 7 8 9 10 11 12 13 func netpollinit() { epfd = epollcreate1(_EPOLL_CLOEXEC) if epfd \u003e= 0 { return } epfd = epollcreate(1024) if epfd \u003e= 0 { closeonexec(epfd) return } println(\"netpollinit: failed to create epoll descriptor\", -epfd) throw(\"netpollinit: failed to create descriptor\") } 将fd加入epoll 对应c语言版本的epoll_op，go语言版本在初始化在下面的代码中完成:\n1 2 3 4 5 6 func netpollopen(fd uintptr, pd *pollDesc) int32 { var ev epollevent ev.events = _EPOLLIN | _EPOLLOUT | _EPOLLRDHUP | _EPOLLET *(**pollDesc)(unsafe.Pointer(\u0026ev.data)) = pd return -epollctl(epfd, _EPOLL_CTL_ADD, int32(fd), \u0026ev) } 注意这里采用的边沿触发\n从epoll摘除fd 对应c语言版本的epoll_op，go语言版本在初始化在下面的代码中完成:\n1 2 3 4 func netpollclose(fd uintptr) int32 { var ev epollevent return -epollctl(epfd, _EPOLL_CTL_DEL, int32(fd), \u0026ev) } 数据结构 pollDesc 结构体pollDesc用于关联fd与epoll，具体结构如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // Network poller descriptor. // 每个添加到epoll中的fd都对应了一个PollDesc结构实例 type pollDesc struct { // 指向下一个pollDesc link *pollDesc // in pollcache, protected by pollcache.lock // The lock protects pollOpen, pollSetDeadline, pollUnblock and deadlineimpl operations. // This fully covers seq, rt and wt variables. fd is constant throughout the PollDesc lifetime. // pollReset, pollWait, pollWaitCanceled and runtime·netpollready (IO readiness notification) // proceed w/o taking the lock. So closing, rg, rd, wg and wd are manipulated // in a lock-free way by all operations. // NOTE(dvyukov): the following code uses uintptr to store *g (rg/wg), // that will blow up when GC starts moving objects. lock mutex // protects the following fields // 系统为socket分配的fd fd uintptr closing bool // 是否关闭 // 用于保护旧定时器和就绪的通知 seq uintptr // protects from stale timers and ready notifications // 网络io读状态，分为三种: 网络io就绪， 进入等待状态， 等待状态，此时rg保存等待goroutine实例的指针 rg uintptr // pdReady, pdWait, G waiting for read or nil rt timer // read deadline timer (set if rt.f != nil) // 读超时时间，单位为ns rd int64 // read deadline // 网络io写状态，分为三种: 网络io就绪， 进入等待状态， 等待状态，此时rg保存等待goroutine实例的指针 wg uintptr // pdReady, pdWait, G waiting for write or nil // 写超时时间，单位为ns wt timer // write deadline timer wd int64 // write deadline user uint32 // user settable cookie } epoll操作封装 以初始化epoll及加入epoll为例，在下面的函数中完成的\n1 2 3 4 5 6 7 8 9 10 11 12 var serverInit sync.Once func (pd *pollDesc) init(fd *netFD) error { serverInit.Do(runtime_pollServerInit) ctx, errno := runtime_pollOpen(uintptr(fd.sysfd)) if errno != 0 { return syscall.Errno(errno) } pd.runtimeCtx = ctx return nil } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 func (fd *netFD) accept() (netfd *netFD, err error) { if err := fd.readLock(); err != nil { return nil, err } defer fd.readUnlock() var s int var rsa syscall.Sockaddr if err = fd.pd.prepareRead(); err != nil { return nil, err } for { s, rsa, err = accept(fd.sysfd) if err != nil { nerr, ok := err.(*os.SyscallError) if !ok { return nil, err } switch nerr.Err { case syscall.EAGAIN: if err = fd.pd.waitRead(); err == nil { continue } case syscall.ECONNABORTED: // This means that a socket on the // listen queue was closed before we // Accept()ed it; it's a silly error, // so try again. continue } return nil, err } break } if netfd, err = newFD(s, fd.family, fd.sotype, fd.net); err != nil { closeFunc(s) return nil, err } // 调用上面函数加入epoll if err = netfd.init(); err != nil { fd.Close() return nil, err } lsa, _ := syscall.Getsockname(netfd.sysfd) netfd.setAddr(netfd.addrFunc()(lsa), netfd.addrFunc()(rsa)) return netfd, nil } 读处理 先从为Read代码开始\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 func (fd *netFD) Read(p []byte) (n int, err error) { if err := fd.readLock(); err != nil { return 0, err } defer fd.readUnlock() if len(p) == 0 { // If the caller wanted a zero byte read, return immediately // without trying. (But after acquiring the readLock.) Otherwise // syscall.Read returns 0, nil and eofError turns that into // io.EOF. // TODO(bradfitz): make it wait for readability? (Issue 15735) return 0, nil } if err := fd.pd.prepareRead(); err != nil { return 0, err } for { n, err = syscall.Read(fd.sysfd, p) if err != nil { n = 0 if err == syscall.EAGAIN { // 没有可读数据，进行读等待处理 if err = fd.pd.waitRead(); err == nil { continue } } } err = fd.eofError(n, err) break } if _, ok := err.(syscall.Errno); ok { err = os.NewSyscallError(\"read\", err) } return } 具体分析读等待处理,跳过封装，直接分析处理代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 //go:linkname net_runtime_pollWait net.runtime_pollWait // 进入pollwait状态进行goroutine调度 func net_runtime_pollWait(pd *pollDesc, mode int) int { err := netpollcheckerr(pd, int32(mode)) if err != 0 { return err } // As for now only Solaris uses level-triggered IO. if GOOS == \"solaris\" { netpollarm(pd, mode) } // for !netpollblock(pd, int32(mode), false) { err = netpollcheckerr(pd, int32(mode)) if err != 0 { return err } // Can happen if timeout has fired and unblocked us, // but before we had a chance to run, timeout has been reset. // Pretend it has not happened and retry. } return 0 } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // returns true if IO is ready, or false if timedout or closed // waitio - wait only for completed IO, ignore errors // 返回true表示IO就绪，返回false表示超时或者关闭 // waitio 表示是否等待IO,超时时该参数为false func netpollblock(pd *pollDesc, mode int32, waitio bool) bool { // 从pd.rg取指针 gpp := \u0026pd.rg if mode == 'w' { gpp = \u0026pd.wg } // set the gpp semaphore to WAIT for { old := *gpp if old == pdReady { *gpp = 0 return true } if old != 0 { throw(\"netpollblock: double wait\") } // cas 设置读状态为pdWait状态 if atomic.Casuintptr(gpp, 0, pdWait) { break } } // need to recheck error states after setting gpp to WAIT // this is necessary because runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl // do the opposite: store to closing/rd/wd, membarrier, load of rg/wg // 因为runtime_pollUnblock runtime_pollSetDeadline/deadlineimpl 将rg/wg状态修改为closing if waitio || netpollcheckerr(pd, mode) == 0 { gopark(netpollblockcommit, unsafe.Pointer(gpp), \"IO wait\", traceEvGoBlockNet, 5) } // be careful to not lose concurrent READY notification old := atomic.Xchguintptr(gpp, 0) if old \u003e pdWait { throw(\"netpollblock: corrupted state\") } return old == pdReady } 总结 net网络库的设计的精华,良好的封装与接口,提高简单可靠的接口 充分利用goroutine机制 同步编程，异步执行，这一点其实在内核也能找到，只是调度机制不一样 多学习源码，这里面有精妙的设计，科学的框架 很多问题深入一下就到底层了 异步编程能够带来高性能，但是也是高要求，如果系统复杂，出现问题不好定位，同时代码的可读性也差 代码在满足正确性的基础上，应先追求可读性，规范性，高性能往后排 参考 How Goroutines Work ","wordCount":"3388","inLanguage":"zh","datePublished":"2016-09-10T11:58:06+02:00","dateModified":"2016-09-10T11:58:06+02:00","author":{"@type":"Person","name":"沉风"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://myself659.github.io/post/2016-09-10-from-cepoll-to-go-net/"},"publisher":{"@type":"Organization","name":"沉风网事","logo":{"@type":"ImageObject","url":"https://myself659.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://myself659.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://myself659.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://myself659.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://myself659.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://myself659.github.io/search/ title=Search><span>Search</span></a></li><li><a href=https://myself659.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://myself659.github.io/about/ title=About><span>About</span></a></li><li><a href=https://myself659.github.io/post/leetcode/ title=LeetCode><span>LeetCode</span></a></li><li><a href=https://myself659.github.io/post/read-post/ title=Reading><span>Reading</span></a></li><li><a href=https://myself659.github.io/post/share-post/ title=Share><span>Share</span></a></li><li><a href=https://myself659.github.io/post/slide-post/ title=Slide><span>Slide</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://myself659.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://myself659.github.io/post/>Posts</a></div><h1 class=post-title>从C语言epoll编程到go net实现分析</h1><div class=post-meta><span title='2016-09-10 11:58:06 +0200 +0200'>2016-09-10</span>&nbsp;·&nbsp;沉风</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e8%af%b4%e6%98%8e aria-label=说明>说明</a></li><li><a href=#epoll%e5%9c%a8c%e8%af%ad%e8%a8%80%e7%bc%96%e7%a8%8b%e7%a4%ba%e4%be%8b aria-label=epoll在c语言编程示例>epoll在c语言编程示例</a><ul><li><a href=#%e5%8a%9f%e8%83%bd aria-label=功能>功能</a></li><li><a href=#%e5%ae%9e%e7%8e%b0%e5%88%86%e6%9e%90 aria-label=实现分析>实现分析</a></li></ul></li><li><a href=#go-%e7%bc%96%e7%a8%8b%e7%a4%ba%e4%be%8b aria-label="go 编程示例">go 编程示例</a></li><li><a href=#%e5%af%b9%e6%af%94 aria-label=对比>对比</a></li><li><a href=#go-net%e5%ae%9e%e7%8e%b0%e5%88%86%e6%9e%90 aria-label="Go Net实现分析">Go Net实现分析</a><ul><li><a href=#goroutine%e8%b0%83%e5%ba%a6%e6%97%b6%e6%9c%ba aria-label=goroutine调度时机>goroutine调度时机</a></li><li><a href=#epoll%e4%bd%bf%e7%94%a8 aria-label=epoll使用>epoll使用</a><ul><li><a href=#epoll%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label=epoll初始化>epoll初始化</a></li><li><a href=#%e5%b0%86fd%e5%8a%a0%e5%85%a5epoll aria-label=将fd加入epoll>将fd加入epoll</a></li><li><a href=#%e4%bb%8eepoll%e6%91%98%e9%99%a4fd aria-label=从epoll摘除fd>从epoll摘除fd</a></li><li><a href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84-polldesc aria-label="数据结构 pollDesc">数据结构 pollDesc</a></li><li><a href=#epoll%e6%93%8d%e4%bd%9c%e5%b0%81%e8%a3%85 aria-label=epoll操作封装>epoll操作封装</a></li><li><a href=#%e8%af%bb%e5%a4%84%e7%90%86 aria-label=读处理>读处理</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></li></ul></div></details></div><div class=post-content><h2 id=说明>说明<a hidden class=anchor aria-hidden=true href=#说明>#</a></h2><ol><li>go源码版本：1.7</li><li>go源码运行环境：Linux</li></ol><h2 id=epoll在c语言编程示例>epoll在c语言编程示例<a hidden class=anchor aria-hidden=true href=#epoll在c语言编程示例>#</a></h2><p>先看一下大家比较熟悉的epoll在c语言中应用，代码取自<a href=https://github.com/myself659/rtmpserver_demo>rtmpserver_demo</a>中的文件<a href=https://github.com/myself659/rtmpserver_demo/blob/master/rtmpepollsrv.c>rtmpepollsrv.c</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>  1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>  2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3>  3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4>  4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5>  5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6>  6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7>  7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8>  8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9>  9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10> 10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11> 11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12> 12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13> 13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14> 14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15> 15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16> 16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17> 17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18> 18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19> 19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20> 20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21> 21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22> 22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23> 23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24> 24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25> 25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26> 26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27> 27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28> 28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29> 29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30> 30</a>
</span><span class=lnt id=hl-0-31><a class=lnlinks href=#hl-0-31> 31</a>
</span><span class=lnt id=hl-0-32><a class=lnlinks href=#hl-0-32> 32</a>
</span><span class=lnt id=hl-0-33><a class=lnlinks href=#hl-0-33> 33</a>
</span><span class=lnt id=hl-0-34><a class=lnlinks href=#hl-0-34> 34</a>
</span><span class=lnt id=hl-0-35><a class=lnlinks href=#hl-0-35> 35</a>
</span><span class=lnt id=hl-0-36><a class=lnlinks href=#hl-0-36> 36</a>
</span><span class=lnt id=hl-0-37><a class=lnlinks href=#hl-0-37> 37</a>
</span><span class=lnt id=hl-0-38><a class=lnlinks href=#hl-0-38> 38</a>
</span><span class=lnt id=hl-0-39><a class=lnlinks href=#hl-0-39> 39</a>
</span><span class=lnt id=hl-0-40><a class=lnlinks href=#hl-0-40> 40</a>
</span><span class=lnt id=hl-0-41><a class=lnlinks href=#hl-0-41> 41</a>
</span><span class=lnt id=hl-0-42><a class=lnlinks href=#hl-0-42> 42</a>
</span><span class=lnt id=hl-0-43><a class=lnlinks href=#hl-0-43> 43</a>
</span><span class=lnt id=hl-0-44><a class=lnlinks href=#hl-0-44> 44</a>
</span><span class=lnt id=hl-0-45><a class=lnlinks href=#hl-0-45> 45</a>
</span><span class=lnt id=hl-0-46><a class=lnlinks href=#hl-0-46> 46</a>
</span><span class=lnt id=hl-0-47><a class=lnlinks href=#hl-0-47> 47</a>
</span><span class=lnt id=hl-0-48><a class=lnlinks href=#hl-0-48> 48</a>
</span><span class=lnt id=hl-0-49><a class=lnlinks href=#hl-0-49> 49</a>
</span><span class=lnt id=hl-0-50><a class=lnlinks href=#hl-0-50> 50</a>
</span><span class=lnt id=hl-0-51><a class=lnlinks href=#hl-0-51> 51</a>
</span><span class=lnt id=hl-0-52><a class=lnlinks href=#hl-0-52> 52</a>
</span><span class=lnt id=hl-0-53><a class=lnlinks href=#hl-0-53> 53</a>
</span><span class=lnt id=hl-0-54><a class=lnlinks href=#hl-0-54> 54</a>
</span><span class=lnt id=hl-0-55><a class=lnlinks href=#hl-0-55> 55</a>
</span><span class=lnt id=hl-0-56><a class=lnlinks href=#hl-0-56> 56</a>
</span><span class=lnt id=hl-0-57><a class=lnlinks href=#hl-0-57> 57</a>
</span><span class=lnt id=hl-0-58><a class=lnlinks href=#hl-0-58> 58</a>
</span><span class=lnt id=hl-0-59><a class=lnlinks href=#hl-0-59> 59</a>
</span><span class=lnt id=hl-0-60><a class=lnlinks href=#hl-0-60> 60</a>
</span><span class=lnt id=hl-0-61><a class=lnlinks href=#hl-0-61> 61</a>
</span><span class=lnt id=hl-0-62><a class=lnlinks href=#hl-0-62> 62</a>
</span><span class=lnt id=hl-0-63><a class=lnlinks href=#hl-0-63> 63</a>
</span><span class=lnt id=hl-0-64><a class=lnlinks href=#hl-0-64> 64</a>
</span><span class=lnt id=hl-0-65><a class=lnlinks href=#hl-0-65> 65</a>
</span><span class=lnt id=hl-0-66><a class=lnlinks href=#hl-0-66> 66</a>
</span><span class=lnt id=hl-0-67><a class=lnlinks href=#hl-0-67> 67</a>
</span><span class=lnt id=hl-0-68><a class=lnlinks href=#hl-0-68> 68</a>
</span><span class=lnt id=hl-0-69><a class=lnlinks href=#hl-0-69> 69</a>
</span><span class=lnt id=hl-0-70><a class=lnlinks href=#hl-0-70> 70</a>
</span><span class=lnt id=hl-0-71><a class=lnlinks href=#hl-0-71> 71</a>
</span><span class=lnt id=hl-0-72><a class=lnlinks href=#hl-0-72> 72</a>
</span><span class=lnt id=hl-0-73><a class=lnlinks href=#hl-0-73> 73</a>
</span><span class=lnt id=hl-0-74><a class=lnlinks href=#hl-0-74> 74</a>
</span><span class=lnt id=hl-0-75><a class=lnlinks href=#hl-0-75> 75</a>
</span><span class=lnt id=hl-0-76><a class=lnlinks href=#hl-0-76> 76</a>
</span><span class=lnt id=hl-0-77><a class=lnlinks href=#hl-0-77> 77</a>
</span><span class=lnt id=hl-0-78><a class=lnlinks href=#hl-0-78> 78</a>
</span><span class=lnt id=hl-0-79><a class=lnlinks href=#hl-0-79> 79</a>
</span><span class=lnt id=hl-0-80><a class=lnlinks href=#hl-0-80> 80</a>
</span><span class=lnt id=hl-0-81><a class=lnlinks href=#hl-0-81> 81</a>
</span><span class=lnt id=hl-0-82><a class=lnlinks href=#hl-0-82> 82</a>
</span><span class=lnt id=hl-0-83><a class=lnlinks href=#hl-0-83> 83</a>
</span><span class=lnt id=hl-0-84><a class=lnlinks href=#hl-0-84> 84</a>
</span><span class=lnt id=hl-0-85><a class=lnlinks href=#hl-0-85> 85</a>
</span><span class=lnt id=hl-0-86><a class=lnlinks href=#hl-0-86> 86</a>
</span><span class=lnt id=hl-0-87><a class=lnlinks href=#hl-0-87> 87</a>
</span><span class=lnt id=hl-0-88><a class=lnlinks href=#hl-0-88> 88</a>
</span><span class=lnt id=hl-0-89><a class=lnlinks href=#hl-0-89> 89</a>
</span><span class=lnt id=hl-0-90><a class=lnlinks href=#hl-0-90> 90</a>
</span><span class=lnt id=hl-0-91><a class=lnlinks href=#hl-0-91> 91</a>
</span><span class=lnt id=hl-0-92><a class=lnlinks href=#hl-0-92> 92</a>
</span><span class=lnt id=hl-0-93><a class=lnlinks href=#hl-0-93> 93</a>
</span><span class=lnt id=hl-0-94><a class=lnlinks href=#hl-0-94> 94</a>
</span><span class=lnt id=hl-0-95><a class=lnlinks href=#hl-0-95> 95</a>
</span><span class=lnt id=hl-0-96><a class=lnlinks href=#hl-0-96> 96</a>
</span><span class=lnt id=hl-0-97><a class=lnlinks href=#hl-0-97> 97</a>
</span><span class=lnt id=hl-0-98><a class=lnlinks href=#hl-0-98> 98</a>
</span><span class=lnt id=hl-0-99><a class=lnlinks href=#hl-0-99> 99</a>
</span><span class=lnt id=hl-0-100><a class=lnlinks href=#hl-0-100>100</a>
</span><span class=lnt id=hl-0-101><a class=lnlinks href=#hl-0-101>101</a>
</span><span class=lnt id=hl-0-102><a class=lnlinks href=#hl-0-102>102</a>
</span><span class=lnt id=hl-0-103><a class=lnlinks href=#hl-0-103>103</a>
</span><span class=lnt id=hl-0-104><a class=lnlinks href=#hl-0-104>104</a>
</span><span class=lnt id=hl-0-105><a class=lnlinks href=#hl-0-105>105</a>
</span><span class=lnt id=hl-0-106><a class=lnlinks href=#hl-0-106>106</a>
</span><span class=lnt id=hl-0-107><a class=lnlinks href=#hl-0-107>107</a>
</span><span class=lnt id=hl-0-108><a class=lnlinks href=#hl-0-108>108</a>
</span><span class=lnt id=hl-0-109><a class=lnlinks href=#hl-0-109>109</a>
</span><span class=lnt id=hl-0-110><a class=lnlinks href=#hl-0-110>110</a>
</span><span class=lnt id=hl-0-111><a class=lnlinks href=#hl-0-111>111</a>
</span><span class=lnt id=hl-0-112><a class=lnlinks href=#hl-0-112>112</a>
</span><span class=lnt id=hl-0-113><a class=lnlinks href=#hl-0-113>113</a>
</span><span class=lnt id=hl-0-114><a class=lnlinks href=#hl-0-114>114</a>
</span><span class=lnt id=hl-0-115><a class=lnlinks href=#hl-0-115>115</a>
</span><span class=lnt id=hl-0-116><a class=lnlinks href=#hl-0-116>116</a>
</span><span class=lnt id=hl-0-117><a class=lnlinks href=#hl-0-117>117</a>
</span><span class=lnt id=hl-0-118><a class=lnlinks href=#hl-0-118>118</a>
</span><span class=lnt id=hl-0-119><a class=lnlinks href=#hl-0-119>119</a>
</span><span class=lnt id=hl-0-120><a class=lnlinks href=#hl-0-120>120</a>
</span><span class=lnt id=hl-0-121><a class=lnlinks href=#hl-0-121>121</a>
</span><span class=lnt id=hl-0-122><a class=lnlinks href=#hl-0-122>122</a>
</span><span class=lnt id=hl-0-123><a class=lnlinks href=#hl-0-123>123</a>
</span><span class=lnt id=hl-0-124><a class=lnlinks href=#hl-0-124>124</a>
</span><span class=lnt id=hl-0-125><a class=lnlinks href=#hl-0-125>125</a>
</span><span class=lnt id=hl-0-126><a class=lnlinks href=#hl-0-126>126</a>
</span><span class=lnt id=hl-0-127><a class=lnlinks href=#hl-0-127>127</a>
</span><span class=lnt id=hl-0-128><a class=lnlinks href=#hl-0-128>128</a>
</span><span class=lnt id=hl-0-129><a class=lnlinks href=#hl-0-129>129</a>
</span><span class=lnt id=hl-0-130><a class=lnlinks href=#hl-0-130>130</a>
</span><span class=lnt id=hl-0-131><a class=lnlinks href=#hl-0-131>131</a>
</span><span class=lnt id=hl-0-132><a class=lnlinks href=#hl-0-132>132</a>
</span><span class=lnt id=hl-0-133><a class=lnlinks href=#hl-0-133>133</a>
</span><span class=lnt id=hl-0-134><a class=lnlinks href=#hl-0-134>134</a>
</span><span class=lnt id=hl-0-135><a class=lnlinks href=#hl-0-135>135</a>
</span><span class=lnt id=hl-0-136><a class=lnlinks href=#hl-0-136>136</a>
</span><span class=lnt id=hl-0-137><a class=lnlinks href=#hl-0-137>137</a>
</span><span class=lnt id=hl-0-138><a class=lnlinks href=#hl-0-138>138</a>
</span><span class=lnt id=hl-0-139><a class=lnlinks href=#hl-0-139>139</a>
</span><span class=lnt id=hl-0-140><a class=lnlinks href=#hl-0-140>140</a>
</span><span class=lnt id=hl-0-141><a class=lnlinks href=#hl-0-141>141</a>
</span><span class=lnt id=hl-0-142><a class=lnlinks href=#hl-0-142>142</a>
</span><span class=lnt id=hl-0-143><a class=lnlinks href=#hl-0-143>143</a>
</span><span class=lnt id=hl-0-144><a class=lnlinks href=#hl-0-144>144</a>
</span><span class=lnt id=hl-0-145><a class=lnlinks href=#hl-0-145>145</a>
</span><span class=lnt id=hl-0-146><a class=lnlinks href=#hl-0-146>146</a>
</span><span class=lnt id=hl-0-147><a class=lnlinks href=#hl-0-147>147</a>
</span><span class=lnt id=hl-0-148><a class=lnlinks href=#hl-0-148>148</a>
</span><span class=lnt id=hl-0-149><a class=lnlinks href=#hl-0-149>149</a>
</span><span class=lnt id=hl-0-150><a class=lnlinks href=#hl-0-150>150</a>
</span><span class=lnt id=hl-0-151><a class=lnlinks href=#hl-0-151>151</a>
</span><span class=lnt id=hl-0-152><a class=lnlinks href=#hl-0-152>152</a>
</span><span class=lnt id=hl-0-153><a class=lnlinks href=#hl-0-153>153</a>
</span><span class=lnt id=hl-0-154><a class=lnlinks href=#hl-0-154>154</a>
</span><span class=lnt id=hl-0-155><a class=lnlinks href=#hl-0-155>155</a>
</span><span class=lnt id=hl-0-156><a class=lnlinks href=#hl-0-156>156</a>
</span><span class=lnt id=hl-0-157><a class=lnlinks href=#hl-0-157>157</a>
</span><span class=lnt id=hl-0-158><a class=lnlinks href=#hl-0-158>158</a>
</span><span class=lnt id=hl-0-159><a class=lnlinks href=#hl-0-159>159</a>
</span><span class=lnt id=hl-0-160><a class=lnlinks href=#hl-0-160>160</a>
</span><span class=lnt id=hl-0-161><a class=lnlinks href=#hl-0-161>161</a>
</span><span class=lnt id=hl-0-162><a class=lnlinks href=#hl-0-162>162</a>
</span><span class=lnt id=hl-0-163><a class=lnlinks href=#hl-0-163>163</a>
</span><span class=lnt id=hl-0-164><a class=lnlinks href=#hl-0-164>164</a>
</span><span class=lnt id=hl-0-165><a class=lnlinks href=#hl-0-165>165</a>
</span><span class=lnt id=hl-0-166><a class=lnlinks href=#hl-0-166>166</a>
</span><span class=lnt id=hl-0-167><a class=lnlinks href=#hl-0-167>167</a>
</span><span class=lnt id=hl-0-168><a class=lnlinks href=#hl-0-168>168</a>
</span><span class=lnt id=hl-0-169><a class=lnlinks href=#hl-0-169>169</a>
</span><span class=lnt id=hl-0-170><a class=lnlinks href=#hl-0-170>170</a>
</span><span class=lnt id=hl-0-171><a class=lnlinks href=#hl-0-171>171</a>
</span><span class=lnt id=hl-0-172><a class=lnlinks href=#hl-0-172>172</a>
</span><span class=lnt id=hl-0-173><a class=lnlinks href=#hl-0-173>173</a>
</span><span class=lnt id=hl-0-174><a class=lnlinks href=#hl-0-174>174</a>
</span><span class=lnt id=hl-0-175><a class=lnlinks href=#hl-0-175>175</a>
</span><span class=lnt id=hl-0-176><a class=lnlinks href=#hl-0-176>176</a>
</span><span class=lnt id=hl-0-177><a class=lnlinks href=#hl-0-177>177</a>
</span><span class=lnt id=hl-0-178><a class=lnlinks href=#hl-0-178>178</a>
</span><span class=lnt id=hl-0-179><a class=lnlinks href=#hl-0-179>179</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>int RtmpSessionHandle(int iFd, int iEvent, void *pContext)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    int iRet;
</span></span><span class=line><span class=cl>    RTMP_SESSION *pSession = (RTMP_SESSION *)pContext;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    if(iEvent&amp;EPOLLIN )
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        if(0 == pSession-&gt;handshake)
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl>            iRet = RtmpSessionHandshake(pSession);      
</span></span><span class=line><span class=cl>            if(0 != iRet)
</span></span><span class=line><span class=cl>            {
</span></span><span class=line><span class=cl>                RtmpSessionHandleFin(pSession); 
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        else
</span></span><span class=line><span class=cl>        {   
</span></span><span class=line><span class=cl>            iRet =  RtmpPktHandle(pSession);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if(iEvent &amp; (EPOLLERR |EPOLLHUP) )
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        RtmpSessionHandleFin(pSession);
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    return iRet;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int ListenHandle(int iFd, int iEvent, void *pContext)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    int iNewFd;
</span></span><span class=line><span class=cl>    int iRet = 0;
</span></span><span class=line><span class=cl>    struct sockaddr tmpAddr;
</span></span><span class=line><span class=cl>    memset(&amp;tmpAddr, 0, sizeof(tmpAddr));
</span></span><span class=line><span class=cl>    int iSocketSize = sizeof(tmpAddr);
</span></span><span class=line><span class=cl>    EPOLL_CTX *pCtx; 
</span></span><span class=line><span class=cl>    RTMP_SESSION *pServer;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    if(iEvent|EPOLLIN)
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        iNewFd = accept(iFd, &amp;tmpAddr, (socklen_t *)&amp;iSocketSize); 
</span></span><span class=line><span class=cl>        if(RTMP_EPOLLSRV_INVALIDFD &lt; iNewFd)    
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl>            pServer = (RTMP_SESSION *)malloc(sizeof(RTMP_SESSION));
</span></span><span class=line><span class=cl>            if(NULL == pServer)
</span></span><span class=line><span class=cl>            {
</span></span><span class=line><span class=cl>                return -1;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            pServer-&gt;handshake  = 0; 
</span></span><span class=line><span class=cl>            pCtx = (EPOLL_CTX *)malloc(sizeof(EPOLL_CTX));
</span></span><span class=line><span class=cl>            if(NULL == pCtx)
</span></span><span class=line><span class=cl>            {
</span></span><span class=line><span class=cl>                free(pServer);
</span></span><span class=line><span class=cl>                return -1;
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            pServer-&gt;socket = iNewFd;
</span></span><span class=line><span class=cl>            pCtx-&gt;iFd = iNewFd;
</span></span><span class=line><span class=cl>            pCtx-&gt;pContext = pServer;
</span></span><span class=line><span class=cl>            pCtx-&gt;pfHandle = RtmpSessionHandle;
</span></span><span class=line><span class=cl>            /* 加入epoll */
</span></span><span class=line><span class=cl>            iRet = epoll_op(g_iEpollFd, EPOLL_CTL_ADD, iNewFd,  EPOLLIN|EPOLLERR|EPOLLHUP,  pCtx);
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        else
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl>            printf(&#34;accept errno:%s&#34;,strerror(errno));
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return iRet;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int epoll_op(int iEpollFd, int iOp, int iFd, int iEvent,  EPOLL_CTX *pCtx)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    int iRet;
</span></span><span class=line><span class=cl>    struct epoll_event ev;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ev.events = iEvent;
</span></span><span class=line><span class=cl>    ev.data.ptr = pCtx;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    iRet = epoll_ctl(iEpollFd, iOp, iFd, &amp;ev);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return iRet;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int epoll_loop(int iEpollFd)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    int iNum;
</span></span><span class=line><span class=cl>    struct epoll_event astEpEvent[RTMP_EPOLLSRV_MAXEPOLL];
</span></span><span class=line><span class=cl>    int i;
</span></span><span class=line><span class=cl>    EpollCallBack_PF pfHandle;
</span></span><span class=line><span class=cl>    EPOLL_CTX *pCtx;
</span></span><span class=line><span class=cl>    for( ;  ;)
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        iNum= epoll_wait(iEpollFd, &amp;astEpEvent[0],  RTMP_EPOLLSRV_MAXEPOLL, -1);
</span></span><span class=line><span class=cl>        if( 0 &lt; iNum)
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl>            for(i = 0; i &lt; iNum; i++)
</span></span><span class=line><span class=cl>            {
</span></span><span class=line><span class=cl>                pCtx = (EPOLL_CTX *)astEpEvent[i].data.ptr;
</span></span><span class=line><span class=cl>                pfHandle = pCtx-&gt;pfHandle;
</span></span><span class=line><span class=cl>                (void)pfHandle(pCtx-&gt;iFd, astEpEvent[i].events, pCtx-&gt;pContext);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        else
</span></span><span class=line><span class=cl>        {
</span></span><span class=line><span class=cl>            printf(&#34;epoll_wait failed\r\n&#34;);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return 0;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>int main(void)
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    int iFd;
</span></span><span class=line><span class=cl>    struct sockaddr_in addr;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    printf(&#34;in the main\r\n&#34;);
</span></span><span class=line><span class=cl>    /* 初始化epoll */
</span></span><span class=line><span class=cl>    g_iEpollFd = epoll_create(200);
</span></span><span class=line><span class=cl>    if(RTMP_EPOLLSRV_INVALIDFD &gt;= g_iEpollFd)
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        printf(&#34;create epoll failed\r\n&#34;);
</span></span><span class=line><span class=cl>        return  -1;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    /* 创建侦听端口 */
</span></span><span class=line><span class=cl>    iFd = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span></span><span class=line><span class=cl>    if(RTMP_EPOLLSRV_INVALIDFD &gt;= iFd)
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        printf(&#34;create listen socket failed\r\n&#34;);
</span></span><span class=line><span class=cl>        return  -1;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    addr.sin_family = AF_INET;
</span></span><span class=line><span class=cl>    addr.sin_addr.s_addr = inet_addr(g_cRtmpSrvAddr);
</span></span><span class=line><span class=cl>    addr.sin_port = htons(g_usRtmpSrvPort);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if( 0 != bind(iFd, (struct sockaddr *) &amp;addr, sizeof(struct sockaddr_in)))
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        return  -1;  
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if( 0 != listen(iFd, 200))
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        return  -1;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    EPOLL_CTX *pEpollCtx = (EPOLL_CTX *)malloc(sizeof(EPOLL_CTX));
</span></span><span class=line><span class=cl>    if(NULL == pEpollCtx)
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        return -1;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    pEpollCtx-&gt;iFd = iFd;
</span></span><span class=line><span class=cl>    pEpollCtx-&gt;pfHandle = ListenHandle;
</span></span><span class=line><span class=cl>    pEpollCtx-&gt;pContext = NULL;
</span></span><span class=line><span class=cl>    /* 加入epoll */
</span></span><span class=line><span class=cl>    if(0 != epoll_op(g_iEpollFd, EPOLL_CTL_ADD, iFd, EPOLLIN|EPOLLERR|EPOLLHUP, pEpollCtx))
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        return -1;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    g_iListenFd = iFd;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    epoll_loop(g_iEpollFd);
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    return  0;
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=功能>功能<a hidden class=anchor aria-hidden=true href=#功能>#</a></h3><p>上述代码代码主要通过epoll实现一个最基本的网络服务器（侦听一个端口，处理这个端口上连接）</p><p>几个重要数据结构</p><h3 id=实现分析>实现分析<a hidden class=anchor aria-hidden=true href=#实现分析>#</a></h3><p>简单说明如下：</p><p>用下面的结构体EPOLL_CTX保存epoll的回调及异步处理的上下文</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4>4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5>5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>typedef struct 
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    int iFd; 
</span></span><span class=line><span class=cl>    EpollCallBack_PF pfHandle;
</span></span><span class=line><span class=cl>    void  *pContext;
</span></span><span class=line><span class=cl>}EPOLL_CTX;
</span></span></code></pre></td></tr></table></div></div><p>从面向过程编程角度简单梳理一下epoll相关的代码</p><ol><li>创建epoll</li><li>加入epoll</li><li>进入epoll_loop,处理epoll事件</li></ol><h2 id=go-编程示例>go 编程示例<a hidden class=anchor aria-hidden=true href=#go-编程示例>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span><span class=lnt id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a>
</span><span class=lnt id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a>
</span><span class=lnt id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a>
</span><span class=lnt id=hl-2-14><a class=lnlinks href=#hl-2-14>14</a>
</span><span class=lnt id=hl-2-15><a class=lnlinks href=#hl-2-15>15</a>
</span><span class=lnt id=hl-2-16><a class=lnlinks href=#hl-2-16>16</a>
</span><span class=lnt id=hl-2-17><a class=lnlinks href=#hl-2-17>17</a>
</span><span class=lnt id=hl-2-18><a class=lnlinks href=#hl-2-18>18</a>
</span><span class=lnt id=hl-2-19><a class=lnlinks href=#hl-2-19>19</a>
</span><span class=lnt id=hl-2-20><a class=lnlinks href=#hl-2-20>20</a>
</span><span class=lnt id=hl-2-21><a class=lnlinks href=#hl-2-21>21</a>
</span><span class=lnt id=hl-2-22><a class=lnlinks href=#hl-2-22>22</a>
</span><span class=lnt id=hl-2-23><a class=lnlinks href=#hl-2-23>23</a>
</span><span class=lnt id=hl-2-24><a class=lnlinks href=#hl-2-24>24</a>
</span><span class=lnt id=hl-2-25><a class=lnlinks href=#hl-2-25>25</a>
</span><span class=lnt id=hl-2-26><a class=lnlinks href=#hl-2-26>26</a>
</span><span class=lnt id=hl-2-27><a class=lnlinks href=#hl-2-27>27</a>
</span><span class=lnt id=hl-2-28><a class=lnlinks href=#hl-2-28>28</a>
</span><span class=lnt id=hl-2-29><a class=lnlinks href=#hl-2-29>29</a>
</span><span class=lnt id=hl-2-30><a class=lnlinks href=#hl-2-30>30</a>
</span><span class=lnt id=hl-2-31><a class=lnlinks href=#hl-2-31>31</a>
</span><span class=lnt id=hl-2-32><a class=lnlinks href=#hl-2-32>32</a>
</span><span class=lnt id=hl-2-33><a class=lnlinks href=#hl-2-33>33</a>
</span><span class=lnt id=hl-2-34><a class=lnlinks href=#hl-2-34>34</a>
</span><span class=lnt id=hl-2-35><a class=lnlinks href=#hl-2-35>35</a>
</span><span class=lnt id=hl-2-36><a class=lnlinks href=#hl-2-36>36</a>
</span><span class=lnt id=hl-2-37><a class=lnlinks href=#hl-2-37>37</a>
</span><span class=lnt id=hl-2-38><a class=lnlinks href=#hl-2-38>38</a>
</span><span class=lnt id=hl-2-39><a class=lnlinks href=#hl-2-39>39</a>
</span><span class=lnt id=hl-2-40><a class=lnlinks href=#hl-2-40>40</a>
</span><span class=lnt id=hl-2-41><a class=lnlinks href=#hl-2-41>41</a>
</span><span class=lnt id=hl-2-42><a class=lnlinks href=#hl-2-42>42</a>
</span><span class=lnt id=hl-2-43><a class=lnlinks href=#hl-2-43>43</a>
</span><span class=lnt id=hl-2-44><a class=lnlinks href=#hl-2-44>44</a>
</span><span class=lnt id=hl-2-45><a class=lnlinks href=#hl-2-45>45</a>
</span><span class=lnt id=hl-2-46><a class=lnlinks href=#hl-2-46>46</a>
</span><span class=lnt id=hl-2-47><a class=lnlinks href=#hl-2-47>47</a>
</span><span class=lnt id=hl-2-48><a class=lnlinks href=#hl-2-48>48</a>
</span><span class=lnt id=hl-2-49><a class=lnlinks href=#hl-2-49>49</a>
</span><span class=lnt id=hl-2-50><a class=lnlinks href=#hl-2-50>50</a>
</span><span class=lnt id=hl-2-51><a class=lnlinks href=#hl-2-51>51</a>
</span><span class=lnt id=hl-2-52><a class=lnlinks href=#hl-2-52>52</a>
</span><span class=lnt id=hl-2-53><a class=lnlinks href=#hl-2-53>53</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>CONN_HOST</span> <span class=p>=</span> <span class=s>&#34;localhost&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>CONN_PORT</span> <span class=p>=</span> <span class=s>&#34;3333&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>CONN_TYPE</span> <span class=p>=</span> <span class=s>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Listen for incoming connections.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>l</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=nx>CONN_TYPE</span><span class=p>,</span> <span class=nx>CONN_HOST</span><span class=o>+</span><span class=s>&#34;:&#34;</span><span class=o>+</span><span class=nx>CONN_PORT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Error listening:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Close the listener when the application closes.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>defer</span> <span class=nx>l</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Listening on &#34;</span> <span class=o>+</span> <span class=nx>CONN_HOST</span> <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=nx>CONN_PORT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Listen for an incoming connection.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>Accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Error accepting: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Handle connections in a new goroutine.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>go</span> <span class=nf>handleRequest</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Handles incoming requests.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>handleRequest</span><span class=p>(</span><span class=nx>conn</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Make a buffer to hold incoming data.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>buf</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Read the incoming connection into the buffer.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>reqLen</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Error reading:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;recv:%s, len=%d\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>buf</span><span class=p>),</span> <span class=nx>reqLen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Send a response back to person contacting us.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>conn</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;Message received.&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Close the connection when you&#39;re done with it.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=对比>对比<a hidden class=anchor aria-hidden=true href=#对比>#</a></h2><ol><li>handleRequest代码对应c语言版本epoll回调，但是这个代码与业务逻辑很搭，读取报文，进行处理，返回结果这些操作可以同一个函数内（也就是同一个逻辑上面）实现，没有异步回调就是爽啊</li><li>go语言上编程上不需要看到epoll，也就没添加/删除epoll的操作</li><li>编程模型方面无论是原生的回调还是reactor模型，go语言更符合业务的逻辑，而不需要考虑epoll相关处理</li><li>够简洁明了，有着与c语言相当的性能，程序员们让我们一起go吧！</li></ol><h2 id=go-net实现分析>Go Net实现分析<a hidden class=anchor aria-hidden=true href=#go-net实现分析>#</a></h2><p>通过以上对比，显而易见，go语言保证效率的情况，在易用性大大超过了c，那golang是如何实现的？下面具体分析golang的net库实现</p><h3 id=goroutine调度时机>goroutine调度时机<a hidden class=anchor aria-hidden=true href=#goroutine调度时机>#</a></h3><p>一般在以下四种情况下进行goroutine调度：</p><ol><li>channel收发</li><li>显示调用go函数</li><li>阻塞的系统调用，如read,write</li><li>GC</li></ol><h3 id=epoll使用>epoll使用<a hidden class=anchor aria-hidden=true href=#epoll使用>#</a></h3><p>先简单看一下各个epoll操作代码实现，先找到他们，再分析如何利用这些操作来完成简洁的网络编程</p><h4 id=epoll初始化>epoll初始化<a hidden class=anchor aria-hidden=true href=#epoll初始化>#</a></h4><p>对应c语言版本的epoll_create，go语言版本在初始化在下面的代码中完成:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func netpollinit() {
</span></span><span class=line><span class=cl>    epfd = epollcreate1(_EPOLL_CLOEXEC)
</span></span><span class=line><span class=cl>    if epfd &gt;= 0 {
</span></span><span class=line><span class=cl>        return
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    epfd = epollcreate(1024)
</span></span><span class=line><span class=cl>    if epfd &gt;= 0 {
</span></span><span class=line><span class=cl>        closeonexec(epfd)
</span></span><span class=line><span class=cl>        return
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    println(&#34;netpollinit: failed to create epoll descriptor&#34;, -epfd)
</span></span><span class=line><span class=cl>    throw(&#34;netpollinit: failed to create descriptor&#34;)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h4 id=将fd加入epoll>将fd加入epoll<a hidden class=anchor aria-hidden=true href=#将fd加入epoll>#</a></h4><p>对应c语言版本的epoll_op，go语言版本在初始化在下面的代码中完成:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2>2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3>3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4>4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5>5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func netpollopen(fd uintptr, pd *pollDesc) int32 {
</span></span><span class=line><span class=cl>    var ev epollevent
</span></span><span class=line><span class=cl>    ev.events = _EPOLLIN | _EPOLLOUT | _EPOLLRDHUP | _EPOLLET
</span></span><span class=line><span class=cl>    *(**pollDesc)(unsafe.Pointer(&amp;ev.data)) = pd
</span></span><span class=line><span class=cl>    return -epollctl(epfd, _EPOLL_CTL_ADD, int32(fd), &amp;ev)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>注意这里采用的边沿触发</p><h4 id=从epoll摘除fd>从epoll摘除fd<a hidden class=anchor aria-hidden=true href=#从epoll摘除fd>#</a></h4><p>对应c语言版本的epoll_op，go语言版本在初始化在下面的代码中完成:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2>2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3>3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func netpollclose(fd uintptr) int32 {
</span></span><span class=line><span class=cl>    var ev epollevent
</span></span><span class=line><span class=cl>    return -epollctl(epfd, _EPOLL_CTL_DEL, int32(fd), &amp;ev)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h4 id=数据结构-polldesc>数据结构 pollDesc<a hidden class=anchor aria-hidden=true href=#数据结构-polldesc>#</a></h4><p>结构体pollDesc用于关联fd与epoll，具体结构如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a class=lnlinks href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a class=lnlinks href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a class=lnlinks href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a class=lnlinks href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a class=lnlinks href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a class=lnlinks href=#hl-6-29>29</a>
</span><span class=lnt id=hl-6-30><a class=lnlinks href=#hl-6-30>30</a>
</span><span class=lnt id=hl-6-31><a class=lnlinks href=#hl-6-31>31</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// Network poller descriptor.
</span></span><span class=line><span class=cl>// 每个添加到epoll中的fd都对应了一个PollDesc结构实例
</span></span><span class=line><span class=cl>type pollDesc struct {
</span></span><span class=line><span class=cl>    // 指向下一个pollDesc
</span></span><span class=line><span class=cl>    link *pollDesc // in pollcache, protected by pollcache.lock
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // The lock protects pollOpen, pollSetDeadline, pollUnblock and deadlineimpl operations.
</span></span><span class=line><span class=cl>    // This fully covers seq, rt and wt variables. fd is constant throughout the PollDesc lifetime.
</span></span><span class=line><span class=cl>    // pollReset, pollWait, pollWaitCanceled and runtime·netpollready (IO readiness notification)
</span></span><span class=line><span class=cl>    // proceed w/o taking the lock. So closing, rg, rd, wg and wd are manipulated
</span></span><span class=line><span class=cl>    // in a lock-free way by all operations.
</span></span><span class=line><span class=cl>    // NOTE(dvyukov): the following code uses uintptr to store *g (rg/wg),
</span></span><span class=line><span class=cl>    // that will blow up when GC starts moving objects.
</span></span><span class=line><span class=cl>    lock mutex // protects the following fields
</span></span><span class=line><span class=cl>    // 系统为socket分配的fd
</span></span><span class=line><span class=cl>    fd      uintptr
</span></span><span class=line><span class=cl>    closing bool // 是否关闭
</span></span><span class=line><span class=cl>    // 用于保护旧定时器和就绪的通知
</span></span><span class=line><span class=cl>    seq uintptr // protects from stale timers and ready notifications
</span></span><span class=line><span class=cl>    // 网络io读状态，分为三种: 网络io就绪， 进入等待状态， 等待状态，此时rg保存等待goroutine实例的指针
</span></span><span class=line><span class=cl>    rg uintptr // pdReady, pdWait, G waiting for read or nil
</span></span><span class=line><span class=cl>    rt timer   // read deadline timer (set if rt.f != nil)
</span></span><span class=line><span class=cl>    // 读超时时间，单位为ns
</span></span><span class=line><span class=cl>    rd int64 // read deadline
</span></span><span class=line><span class=cl>    // 网络io写状态，分为三种: 网络io就绪， 进入等待状态， 等待状态，此时rg保存等待goroutine实例的指针
</span></span><span class=line><span class=cl>    wg uintptr // pdReady, pdWait, G waiting for write or nil
</span></span><span class=line><span class=cl>    // 写超时时间，单位为ns
</span></span><span class=line><span class=cl>    wt   timer  // write deadline timer
</span></span><span class=line><span class=cl>    wd   int64  // write deadline
</span></span><span class=line><span class=cl>    user uint32 // user settable cookie
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h4 id=epoll操作封装>epoll操作封装<a hidden class=anchor aria-hidden=true href=#epoll操作封装>#</a></h4><p>以初始化epoll及加入epoll为例，在下面的函数中完成的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1> 1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2> 2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3> 3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4> 4</a>
</span><span class=lnt id=hl-7-5><a class=lnlinks href=#hl-7-5> 5</a>
</span><span class=lnt id=hl-7-6><a class=lnlinks href=#hl-7-6> 6</a>
</span><span class=lnt id=hl-7-7><a class=lnlinks href=#hl-7-7> 7</a>
</span><span class=lnt id=hl-7-8><a class=lnlinks href=#hl-7-8> 8</a>
</span><span class=lnt id=hl-7-9><a class=lnlinks href=#hl-7-9> 9</a>
</span><span class=lnt id=hl-7-10><a class=lnlinks href=#hl-7-10>10</a>
</span><span class=lnt id=hl-7-11><a class=lnlinks href=#hl-7-11>11</a>
</span><span class=lnt id=hl-7-12><a class=lnlinks href=#hl-7-12>12</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>var serverInit sync.Once
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func (pd *pollDesc) init(fd *netFD) error {
</span></span><span class=line><span class=cl>    serverInit.Do(runtime_pollServerInit)
</span></span><span class=line><span class=cl>    ctx, errno := runtime_pollOpen(uintptr(fd.sysfd))
</span></span><span class=line><span class=cl>    if errno != 0 {
</span></span><span class=line><span class=cl>        return syscall.Errno(errno)
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    pd.runtimeCtx = ctx
</span></span><span class=line><span class=cl>    return nil
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span><span class=lnt id=hl-8-15><a class=lnlinks href=#hl-8-15>15</a>
</span><span class=lnt id=hl-8-16><a class=lnlinks href=#hl-8-16>16</a>
</span><span class=lnt id=hl-8-17><a class=lnlinks href=#hl-8-17>17</a>
</span><span class=lnt id=hl-8-18><a class=lnlinks href=#hl-8-18>18</a>
</span><span class=lnt id=hl-8-19><a class=lnlinks href=#hl-8-19>19</a>
</span><span class=lnt id=hl-8-20><a class=lnlinks href=#hl-8-20>20</a>
</span><span class=lnt id=hl-8-21><a class=lnlinks href=#hl-8-21>21</a>
</span><span class=lnt id=hl-8-22><a class=lnlinks href=#hl-8-22>22</a>
</span><span class=lnt id=hl-8-23><a class=lnlinks href=#hl-8-23>23</a>
</span><span class=lnt id=hl-8-24><a class=lnlinks href=#hl-8-24>24</a>
</span><span class=lnt id=hl-8-25><a class=lnlinks href=#hl-8-25>25</a>
</span><span class=lnt id=hl-8-26><a class=lnlinks href=#hl-8-26>26</a>
</span><span class=lnt id=hl-8-27><a class=lnlinks href=#hl-8-27>27</a>
</span><span class=lnt id=hl-8-28><a class=lnlinks href=#hl-8-28>28</a>
</span><span class=lnt id=hl-8-29><a class=lnlinks href=#hl-8-29>29</a>
</span><span class=lnt id=hl-8-30><a class=lnlinks href=#hl-8-30>30</a>
</span><span class=lnt id=hl-8-31><a class=lnlinks href=#hl-8-31>31</a>
</span><span class=lnt id=hl-8-32><a class=lnlinks href=#hl-8-32>32</a>
</span><span class=lnt id=hl-8-33><a class=lnlinks href=#hl-8-33>33</a>
</span><span class=lnt id=hl-8-34><a class=lnlinks href=#hl-8-34>34</a>
</span><span class=lnt id=hl-8-35><a class=lnlinks href=#hl-8-35>35</a>
</span><span class=lnt id=hl-8-36><a class=lnlinks href=#hl-8-36>36</a>
</span><span class=lnt id=hl-8-37><a class=lnlinks href=#hl-8-37>37</a>
</span><span class=lnt id=hl-8-38><a class=lnlinks href=#hl-8-38>38</a>
</span><span class=lnt id=hl-8-39><a class=lnlinks href=#hl-8-39>39</a>
</span><span class=lnt id=hl-8-40><a class=lnlinks href=#hl-8-40>40</a>
</span><span class=lnt id=hl-8-41><a class=lnlinks href=#hl-8-41>41</a>
</span><span class=lnt id=hl-8-42><a class=lnlinks href=#hl-8-42>42</a>
</span><span class=lnt id=hl-8-43><a class=lnlinks href=#hl-8-43>43</a>
</span><span class=lnt id=hl-8-44><a class=lnlinks href=#hl-8-44>44</a>
</span><span class=lnt id=hl-8-45><a class=lnlinks href=#hl-8-45>45</a>
</span><span class=lnt id=hl-8-46><a class=lnlinks href=#hl-8-46>46</a>
</span><span class=lnt id=hl-8-47><a class=lnlinks href=#hl-8-47>47</a>
</span><span class=lnt id=hl-8-48><a class=lnlinks href=#hl-8-48>48</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (fd *netFD) accept() (netfd *netFD, err error) {
</span></span><span class=line><span class=cl>    if err := fd.readLock(); err != nil {
</span></span><span class=line><span class=cl>        return nil, err
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    defer fd.readUnlock()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    var s int
</span></span><span class=line><span class=cl>    var rsa syscall.Sockaddr
</span></span><span class=line><span class=cl>    if err = fd.pd.prepareRead(); err != nil {
</span></span><span class=line><span class=cl>        return nil, err
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    for {
</span></span><span class=line><span class=cl>        s, rsa, err = accept(fd.sysfd)
</span></span><span class=line><span class=cl>        if err != nil {
</span></span><span class=line><span class=cl>            nerr, ok := err.(*os.SyscallError)
</span></span><span class=line><span class=cl>            if !ok {
</span></span><span class=line><span class=cl>                return nil, err
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            switch nerr.Err {
</span></span><span class=line><span class=cl>            case syscall.EAGAIN:
</span></span><span class=line><span class=cl>                if err = fd.pd.waitRead(); err == nil {
</span></span><span class=line><span class=cl>                    continue
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>            case syscall.ECONNABORTED:
</span></span><span class=line><span class=cl>                // This means that a socket on the
</span></span><span class=line><span class=cl>                // listen queue was closed before we
</span></span><span class=line><span class=cl>                // Accept()ed it; it&#39;s a silly error,
</span></span><span class=line><span class=cl>                // so try again.
</span></span><span class=line><span class=cl>                continue
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            return nil, err
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        break
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    if netfd, err = newFD(s, fd.family, fd.sotype, fd.net); err != nil {
</span></span><span class=line><span class=cl>        closeFunc(s)
</span></span><span class=line><span class=cl>        return nil, err
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 调用上面函数加入epoll
</span></span><span class=line><span class=cl>    if err = netfd.init(); err != nil {
</span></span><span class=line><span class=cl>        fd.Close()
</span></span><span class=line><span class=cl>        return nil, err
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    lsa, _ := syscall.Getsockname(netfd.sysfd)
</span></span><span class=line><span class=cl>    netfd.setAddr(netfd.addrFunc()(lsa), netfd.addrFunc()(rsa))
</span></span><span class=line><span class=cl>    return netfd, nil
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h4 id=读处理>读处理<a hidden class=anchor aria-hidden=true href=#读处理>#</a></h4><p>先从为Read代码开始</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a class=lnlinks href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a class=lnlinks href=#hl-9-18>18</a>
</span><span class=lnt id=hl-9-19><a class=lnlinks href=#hl-9-19>19</a>
</span><span class=lnt id=hl-9-20><a class=lnlinks href=#hl-9-20>20</a>
</span><span class=lnt id=hl-9-21><a class=lnlinks href=#hl-9-21>21</a>
</span><span class=lnt id=hl-9-22><a class=lnlinks href=#hl-9-22>22</a>
</span><span class=lnt id=hl-9-23><a class=lnlinks href=#hl-9-23>23</a>
</span><span class=lnt id=hl-9-24><a class=lnlinks href=#hl-9-24>24</a>
</span><span class=lnt id=hl-9-25><a class=lnlinks href=#hl-9-25>25</a>
</span><span class=lnt id=hl-9-26><a class=lnlinks href=#hl-9-26>26</a>
</span><span class=lnt id=hl-9-27><a class=lnlinks href=#hl-9-27>27</a>
</span><span class=lnt id=hl-9-28><a class=lnlinks href=#hl-9-28>28</a>
</span><span class=lnt id=hl-9-29><a class=lnlinks href=#hl-9-29>29</a>
</span><span class=lnt id=hl-9-30><a class=lnlinks href=#hl-9-30>30</a>
</span><span class=lnt id=hl-9-31><a class=lnlinks href=#hl-9-31>31</a>
</span><span class=lnt id=hl-9-32><a class=lnlinks href=#hl-9-32>32</a>
</span><span class=lnt id=hl-9-33><a class=lnlinks href=#hl-9-33>33</a>
</span><span class=lnt id=hl-9-34><a class=lnlinks href=#hl-9-34>34</a>
</span><span class=lnt id=hl-9-35><a class=lnlinks href=#hl-9-35>35</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func (fd *netFD) Read(p []byte) (n int, err error) {
</span></span><span class=line><span class=cl>    if err := fd.readLock(); err != nil {
</span></span><span class=line><span class=cl>        return 0, err
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    defer fd.readUnlock()
</span></span><span class=line><span class=cl>    if len(p) == 0 {
</span></span><span class=line><span class=cl>        // If the caller wanted a zero byte read, return immediately
</span></span><span class=line><span class=cl>        // without trying. (But after acquiring the readLock.) Otherwise
</span></span><span class=line><span class=cl>        // syscall.Read returns 0, nil and eofError turns that into
</span></span><span class=line><span class=cl>        // io.EOF.
</span></span><span class=line><span class=cl>        // TODO(bradfitz): make it wait for readability? (Issue 15735)
</span></span><span class=line><span class=cl>        return 0, nil
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if err := fd.pd.prepareRead(); err != nil {
</span></span><span class=line><span class=cl>        return 0, err
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    for {
</span></span><span class=line><span class=cl>        n, err = syscall.Read(fd.sysfd, p)
</span></span><span class=line><span class=cl>        if err != nil {
</span></span><span class=line><span class=cl>            n = 0
</span></span><span class=line><span class=cl>            if err == syscall.EAGAIN { // 没有可读数据，进行读等待处理
</span></span><span class=line><span class=cl>                if err = fd.pd.waitRead(); err == nil {
</span></span><span class=line><span class=cl>                    continue
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        err = fd.eofError(n, err)
</span></span><span class=line><span class=cl>        break
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    if _, ok := err.(syscall.Errno); ok {
</span></span><span class=line><span class=cl>        err = os.NewSyscallError(&#34;read&#34;, err)
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>具体分析读等待处理,跳过封装，直接分析处理代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1> 1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2> 2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3> 3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4> 4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5> 5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6> 6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7> 7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8> 8</a>
</span><span class=lnt id=hl-10-9><a class=lnlinks href=#hl-10-9> 9</a>
</span><span class=lnt id=hl-10-10><a class=lnlinks href=#hl-10-10>10</a>
</span><span class=lnt id=hl-10-11><a class=lnlinks href=#hl-10-11>11</a>
</span><span class=lnt id=hl-10-12><a class=lnlinks href=#hl-10-12>12</a>
</span><span class=lnt id=hl-10-13><a class=lnlinks href=#hl-10-13>13</a>
</span><span class=lnt id=hl-10-14><a class=lnlinks href=#hl-10-14>14</a>
</span><span class=lnt id=hl-10-15><a class=lnlinks href=#hl-10-15>15</a>
</span><span class=lnt id=hl-10-16><a class=lnlinks href=#hl-10-16>16</a>
</span><span class=lnt id=hl-10-17><a class=lnlinks href=#hl-10-17>17</a>
</span><span class=lnt id=hl-10-18><a class=lnlinks href=#hl-10-18>18</a>
</span><span class=lnt id=hl-10-19><a class=lnlinks href=#hl-10-19>19</a>
</span><span class=lnt id=hl-10-20><a class=lnlinks href=#hl-10-20>20</a>
</span><span class=lnt id=hl-10-21><a class=lnlinks href=#hl-10-21>21</a>
</span><span class=lnt id=hl-10-22><a class=lnlinks href=#hl-10-22>22</a>
</span><span class=lnt id=hl-10-23><a class=lnlinks href=#hl-10-23>23</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>//go:linkname net_runtime_pollWait net.runtime_pollWait
</span></span><span class=line><span class=cl>// 进入pollwait状态进行goroutine调度
</span></span><span class=line><span class=cl>func net_runtime_pollWait(pd *pollDesc, mode int) int {
</span></span><span class=line><span class=cl>    err := netpollcheckerr(pd, int32(mode))
</span></span><span class=line><span class=cl>    if err != 0 {
</span></span><span class=line><span class=cl>        return err
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // As for now only Solaris uses level-triggered IO.
</span></span><span class=line><span class=cl>    if GOOS == &#34;solaris&#34; {
</span></span><span class=line><span class=cl>        netpollarm(pd, mode)
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // 
</span></span><span class=line><span class=cl>    for !netpollblock(pd, int32(mode), false) {
</span></span><span class=line><span class=cl>        err = netpollcheckerr(pd, int32(mode))
</span></span><span class=line><span class=cl>        if err != 0 {
</span></span><span class=line><span class=cl>            return err
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        // Can happen if timeout has fired and unblocked us,
</span></span><span class=line><span class=cl>        // but before we had a chance to run, timeout has been reset.
</span></span><span class=line><span class=cl>        // Pretend it has not happened and retry.
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return 0
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a>
</span><span class=lnt id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a>
</span><span class=lnt id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a>
</span><span class=lnt id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a>
</span><span class=lnt id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a>
</span><span class=lnt id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a>
</span><span class=lnt id=hl-11-13><a class=lnlinks href=#hl-11-13>13</a>
</span><span class=lnt id=hl-11-14><a class=lnlinks href=#hl-11-14>14</a>
</span><span class=lnt id=hl-11-15><a class=lnlinks href=#hl-11-15>15</a>
</span><span class=lnt id=hl-11-16><a class=lnlinks href=#hl-11-16>16</a>
</span><span class=lnt id=hl-11-17><a class=lnlinks href=#hl-11-17>17</a>
</span><span class=lnt id=hl-11-18><a class=lnlinks href=#hl-11-18>18</a>
</span><span class=lnt id=hl-11-19><a class=lnlinks href=#hl-11-19>19</a>
</span><span class=lnt id=hl-11-20><a class=lnlinks href=#hl-11-20>20</a>
</span><span class=lnt id=hl-11-21><a class=lnlinks href=#hl-11-21>21</a>
</span><span class=lnt id=hl-11-22><a class=lnlinks href=#hl-11-22>22</a>
</span><span class=lnt id=hl-11-23><a class=lnlinks href=#hl-11-23>23</a>
</span><span class=lnt id=hl-11-24><a class=lnlinks href=#hl-11-24>24</a>
</span><span class=lnt id=hl-11-25><a class=lnlinks href=#hl-11-25>25</a>
</span><span class=lnt id=hl-11-26><a class=lnlinks href=#hl-11-26>26</a>
</span><span class=lnt id=hl-11-27><a class=lnlinks href=#hl-11-27>27</a>
</span><span class=lnt id=hl-11-28><a class=lnlinks href=#hl-11-28>28</a>
</span><span class=lnt id=hl-11-29><a class=lnlinks href=#hl-11-29>29</a>
</span><span class=lnt id=hl-11-30><a class=lnlinks href=#hl-11-30>30</a>
</span><span class=lnt id=hl-11-31><a class=lnlinks href=#hl-11-31>31</a>
</span><span class=lnt id=hl-11-32><a class=lnlinks href=#hl-11-32>32</a>
</span><span class=lnt id=hl-11-33><a class=lnlinks href=#hl-11-33>33</a>
</span><span class=lnt id=hl-11-34><a class=lnlinks href=#hl-11-34>34</a>
</span><span class=lnt id=hl-11-35><a class=lnlinks href=#hl-11-35>35</a>
</span><span class=lnt id=hl-11-36><a class=lnlinks href=#hl-11-36>36</a>
</span><span class=lnt id=hl-11-37><a class=lnlinks href=#hl-11-37>37</a>
</span><span class=lnt id=hl-11-38><a class=lnlinks href=#hl-11-38>38</a>
</span><span class=lnt id=hl-11-39><a class=lnlinks href=#hl-11-39>39</a>
</span><span class=lnt id=hl-11-40><a class=lnlinks href=#hl-11-40>40</a>
</span><span class=lnt id=hl-11-41><a class=lnlinks href=#hl-11-41>41</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// returns true if IO is ready, or false if timedout or closed
</span></span><span class=line><span class=cl>// waitio - wait only for completed IO, ignore errors
</span></span><span class=line><span class=cl>// 返回true表示IO就绪，返回false表示超时或者关闭
</span></span><span class=line><span class=cl>// waitio 表示是否等待IO,超时时该参数为false
</span></span><span class=line><span class=cl>func netpollblock(pd *pollDesc, mode int32, waitio bool) bool {
</span></span><span class=line><span class=cl>    // 从pd.rg取指针
</span></span><span class=line><span class=cl>    gpp := &amp;pd.rg
</span></span><span class=line><span class=cl>    if mode == &#39;w&#39; {
</span></span><span class=line><span class=cl>        gpp = &amp;pd.wg
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // set the gpp semaphore to WAIT
</span></span><span class=line><span class=cl>    for {
</span></span><span class=line><span class=cl>        old := *gpp
</span></span><span class=line><span class=cl>        if old == pdReady {
</span></span><span class=line><span class=cl>            *gpp = 0
</span></span><span class=line><span class=cl>            return true
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        if old != 0 {
</span></span><span class=line><span class=cl>            throw(&#34;netpollblock: double wait&#34;)
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        // cas 设置读状态为pdWait状态
</span></span><span class=line><span class=cl>        if atomic.Casuintptr(gpp, 0, pdWait) {
</span></span><span class=line><span class=cl>            break
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // need to recheck error states after setting gpp to WAIT
</span></span><span class=line><span class=cl>    // this is necessary because runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl
</span></span><span class=line><span class=cl>    // do the opposite: store to closing/rd/wd, membarrier, load of rg/wg
</span></span><span class=line><span class=cl>    // 因为runtime_pollUnblock runtime_pollSetDeadline/deadlineimpl 将rg/wg状态修改为closing
</span></span><span class=line><span class=cl>    if waitio || netpollcheckerr(pd, mode) == 0 {
</span></span><span class=line><span class=cl>        gopark(netpollblockcommit, unsafe.Pointer(gpp), &#34;IO wait&#34;, traceEvGoBlockNet, 5)
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // be careful to not lose concurrent READY notification
</span></span><span class=line><span class=cl>    old := atomic.Xchguintptr(gpp, 0)
</span></span><span class=line><span class=cl>    if old &gt; pdWait {
</span></span><span class=line><span class=cl>        throw(&#34;netpollblock: corrupted state&#34;)
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    return old == pdReady
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h3><ol><li>net网络库的设计的精华,良好的封装与接口,提高简单可靠的接口</li><li>充分利用goroutine机制</li><li>同步编程，异步执行，这一点其实在内核也能找到，只是调度机制不一样</li><li>多学习源码，这里面有精妙的设计，科学的框架</li><li>很多问题深入一下就到底层了</li><li>异步编程能够带来高性能，但是也是高要求，如果系统复杂，出现问题不好定位，同时代码的可读性也差</li><li>代码在满足正确性的基础上，应先追求可读性，规范性，高性能往后排</li></ol><h3 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h3><ol><li><a href=http://blog.nindalf.com/how-goroutines-work/>How Goroutines Work</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://myself659.github.io/tags/golang/>golang</a></li></ul><nav class=paginav><a class=prev href=https://myself659.github.io/post/life/%E4%BA%94%E4%B8%AA%E9%97%AE%E9%A2%98%E6%89%BE%E5%88%B0%E7%9C%9F%E6%AD%A3%E8%A6%81%E6%83%B3%E7%9A%84/><span class=title>« 上一页</span><br><span>五个问题帮你找到你真正的想要的</span></a>
<a class=next href=https://myself659.github.io/post/2016-08-20-go-channel-program-demo/><span class=title>下一页 »</span><br><span>Go channel 编程篇</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share 从C语言epoll编程到go net实现分析 on twitter" href="https://twitter.com/intent/tweet/?text=%e4%bb%8eC%e8%af%ad%e8%a8%80epoll%e7%bc%96%e7%a8%8b%e5%88%b0go%20net%e5%ae%9e%e7%8e%b0%e5%88%86%e6%9e%90&amp;url=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-09-10-from-cepoll-to-go-net%2f&amp;hashtags=golang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 从C语言epoll编程到go net实现分析 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-09-10-from-cepoll-to-go-net%2f&amp;title=%e4%bb%8eC%e8%af%ad%e8%a8%80epoll%e7%bc%96%e7%a8%8b%e5%88%b0go%20net%e5%ae%9e%e7%8e%b0%e5%88%86%e6%9e%90&amp;summary=%e4%bb%8eC%e8%af%ad%e8%a8%80epoll%e7%bc%96%e7%a8%8b%e5%88%b0go%20net%e5%ae%9e%e7%8e%b0%e5%88%86%e6%9e%90&amp;source=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-09-10-from-cepoll-to-go-net%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 从C语言epoll编程到go net实现分析 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-09-10-from-cepoll-to-go-net%2f&title=%e4%bb%8eC%e8%af%ad%e8%a8%80epoll%e7%bc%96%e7%a8%8b%e5%88%b0go%20net%e5%ae%9e%e7%8e%b0%e5%88%86%e6%9e%90"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 从C语言epoll编程到go net实现分析 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-09-10-from-cepoll-to-go-net%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 从C语言epoll编程到go net实现分析 on whatsapp" href="https://api.whatsapp.com/send?text=%e4%bb%8eC%e8%af%ad%e8%a8%80epoll%e7%bc%96%e7%a8%8b%e5%88%b0go%20net%e5%ae%9e%e7%8e%b0%e5%88%86%e6%9e%90%20-%20https%3a%2f%2fmyself659.github.io%2fpost%2f2016-09-10-from-cepoll-to-go-net%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 从C语言epoll编程到go net实现分析 on telegram" href="https://telegram.me/share/url?text=%e4%bb%8eC%e8%af%ad%e8%a8%80epoll%e7%bc%96%e7%a8%8b%e5%88%b0go%20net%e5%ae%9e%e7%8e%b0%e5%88%86%e6%9e%90&amp;url=https%3a%2f%2fmyself659.github.io%2fpost%2f2016-09-10-from-cepoll-to-go-net%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>comments</span><br></div><div id=tcomment></div><script src=https://utteranc.es/client.js repo=https://github.com/myself659/ipds-public issue-term=title theme=github-light crossorigin=anonymous async></script></div></article></main><footer class=footer><span>&copy; 2023 <a href=https://myself659.github.io/>沉风网事</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>